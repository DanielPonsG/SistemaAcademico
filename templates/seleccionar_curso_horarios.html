{% extends "index_master.html" %}
{% load static %}

{% block extra_css %}
<style>
  /* Premium Design for Schedules Page */
  .schedules-page {
    padding: 2rem;
    background-color: #f8f9fa;
    min-height: 100vh;
    font-family: 'Inter', sans-serif;
  }

  /* Header Section */
  .schedules-header {
    background: white;
    padding: 1.5rem 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .schedules-title h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .schedules-title h2 i {
    color: #6366f1; /* Indigo for schedules */
  }

  .schedules-subtitle {
    color: #64748b;
    margin: 0.5rem 0 0;
    font-size: 0.95rem;
  }

  .btn-refresh {
    background: white;
    color: #64748b;
    border: 1px solid #e2e8f0;
    padding: 0.75rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    text-decoration: none;
    width: 48px;
    height: 48px;
  }

  .btn-refresh:hover {
    background: #f8fafc;
    color: #6366f1;
    border-color: #6366f1;
    transform: rotate(180deg);
  }

  /* Stats Cards */
  .schedules-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .schedules-stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
  }

  .schedules-stat-card:hover {
    transform: translateY(-5px);
  }

  .schedules-stat-card::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 6px;
  }

  .schedules-stat-card--primary::after { background: #6366f1; }
  .schedules-stat-card--purple::after { background: #8b5cf6; }
  .schedules-stat-card--success::after { background: #10b981; }
  .schedules-stat-card--orange::after { background: #f59e0b; }

  .schedules-stat-card__icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .schedules-stat-card--primary .schedules-stat-card__icon { background: #eef2ff; color: #6366f1; }
  .schedules-stat-card--purple .schedules-stat-card__icon { background: #f5f3ff; color: #8b5cf6; }
  .schedules-stat-card--success .schedules-stat-card__icon { background: #ecfdf5; color: #10b981; }
  .schedules-stat-card--orange .schedules-stat-card__icon { background: #fffbeb; color: #f59e0b; }

  .schedules-stat-card__metric {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    line-height: 1.2;
  }

  .schedules-stat-card__label {
    color: #64748b;
    font-size: 0.875rem;
    margin: 0;
  }

  /* Search Section */
  .schedules-search-section {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
  }

  .search-input-wrapper {
    position: relative;
  }

  .search-input {
    width: 100%;
    height: 54px;
    padding: 0 1.25rem 0 3rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    background: #f8fafc;
    color: #334155;
    transition: all 0.2s;
  }

  .search-input:focus {
    border-color: #6366f1;
    background: white;
    outline: none;
    box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
    font-size: 1.1rem;
  }

  /* Course Grid */
  .courses-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
  }

  .course-card {
    background: white;
    border-radius: 16px;
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .course-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    border-color: #6366f1;
  }

  .course-card-header {
    padding: 1.5rem;
    background: linear-gradient(to bottom, #ffffff, #f8fafc);
    border-bottom: 1px solid #f1f5f9;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .level-badge {
    width: 50px;
    height: 50px;
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 800;
    font-size: 1.25rem;
    box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
    margin-right: 1rem;
  }

  .course-title {
    font-weight: 700;
    color: #1e293b;
    font-size: 1.1rem;
    line-height: 1.3;
    margin-bottom: 0.25rem;
  }

  .course-meta {
    font-size: 0.85rem;
    color: #64748b;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .course-card-body {
    padding: 1.5rem;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .progress-section {
    margin-bottom: 1.5rem;
  }

  .progress-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: #64748b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .progress-track {
    height: 8px;
    background: #f1f5f9;
    border-radius: 10px;
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    border-radius: 10px;
    transition: width 1.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stats-mini-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .stat-mini-box {
    background: #f8fafc;
    border: 1px solid #f1f5f9;
    border-radius: 12px;
    padding: 0.75rem 0.5rem;
    text-align: center;
    transition: all 0.2s;
  }

  .course-card:hover .stat-mini-box {
    background: white;
    border-color: #e2e8f0;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
  }

  .stat-mini-value {
    font-weight: 700;
    font-size: 1.1rem;
    color: #1e293b;
    line-height: 1;
    margin-bottom: 0.25rem;
  }

  .stat-mini-label {
    font-size: 0.65rem;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.03em;
  }

  .teacher-row {
    display: flex;
    align-items: center;
    padding: 0.75rem;
    background: #f8fafc;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 1px solid transparent;
    transition: all 0.2s;
  }

  .course-card:hover .teacher-row {
    background: white;
    border-color: #f1f5f9;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
  }

  .teacher-avatar {
    width: 32px;
    height: 32px;
    background: #eef2ff;
    color: #6366f1;
    border-radius: 50%;
    display: grid;
    place-items: center;
    font-size: 0.85rem;
    margin-right: 0.75rem;
  }

  .action-btn {
    width: 100%;
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
    border: none;
    padding: 0.85rem;
    border-radius: 12px;
    font-weight: 600;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: all 0.3s;
    text-decoration: none;
    box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.2);
  }

  .action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 12px -1px rgba(99, 102, 241, 0.3);
    color: white;
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
  }

  .empty-icon {
    width: 80px;
    height: 80px;
    background: #f1f5f9;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
    color: #94a3b8;
    font-size: 2rem;
  }

  @media (max-width: 768px) {
    .schedules-page { padding: 1rem; }
    .courses-grid { grid-template-columns: 1fr; }
  }
</style>
{% endblock %}

{% block content %}
<div class="right_col" role="main">
  <div class="schedules-page">

    <!-- Header -->
    <div class="schedules-header">
      <div class="schedules-title">
        <h2><i class="fa fa-calendar-alt"></i> Gestión de Horarios</h2>
        <p class="schedules-subtitle">Administra y optimiza la carga académica de cada curso</p>
      </div>
      <a href="{% url 'seleccionar_curso_horarios' %}" class="btn-refresh" title="Actualizar">
        <i class="fa fa-sync-alt"></i>
      </a>
    </div>

    <!-- Metrics -->
    <div class="schedules-stats">
      <div class="schedules-stat-card schedules-stat-card--primary">
        <div class="schedules-stat-card__icon">
          <i class="fa fa-layer-group"></i>
        </div>
        <div>
          <h3 class="schedules-stat-card__metric">{{ cursos_info|length }}</h3>
          <p class="schedules-stat-card__label">Cursos Activos</p>
        </div>
      </div>
      <div class="schedules-stat-card schedules-stat-card--purple">
        <div class="schedules-stat-card__icon">
          <i class="fa fa-calendar-check"></i>
        </div>
        <div>
          <h3 class="schedules-stat-card__metric">{{ anio_actual }}</h3>
          <p class="schedules-stat-card__label">Año Académico</p>
        </div>
      </div>
      <div class="schedules-stat-card schedules-stat-card--success">
        <div class="schedules-stat-card__icon">
          <i class="fa fa-clock"></i>
        </div>
        <div>
          <h3 class="schedules-stat-card__metric">{{ total_horarios }}</h3>
          <p class="schedules-stat-card__label">Bloques Totales</p>
        </div>
      </div>
      <div class="schedules-stat-card schedules-stat-card--orange">
        <div class="schedules-stat-card__icon">
          <i class="fa fa-book-open"></i>
        </div>
        <div>
          <h3 class="schedules-stat-card__metric">{{ total_asignaturas }}</h3>
          <p class="schedules-stat-card__label">Asignaturas</p>
        </div>
      </div>
    </div>

    <!-- Search Section -->
    <div class="schedules-search-section">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h3 style="font-size: 1.25rem; font-weight: 700; color: #1e293b; margin: 0;">Seleccionar Curso</h3>
          <p style="color: #64748b; margin: 0.25rem 0 0; font-size: 0.9rem;">Elige un curso para gestionar su horario semanal</p>
        </div>
        <div class="col-md-6 mt-3 mt-md-0">
          <div class="search-input-wrapper">
            <i class="fa fa-search search-icon"></i>
            <input type="text" id="cursoSearch" class="search-input" placeholder="Buscar por nivel o paralelo...">
          </div>
        </div>
      </div>
    </div>

    <!-- Course Grid -->
    {% if cursos_info %}
      <div class="courses-grid" id="coursesGrid">
        {% for info in cursos_info %}
          <div class="course-item" data-name="{{ info.curso.get_nivel_display }} {{ info.curso.paralelo }}">
            <div class="course-card">
              <div class="course-card-header">
                <div class="d-flex align-items-center">
                  <div class="level-badge">
                    {{ info.curso.nivel }}°
                  </div>
                  <div>
                    <h5 class="course-title">{{ info.curso.get_nivel_display }} {{ info.curso.paralelo }}</h5>
                    <div class="course-meta">
                      <i class="far fa-calendar me-1"></i> {{ info.curso.anio }}
                      {% if info.horarios_count > 0 %}
                        <span class="text-success ms-2 fw-bold" style="font-size: 0.7rem;">• Activo</span>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="dropdown">
                  <button class="btn btn-link text-muted p-0" type="button" data-toggle="dropdown">
                    <i class="fa fa-ellipsis-v"></i>
                  </button>
                  <div class="dropdown-menu dropdown-menu-right">
                    <a class="dropdown-item" href="{% url 'gestionar_horarios' info.curso.id %}">
                      <i class="fa fa-pen mr-2 text-primary"></i>Gestionar Horario
                    </a>
                    <a class="dropdown-item" href="{% url 'ver_horario_curso' %}?curso_id={{ info.curso.id }}">
                      <i class="fa fa-eye mr-2 text-info"></i>Vista Previa
                    </a>
                  </div>
                </div>
              </div>

              <div class="course-card-body">
                <!-- Progress Section -->
                <div class="progress-section">
                  <div class="progress-label">
                    <span>Completitud</span>
                    <span id="progress-text-{{ info.curso.id }}" class="text-primary">0%</span>
                  </div>
                  <div class="progress-track">
                    <div class="progress-fill" id="progress-bar-{{ info.curso.id }}" style="width: 0%"></div>
                  </div>
                  <input type="hidden" class="horarios-count" data-id="{{ info.curso.id }}" value="{{ info.horarios_count }}">
                </div>

                <!-- Stats Grid -->
                <div class="stats-mini-grid">
                  <div class="stat-mini-box">
                    <div class="stat-mini-value text-primary">{{ info.horarios_count }}</div>
                    <div class="stat-mini-label">Bloques</div>
                  </div>
                  <div class="stat-mini-box">
                    <div class="stat-mini-value text-dark">{{ info.asignaturas_count }}</div>
                    <div class="stat-mini-label">Materias</div>
                  </div>
                  <div class="stat-mini-box">
                    <div class="stat-mini-value text-success">{{ info.estudiantes_count }}</div>
                    <div class="stat-mini-label">Alumnos</div>
                  </div>
                </div>

                <!-- Teacher Info -->
                <div class="teacher-row">
                  <div class="teacher-avatar">
                    <i class="fa fa-user-tie"></i>
                  </div>
                  <div class="overflow-hidden">
                    <small class="text-muted d-block text-uppercase fw-bold" style="font-size: 0.6rem; line-height: 1;">Profesor Jefe</small>
                    <span class="text-dark fw-semibold text-truncate d-block" style="font-size: 0.85rem;">
                      {% if info.curso.profesor_jefe %}
                        {{ info.curso.profesor_jefe.get_nombre_completo }}
                      {% else %}
                        <span class="text-muted fst-italic">Sin asignar</span>
                      {% endif %}
                    </span>
                  </div>
                </div>

                <div class="mt-auto">
                  <a href="{% url 'gestionar_horarios' info.curso.id %}" class="action-btn">
                    Gestionar Horario <i class="fa fa-arrow-right"></i>
                  </a>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">
          <i class="fa fa-graduation-cap"></i>
        </div>
        <h3>No hay cursos disponibles</h3>
        <p class="text-muted">Comienza creando cursos para poder gestionar sus horarios</p>
        <a href="{% url 'agregar_curso' %}" class="btn btn-primary mt-3">
          <i class="fa fa-plus mr-2"></i>Crear Nuevo Curso
        </a>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    // Search Functionality
    const searchInput = document.getElementById('cursoSearch');
    const courseItems = document.querySelectorAll('.course-item');

    if (searchInput) {
      searchInput.addEventListener('keyup', function (e) {
        const term = e.target.value.toLowerCase();
        courseItems.forEach(item => {
          const name = item.getAttribute('data-name').toLowerCase();
          if (name.includes(term)) {
            item.style.display = 'block';
          } else {
            item.style.display = 'none';
          }
        });
      });
    }

    // Progress Bar Animation
    const counts = document.querySelectorAll('.horarios-count');
    counts.forEach(input => {
      const count = parseInt(input.value);
      const id = input.getAttribute('data-id');
      // Asumiendo 40 bloques como "completo"
      let percentage = Math.min(Math.round((count / 40) * 100), 100);

      setTimeout(() => {
        const bar = document.getElementById(`progress-bar-${id}`);
        const text = document.getElementById(`progress-text-${id}`);
        if (bar && text) {
          bar.style.width = `${percentage}%`;
          text.textContent = `${percentage}%`;

          if (percentage < 30) {
            bar.style.background = '#cbd5e1';
            text.classList.remove('text-primary');
            text.classList.add('text-muted');
          } else if (percentage >= 100) {
            bar.style.background = '#10b981';
            text.classList.remove('text-primary');
            text.classList.add('text-success');
          }
        }
      }, 300);
    });
  });
</script>
{% endblock %}
