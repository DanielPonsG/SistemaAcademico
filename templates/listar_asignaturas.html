{% extends "index_master.html" %}

{% block extra_css %}
<style>
  .assignments-screen { padding: 24px 18px 32px; background: #f1f5f9; min-height: calc(100vh - 120px); }
  .assignments-header { background: #fff; border-radius: 16px; padding: 18px 22px; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08); display: flex; align-items: flex-start; justify-content: space-between; gap: 16px; }
  .assignments-title { margin: 0; font-size: 24px; font-weight: 700; color: #0f172a; }
  .assignments-subtitle { margin: 6px 0 0; color: #475569; font-size: 14px; max-width: 520px; }
  .assignments-header .btn { border-radius: 12px; padding: 10px 18px; font-weight: 600; background: linear-gradient(135deg, #6366f1, #4338ca); border: none; color: #fff; box-shadow: 0 10px 24px rgba(99, 102, 241, 0.28); }
  .assignments-header .btn i { margin-right: 6px; }
  .assignments-alert { border: none; border-radius: 12px; padding: 14px 18px; box-shadow: 0 12px 28px rgba(15, 23, 42, 0.12); display: flex; align-items: center; gap: 10px; background: #fff; }
  .assignments-alert .alert-icon { font-size: 18px; }
  .metrics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
  .metric-card { position: relative; background: #fff; border-radius: 14px; padding: 18px 18px 16px; border: 1px solid #e2e8f0; display: flex; align-items: flex-start; gap: 12px; box-shadow: 0 6px 16px rgba(15, 23, 42, 0.06); }
  .metric-card::before { content: ""; position: absolute; top: 0; left: 0; right: 0; height: 4px; border-radius: 14px 14px 0 0; background: #6366f1; }
  .metric-icon { width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; background: rgba(99, 102, 241, 0.12); color: #4338ca; flex-shrink: 0; }
  .metric-card.metric-green::before { background: #10b981; }
  .metric-card.metric-green .metric-icon { background: rgba(16, 185, 129, 0.14); color: #047857; }
  .metric-card.metric-amber::before { background: #f59e0b; }
  .metric-card.metric-amber .metric-icon { background: rgba(251, 191, 36, 0.18); color: #b45309; }
  .metric-card.metric-purple::before { background: #a855f7; }
  .metric-card.metric-purple .metric-icon { background: rgba(168, 85, 247, 0.18); color: #6b21a8; }
  .metric-card.metric-teal::before { background: #38bdf8; }
  .metric-card.metric-teal .metric-icon { background: rgba(56, 189, 248, 0.18); color: #0369a1; }
  .metric-label { display: block; text-transform: uppercase; font-size: 11px; letter-spacing: 0.08em; color: #94a3b8; margin-bottom: 4px; }
  .metric-count { display: block; font-size: 28px; font-weight: 700; color: #0f172a; }
  .metric-note { margin: 4px 0 0; color: #64748b; font-size: 13px; }
  .surface-card { background: #fff; border-radius: 16px; box-shadow: 0 8px 22px rgba(15, 23, 42, 0.1); margin-bottom: 20px; border: 1px solid #e2e8f0; }
  .surface-card .card-heading { padding: 18px 20px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); border-radius: 16px 16px 0 0; display: flex; align-items: center; justify-content: space-between; gap: 12px; background: #fff; }
  .surface-card .card-heading h3 { margin: 0; font-size: 18px; font-weight: 700; color: #0f172a; }
  .surface-card .card-body { padding: 20px; background: #fff; border-radius: 0 0 16px 16px; }
  .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .filters-grid label { font-weight: 600; color: #1f2937; margin-bottom: 8px; display: block; }
  .filters-grid input,
  .filters-grid select { width: 100%; padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(148, 163, 184, 0.45); background: #f8fafc; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
  .filters-grid input:focus,
  .filters-grid select:focus { outline: none; border-color: rgba(37, 99, 235, 0.6); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.16); background: #fff; }
  .filter-actions { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 12px; }
  .filter-actions button { border: none; border-radius: 12px; padding: 10px 20px; font-weight: 600; background: linear-gradient(135deg, #2563eb, #1d4ed8); color: #fff; box-shadow: 0 12px 26px rgba(37, 99, 235, 0.25); }
  .filter-actions a { border-radius: 12px; padding: 10px 20px; font-weight: 600; color: #1f2937; background: rgba(15, 23, 42, 0.05); border: 1px solid rgba(148, 163, 184, 0.35); display: inline-block; }
  .table-card table { margin-bottom: 0; }
  .table-card thead { background: #f8fafc; }
  .table-card thead th { font-size: 12px; text-transform: uppercase; letter-spacing: 0.06em; color: #475569; border-bottom: 1px solid rgba(148, 163, 184, 0.35) !important; }
  .table-card tbody td { vertical-align: middle !important; color: #1f2937; }
  .table-card tbody tr:hover { background: rgba(37, 99, 235, 0.04); }
  .table-pill { display: inline-flex; align-items: center; gap: 6px; border-radius: 999px; padding: 5px 12px; font-size: 12px; font-weight: 600; margin: 0 6px 6px 0; background: rgba(148, 163, 184, 0.2); color: #334155; }
  .table-pill i { font-size: 13px; }
  .pill-success { background: rgba(22, 163, 74, 0.16); color: #166534; }
  .pill-warning { background: rgba(245, 158, 11, 0.22); color: #92400e; }
  .pill-info { background: rgba(14, 165, 233, 0.18); color: #0c4a6e; }
  .pill-muted { background: rgba(148, 163, 184, 0.25); color: #475569; }
  .description-text { color: #64748b; font-size: 13px; margin: 0; }
  .empty-state { text-align: center; padding: 48px 16px; color: #64748b; }
  .empty-state h4 { font-weight: 600; color: #1f2937; margin-bottom: 10px; }
  .empty-state i { font-size: 48px; margin-bottom: 14px; color: rgba(37, 99, 235, 0.4); }
  .course-highlight { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 16px; }
  .course-highlight h4 { margin: 0; font-weight: 700; color: #1d4ed8; }
  .course-highlight .badge { background: linear-gradient(135deg, #2563eb, #1d4ed8); border-radius: 999px; padding: 8px 16px; font-size: 12px; color: #fff; }
  .summary-card .card-body { display: flex; flex-wrap: wrap; align-items: center; gap: 16px; }
  .summary-card .summary-text { flex: 1; color: #475569; }
  .summary-card .summary-text strong { color: #0f172a; }
  .summary-card .btn { border-radius: 12px; padding: 10px 20px; }
  .quick-assign-card { border: 1px solid rgba(245, 158, 11, 0.32); border-radius: 12px; padding: 12px 14px; background: rgba(255, 251, 235, 0.85); margin-bottom: 14px; box-shadow: 0 6px 16px rgba(245, 158, 11, 0.18); }
  .quick-assign-card h5 { margin: 0 0 8px; font-weight: 600; color: #b45309; }
  .manage-pill { border: 1px solid rgba(148, 163, 184, 0.35); border-radius: 12px; padding: 10px 14px; display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 10px; background: #f8fafc; }
  .manage-pill strong { color: #0f172a; }
  .mini-text { font-size: 12px; color: #94a3b8; margin: 0; }
  @media (max-width: 992px) {
    .assignments-header { flex-direction: column; align-items: stretch; }
    .assignments-header .btn { width: 100%; text-align: center; }
  }
  @media (max-width: 768px) {
    .assignments-screen { padding: 18px 12px 28px; }
    .surface-card .card-body { padding: 18px; }
    .filters-grid { grid-template-columns: 1fr; }
    .filter-actions { justify-content: center; }
  }
</style>
{% endblock %}

{% block content %}
<div class="right_col" role="main">
  <div class="container-fluid assignments-screen">

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags|default:'info' }}{% endif %} alert-dismissible assignments-alert" role="alert">
          <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <span class="alert-icon">
            {% if message.tags == 'success' %}
              <i class="fa fa-check-circle text-success"></i>
            {% elif message.tags == 'warning' %}
              <i class="fa fa-exclamation-triangle text-warning"></i>
            {% elif message.tags == 'error' %}
              <i class="fa fa-times-circle text-danger"></i>
            {% else %}
              <i class="fa fa-info-circle text-primary"></i>
            {% endif %}
          </span>
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}

    <div class="assignments-header">
      <div>
        {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
          <h1 class="assignments-title"><i class="fa fa-book"></i> Mis asignaturas</h1>
          {% if curso_actual %}
            <p class="assignments-subtitle">Asignaturas del curso {{ curso_actual.get_nivel_display }}{{ curso_actual.paralelo }} del año {{ curso_actual.anio }}.</p>
          {% elif error_curso %}
            <p class="assignments-subtitle">Actualmente no tienes un curso asignado. Contacta a la coordinación académica.</p>
          {% else %}
            <p class="assignments-subtitle">Consulta tus asignaturas activas, profesores asignados y estado académico.</p>
          {% endif %}
        {% elif tipo_usuario == 'profesor' %}
          <h1 class="assignments-title"><i class="fa fa-chalkboard-teacher"></i> Mis asignaturas asignadas</h1>
          <p class="assignments-subtitle">Revisa los cursos a tu cargo, estudiantes asociados y el estado de cada materia.</p>
        {% else %}
          <h1 class="assignments-title"><i class="fa fa-list-alt"></i> Gestión de asignaturas</h1>
          <p class="assignments-subtitle">Administra la malla académica: asigna profesores, vincula cursos y mantén la información actualizada.</p>
        {% endif %}
      </div>
      {% if puede_editar %}
        <a href="{% url 'agregar_asignatura' %}" class="btn btn-primary">
          <i class="fa fa-plus"></i> Nueva asignatura
        </a>
      {% endif %}
    </div>

    {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
      <div class="metrics-grid">
        <div class="metric-card metric-blue">
          <div class="metric-icon"><i class="fa fa-book"></i></div>
          <div>
            <span class="metric-label">Asignaturas</span>
            <span class="metric-count">{{ total_asignaturas_curso|default:0 }}</span>
            <p class="metric-note">Registradas para tu curso</p>
          </div>
        </div>
        <div class="metric-card metric-green">
          <div class="metric-icon"><i class="fa fa-user-check"></i></div>
          <div>
            <span class="metric-label">Con profesor</span>
            <span class="metric-count">{{ asignaturas_con_profesor|default:0 }}</span>
            <p class="metric-note">Asignaturas con responsable</p>
          </div>
        </div>
        <div class="metric-card metric-amber">
          <div class="metric-icon"><i class="fa fa-hourglass-half"></i></div>
          <div>
            <span class="metric-label">Sin profesor</span>
            <span class="metric-count">{{ asignaturas_sin_profesor_count|default:0 }}</span>
            <p class="metric-note">En espera de asignación</p>
          </div>
        </div>
        <div class="metric-card metric-purple">
          <div class="metric-icon"><i class="fa fa-school"></i></div>
          <div>
            <span class="metric-label">Curso actual</span>
            <span class="metric-count">{% if curso_actual %}{{ curso_actual.get_nivel_display }}{{ curso_actual.paralelo }}{% else %}---{% endif %}</span>
            <p class="metric-note">{% if curso_actual %}Profesor jefe: {{ curso_actual.profesor_jefe.get_nombre_completo|default:"No asignado" }}{% else %}Sin curso asignado{% endif %}</p>
          </div>
        </div>
      </div>
    {% elif tipo_usuario == 'profesor' %}
      <div class="metrics-grid">
        <div class="metric-card metric-blue">
          <div class="metric-icon"><i class="fa fa-book-open"></i></div>
          <div>
            <span class="metric-label">Total asignaturas</span>
            <span class="metric-count">{{ total_asignaturas|default:0 }}</span>
            <p class="metric-note">Materias a tu cargo</p>
          </div>
        </div>
        <div class="metric-card metric-green">
          <div class="metric-icon"><i class="fa fa-chalkboard"></i></div>
          <div>
            <span class="metric-label">Cursos</span>
            <span class="metric-count">{{ total_cursos_profesor|default:0 }}</span>
            <p class="metric-note">Cursos donde impartes clases</p>
          </div>
        </div>
        <div class="metric-card metric-teal">
          <div class="metric-icon"><i class="fa fa-users"></i></div>
          <div>
            <span class="metric-label">Estudiantes</span>
            <span class="metric-count">{{ total_estudiantes_profesor|default:0 }}</span>
            <p class="metric-note">Alumnos asociados a tus cursos</p>
          </div>
        </div>
        <div class="metric-card metric-amber">
          <div class="metric-icon"><i class="fa fa-star"></i></div>
          <div>
            <span class="metric-label">Responsabilidades</span>
            <span class="metric-count">{{ asignaturas_como_responsable|default:0 }}</span>
            <p class="metric-note">Asignaturas donde eres responsable</p>
          </div>
        </div>
      </div>
    {% else %}
      <div class="metrics-grid">
        <div class="metric-card metric-blue">
          <div class="metric-icon"><i class="fa fa-layer-group"></i></div>
          <div>
            <span class="metric-label">Asignaturas</span>
            <span class="metric-count">{{ total_asignaturas|default:0 }}</span>
            <p class="metric-note">Registradas en el sistema</p>
          </div>
        </div>
        <div class="metric-card metric-green">
          <div class="metric-icon"><i class="fa fa-user-check"></i></div>
          <div>
            <span class="metric-label">Con profesor</span>
            <span class="metric-count">{{ asignaturas_con_profesor|default:0 }}</span>
            <p class="metric-note">Asignaciones confirmadas</p>
          </div>
        </div>
        <div class="metric-card metric-teal">
          <div class="metric-icon"><i class="fa fa-school"></i></div>
          <div>
            <span class="metric-label">Con cursos</span>
            <span class="metric-count">{{ asignaturas_con_cursos|default:0 }}</span>
            <p class="metric-note">Vinculadas al año vigente</p>
          </div>
        </div>
        <div class="metric-card metric-amber">
          <div class="metric-icon"><i class="fa fa-exclamation-circle"></i></div>
          <div>
            <span class="metric-label">Pendientes</span>
            <span class="metric-count">{{ asignaturas_sin_cursos|default:0 }}</span>
            <p class="metric-note">Asignaturas sin curso asignado</p>
          </div>
        </div>
      </div>
    {% endif %}

    {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
      {% if curso_actual %}
        <div class="surface-card">
          <div class="card-body">
            <div class="course-highlight">
              <div>
                <h4><i class="fa fa-graduation-cap"></i> {{ curso_actual.get_nivel_display }}{{ curso_actual.paralelo }}</h4>
                <p class="description-text">
                  Año {{ curso_actual.anio }} · Profesor jefe: {{ curso_actual.profesor_jefe.get_nombre_completo|default:"No asignado" }}
                </p>
                <p class="description-text"><i class="fa fa-info-circle"></i> Estas son todas las asignaturas activas para tu curso actual.</p>
              </div>
              <span class="badge"><i class="fa fa-book"></i> {{ total_asignaturas_curso|default:0 }} asignatura{{ total_asignaturas_curso|default:0|pluralize }}</span>
            </div>
          </div>
        </div>
      {% elif error_curso %}
        <div class="surface-card">
          <div class="card-body">
            <div class="empty-state">
              <i class="fa fa-exclamation-triangle text-warning"></i>
              <h4>Información pendiente</h4>
              <p>{{ error_curso }}</p>
            </div>
          </div>
        </div>
      {% elif error_estudiante %}
        <div class="surface-card">
          <div class="card-body">
            <div class="empty-state">
              <i class="fa fa-times-circle text-danger"></i>
              <h4>No pudimos cargar tus datos</h4>
              <p>{{ error_estudiante }}</p>
            </div>
          </div>
        </div>
      {% endif %}
    {% endif %}

    {% if puede_editar %}
      <div class="surface-card filter-card">
        <div class="card-heading">
          <h3><i class="fa fa-filter text-primary"></i> Filtros de búsqueda</h3>
        </div>
        <div class="card-body">
          <form method="get">
            <div class="filters-grid">
              <div class="form-group">
                <label for="filtro_nombre">Nombre</label>
                <input id="filtro_nombre" type="text" name="filtro_nombre" value="{{ filtro_nombre }}" placeholder="Buscar por nombre">
              </div>
              <div class="form-group">
                <label for="filtro_codigo">Código</label>
                <input id="filtro_codigo" type="text" name="filtro_codigo" value="{{ filtro_codigo }}" placeholder="Buscar por código">
              </div>
              <div class="form-group">
                <label for="filtro_profesor">Profesor</label>
                <input id="filtro_profesor" type="text" name="filtro_profesor" value="{{ filtro_profesor }}" placeholder="Nombre o código de profesor">
              </div>
              <div class="form-group">
                <label for="filtro_sin_profesor">Asignaturas sin profesor</label>
                <select id="filtro_sin_profesor" name="filtro_sin_profesor">
                  <option value="">Todas</option>
                  <option value="1" {% if filtro_sin_profesor %}selected{% endif %}>Solo sin profesor</option>
                </select>
              </div>
            </div>
            <div class="filter-actions">
              <button type="submit"><i class="fa fa-search"></i> Aplicar filtros</button>
              {% if filtro_nombre or filtro_codigo or filtro_profesor or filtro_sin_profesor %}
                <a href="{% url 'listar_asignaturas' %}"><i class="fa fa-times"></i> Limpiar</a>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    {% endif %}

    {% if tipo_usuario == 'profesor' and asignaturas %}
      <div class="surface-card summary-card">
        <div class="card-body">
          <div class="summary-text">
            <h4><i class="fa fa-clipboard-check text-success"></i> Resumen de responsabilidades</h4>
            <p>
              Gestionas <strong>{{ total_asignaturas|default:0 }} asignatura{{ total_asignaturas|default:0|pluralize }}</strong>
              distribuidas en <strong>{{ total_cursos_profesor|default:0 }} curso{{ total_cursos_profesor|default:0|pluralize }}</strong>
              con <strong>{{ total_estudiantes_profesor|default:0 }} estudiante{{ total_estudiantes_profesor|default:0|pluralize }}</strong> asociados.
            </p>
            <p class="mini-text"><i class="fa fa-info-circle"></i> Puedes revisar el detalle de horarios desde la sección "Mis horarios".</p>
          </div>
          <a href="{% url 'mis_horarios' %}" class="btn btn-success">
            <i class="fa fa-calendar"></i> Ver mis horarios
          </a>
        </div>
      </div>
    {% endif %}

    <div class="surface-card table-card">
      <div class="card-heading">
        <h3>
          {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
            <i class="fa fa-book text-primary"></i> Mis asignaturas
          {% elif tipo_usuario == 'profesor' %}
            <i class="fa fa-chalkboard text-primary"></i> Asignaturas a mi cargo
          {% else %}
            <i class="fa fa-list text-primary"></i> Asignaturas registradas
          {% endif %}
        </h3>
        {% if asignaturas %}
          <span class="mini-text">{{ asignaturas|length }} resultado{{ asignaturas|length|pluralize }}</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if asignaturas %}
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
                    <th>Asignatura</th>
                    <th>Profesor responsable</th>
                    <th>Descripción</th>
                    <th>Estado</th>
                  {% elif tipo_usuario == 'profesor' %}
                    <th>Asignatura</th>
                    <th>Cursos asignados</th>
                    <th>Estudiantes</th>
                    <th>Descripción</th>
                  {% else %}
                    <th>Código</th>
                    <th>Asignatura</th>
                    <th>Profesor</th>
                    <th>Cursos</th>
                    <th>Descripción</th>
                    {% if puede_editar %}<th class="text-right">Acciones</th>{% endif %}
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for asignatura in asignaturas %}
                  <tr>
                    {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
                      <td>
                        <strong>{{ asignatura.nombre }}</strong><br>
                        {% if asignatura.codigo_asignatura %}
                          <span class="table-pill pill-muted"><i class="fa fa-tag"></i> {{ asignatura.codigo_asignatura }}</span>
                        {% else %}
                          <span class="table-pill pill-muted"><i class="fa fa-info-circle"></i> Sin código</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if asignatura.profesor_responsable %}
                          <span class="table-pill pill-success">
                            <i class="fa fa-user"></i> {{ asignatura.profesor_responsable.get_nombre_completo|default:asignatura.profesor_responsable.primer_nombre }}
                          </span>
                        {% else %}
                          <span class="table-pill pill-warning"><i class="fa fa-user-times"></i> En asignación</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if asignatura.descripcion %}
                          <p class="description-text">{{ asignatura.descripcion|truncatechars:90 }}</p>
                        {% else %}
                          <span class="description-text"><em>Sin descripción disponible</em></span>
                        {% endif %}
                      </td>
                      <td>
                        {% if asignatura.profesor_responsable %}
                          <span class="table-pill pill-success"><i class="fa fa-check-circle"></i> Activa</span>
                        {% else %}
                          <span class="table-pill pill-warning"><i class="fa fa-clock-o"></i> Pendiente</span>
                        {% endif %}
                      </td>
                    {% elif tipo_usuario == 'profesor' %}
                      <td>
                        <strong>{{ asignatura.nombre }}</strong><br>
                        <span class="table-pill pill-muted"><i class="fa fa-tag"></i> {{ asignatura.codigo_asignatura|default:"Sin código" }}</span>
                      </td>
                      <td>
                        {% with cursos=asignatura.get_cursos_asignados %}
                          {% if cursos %}
                            {% for curso in cursos %}
                              <span class="table-pill pill-info">
                                <i class="fa fa-school"></i> {{ curso.get_nivel_display }}{{ curso.paralelo }} ({{ curso.anio }})
                              </span>
                            {% endfor %}
                          {% else %}
                            <span class="table-pill pill-warning"><i class="fa fa-exclamation-circle"></i> Sin cursos</span>
                          {% endif %}
                        {% endwith %}
                      </td>
                      <td>
                        {% with total=asignatura.get_total_estudiantes %}
                          <span class="table-pill pill-success"><i class="fa fa-users"></i> {{ total }} estudiante{{ total|pluralize }}</span>
                        {% endwith %}
                      </td>
                      <td>
                        {% if asignatura.descripcion %}
                          <p class="description-text">{{ asignatura.descripcion|truncatechars:100 }}</p>
                        {% else %}
                          <span class="description-text"><em>Sin descripción disponible</em></span>
                        {% endif %}
                      </td>
                    {% else %}
                      <td><span class="table-pill pill-muted"><i class="fa fa-barcode"></i> {{ asignatura.codigo_asignatura }}</span></td>
                      <td><strong>{{ asignatura.nombre }}</strong></td>
                      <td>
                        {% if asignatura.profesor_responsable %}
                          <span class="table-pill pill-success" data-profesor-id="{{ asignatura.profesor_responsable.id }}">
                            <i class="fa fa-user"></i> {{ asignatura.profesor_responsable.get_nombre_completo }}
                          </span>
                        {% else %}
                          <span class="table-pill pill-warning"><i class="fa fa-user-times"></i> Sin profesor</span>
                        {% endif %}
                      </td>
                      <td>
                        {% with cursos=asignatura.get_cursos_asignados %}
                          {% if cursos %}
                            {% for curso in cursos %}
                              <span class="table-pill pill-info" title="{{ curso.get_nivel_display }}{{ curso.paralelo }} ({{ curso.anio }})">
                                <i class="fa fa-school"></i> {{ curso.get_nivel_display }}{{ curso.paralelo }}
                              </span>
                            {% endfor %}
                            <p class="mini-text">{{ cursos.count }} curso{{ cursos.count|pluralize }} asignado{{ cursos.count|pluralize }}</p>
                          {% else %}
                            <span class="table-pill pill-warning"><i class="fa fa-exclamation-circle"></i> Sin cursos</span>
                          {% endif %}
                        {% endwith %}
                      </td>
                      <td>
                        {% if asignatura.descripcion %}
                          <p class="description-text">{{ asignatura.descripcion|truncatechars:80 }}</p>
                        {% else %}
                          <span class="description-text"><em>Sin descripción</em></span>
                        {% endif %}
                      </td>
                      {% if puede_editar %}
                        <td class="text-right">
                          <div class="btn-group btn-group-sm">
                            <a href="{% url 'editar_asignatura' asignatura.id %}" class="btn btn-default" title="Editar asignatura">
                              <i class="fa fa-edit"></i>
                            </a>
                            <button type="button"
                                    class="btn btn-default"
                                    title="Gestionar profesor"
                                    data-asignatura-id="{{ asignatura.id }}"
                                    data-asignatura-nombre="{{ asignatura.nombre|escape }}"
                                    data-profesor-id="{% if asignatura.profesor_responsable %}{{ asignatura.profesor_responsable.id }}{% endif %}"
                                    data-profesor-nombre="{% if asignatura.profesor_responsable %}{{ asignatura.profesor_responsable.get_nombre_completo|escape }}{% endif %}"
                                    onclick="gestionarProfesores(this)">
                              <i class="fa fa-users"></i>
                            </button>
                            <button type="button"
                                    class="btn btn-default"
                                    title="Gestionar cursos"
                                    data-asignatura-id="{{ asignatura.id }}"
                                    data-asignatura-nombre="{{ asignatura.nombre|escape }}"
                                    data-cursos="{% with cursos=asignatura.get_cursos_asignados %}{% for curso in cursos %}{{ curso.get_nivel_display|escape }}{{ curso.paralelo }}::{{ curso.get_nivel_display|escape }}{{ curso.paralelo }} ({{ curso.anio }}){% if not forloop.last %};;{% endif %}{% endfor %}{% endwith %}"
                                    onclick="gestionarCursos(this)">
                              <i class="fa fa-school"></i>
                            </button>
                            <button type="button"
                                    class="btn btn-danger"
                                    title="Eliminar asignatura"
                                    onclick="confirmarEliminacion('{{ asignatura.nombre|escapejs }}', '{% url 'eliminar_asignatura' asignatura.id %}')">
                              <i class="fa fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      {% endif %}
                    {% endif %}
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty-state">
            {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
              <i class="fa fa-book-open"></i>
              <h4>No encontramos asignaturas</h4>
              {% if error_curso %}
                <p>{{ error_curso }}</p>
              {% elif error_estudiante %}
                <p>{{ error_estudiante }}</p>
              {% else %}
                <p>Tu curso aún no tiene asignaturas configuradas. Te avisaremos cuando estén disponibles.</p>
              {% endif %}
            {% elif tipo_usuario == 'profesor' %}
              <i class="fa fa-chalkboard-teacher"></i>
              <h4>Sin asignaturas asignadas</h4>
              <p>No tienes materias asociadas en este momento. Contacta a dirección académica para obtener nuevas asignaciones.</p>
            {% else %}
              <i class="fa fa-layer-group"></i>
              <h4>No hay asignaturas registradas</h4>
              <p>Comienza creando una nueva asignatura para el plan de estudios.</p>
            {% endif %}
            {% if puede_editar %}
              <div style="margin-top: 18px;">
                <a class="btn btn-primary" href="{% url 'agregar_asignatura' %}"><i class="fa fa-plus"></i> Crear asignatura</a>
              </div>
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    {% if asignaturas_sin_profesor and puede_editar %}
      <div class="surface-card">
        <div class="card-heading">
          <h3><i class="fa fa-user-times text-warning"></i> Asignaturas sin profesor ({{ asignaturas_sin_profesor_count }})</h3>
          <button class="btn btn-default" type="button" data-toggle="collapse" data-target="#unassignedCollapse">
            <i class="fa fa-chevron-down"></i> Ver / ocultar
          </button>
        </div>
        <div id="unassignedCollapse" class="collapse">
          <div class="card-body">
            <div class="row">
              <div class="col-md-7">
                <div class="row">
                  {% for item in asignaturas_sin_profesor %}
                    <div class="col-sm-6">
                      <div class="quick-assign-card">
                        <h5><i class="fa fa-book"></i> {{ item.nombre }}</h5>
                        <p class="mini-text">Código: {{ item.codigo_asignatura }}</p>
                        <p class="mini-text">Cursos vinculados: {{ item.get_cursos_count }}</p>
                        <button type="button"
                                class="btn btn-warning btn-block"
                                data-asignatura-id="{{ item.id }}"
                                data-asignatura-nombre="{{ item.nombre|escape }}"
                                data-cursos="{% with cursos=item.get_cursos_asignados %}{% for curso in cursos %}{{ curso.get_nivel_display|escape }}{{ curso.paralelo }}::{{ curso.get_nivel_display|escape }}{{ curso.paralelo }} ({{ curso.anio }}){% if not forloop.last %};;{% endif %}{% endfor %}{% endwith %}"
                                onclick="gestionarProfesores(this)">
                          <i class="fa fa-user-plus"></i> Gestionar profesor
                        </button>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
              <div class="col-md-5">
                <h4><i class="fa fa-bolt text-warning"></i> Asignación rápida</h4>
                <form method="post" class="well">
                  {% csrf_token %}
                  <input type="hidden" name="asignar_profesor" value="1">
                  <div class="form-group">
                    <label for="quick_asignatura">Asignatura</label>
                    <select id="quick_asignatura" name="asignatura_id" class="form-control" required>
                      <option value="">Selecciona una asignatura</option>
                      {% for item in asignaturas_sin_profesor %}
                        <option value="{{ item.id }}">{{ item.nombre }} ({{ item.codigo_asignatura }})</option>
                      {% endfor %}
                    </select>
                  </div>
                  <div class="form-group">
                    <label for="quick_profesor">Profesor</label>
                    <select id="quick_profesor" name="profesor_id" class="form-control" required>
                      <option value="">Selecciona un profesor</option>
                      {% for profesor in profesores %}
                        <option value="{{ profesor.id }}">{{ profesor.get_nombre_completo }}</option>
                      {% endfor %}
                    </select>
                  </div>
                  <button type="submit" class="btn btn-warning btn-block"><i class="fa fa-save"></i> Asignar profesor</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}

  </div>
</div>

{% if puede_editar %}
  <div class="modal fade" id="modalGestionarProfesores" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-users text-primary"></i> Gestión de profesor</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-6">
              <h5>Profesor asignado</h5>
              <div id="profesorActualContainer">
                <p class="description-text">Selecciona una asignatura para ver su profesor actual.</p>
              </div>
            </div>
            <div class="col-sm-6">
              <h5>Asignar nuevo profesor</h5>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="asignar_profesor" value="1">
                <input type="hidden" name="asignatura_id" id="modalAsignaturaId">
                <div class="form-group">
                  <label>Asignatura</label>
                  <p class="form-control-static" id="modalAsignaturaNombre">Selecciona una asignatura desde la tabla.</p>
                </div>
                <div class="form-group">
                  <label for="modalProfesorSelect">Profesor disponible</label>
                  <select id="modalProfesorSelect" name="profesor_id" class="form-control" required>
                    <option value="">Selecciona un profesor</option>
                    {% for profesor in profesores %}
                      <option value="{{ profesor.id }}">{{ profesor.get_nombre_completo }}</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-success btn-block"><i class="fa fa-plus"></i> Asignar profesor</button>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalGestionarCursos" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-school text-info"></i> Gestión de cursos</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-6">
              <h5>Cursos asociados</h5>
              <div id="cursosActualesContainer">
                <p class="description-text">Selecciona una asignatura para revisar sus cursos asociados.</p>
              </div>
            </div>
            <div class="col-sm-6">
              <h5>Asignar a curso</h5>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="asignar_curso" value="1">
                <input type="hidden" name="asignatura_id" id="modalCursoAsignaturaId">
                <div class="form-group">
                  <label>Asignatura</label>
                  <p class="form-control-static" id="modalCursoAsignaturaNombre">Selecciona una asignatura desde la tabla.</p>
                </div>
                <div class="form-group">
                  <label for="modalCursoSelect">Curso disponible</label>
                  <select id="modalCursoSelect" name="curso_id" class="form-control" required>
                    <option value="">Selecciona un curso</option>
                    {% for curso in cursos_disponibles %}
                      <option value="{{ curso.id }}">{{ curso.get_nivel_display }}{{ curso.paralelo }} ({{ curso.anio }})</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-info btn-block"><i class="fa fa-plus"></i> Asignar a curso</button>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function($) {
      'use strict';

      function getCsrfToken() {
        return $('input[name=csrfmiddlewaretoken]').first().val();
      }

      function submitPost(payload) {
        var $form = $('<form>', { method: 'post', style: 'display:none;' });
        $form.append($('<input>', { type: 'hidden', name: 'csrfmiddlewaretoken', value: getCsrfToken() }));
        $.each(payload, function(key, value) {
          $form.append($('<input>', { type: 'hidden', name: key, value: value }));
        });
        $('body').append($form);
        $form.submit();
      }

      window.gestionarProfesores = function(button) {
        var $btn = $(button);
        var asignaturaId = $btn.data('asignaturaId');
        var asignaturaNombre = $btn.data('asignaturaNombre');
        var profesorId = $btn.data('profesorId') || '';
        var profesorNombre = $btn.data('profesorNombre') || '';

        $('#modalAsignaturaId').val(asignaturaId);
        $('#modalAsignaturaNombre').text(asignaturaNombre || 'Sin nombre registrado');
        $('#modalProfesorSelect').val('');

        var $container = $('#profesorActualContainer');
        $container.empty();

        if (profesorId) {
          var $pill = $('<div class="manage-pill"></div>');
          $pill.append('<div><strong>' + profesorNombre + '</strong><br><span class="mini-text">Profesor responsable</span></div>');
          var $removeBtn = $('<button type="button" class="btn btn-danger btn-xs"><i class="fa fa-times"></i> Remover</button>');
          $removeBtn.on('click', function() {
            if (window.confirm('¿Deseas remover al profesor ' + profesorNombre + ' de esta asignatura?')) {
              submitPost({
                remover_profesor: 1,
                asignatura_id: asignaturaId,
                profesor_id: profesorId
              });
            }
          });
          $pill.append($removeBtn);
          $container.append($pill);
        } else {
          $container.append('<p class="description-text"><em>No hay profesor asignado actualmente.</em></p>');
        }

        $('#modalGestionarProfesores').modal('show');
      };

      function parseCursos(raw) {
        if (!raw) {
          return [];
        }
        var items = String(raw).split(';;');
        var parsed = [];
        $.each(items, function(_, item) {
          if (!item) {
            return;
          }
          var parts = item.split('::');
          parsed.push({
            nombre: $.trim(parts[0] || ''),
            etiqueta: $.trim(parts[1] || parts[0] || '')
          });
        });
        return parsed;
      }

      window.gestionarCursos = function(button) {
        var $btn = $(button);
        var asignaturaId = $btn.data('asignaturaId');
        var asignaturaNombre = $btn.data('asignaturaNombre');
        var cursos = parseCursos($btn.data('cursos'));

        $('#modalCursoAsignaturaId').val(asignaturaId);
        $('#modalCursoAsignaturaNombre').text(asignaturaNombre || 'Sin nombre registrado');
        $('#modalCursoSelect').val('');

        var $container = $('#cursosActualesContainer');
        $container.empty();

        if (cursos.length) {
          $.each(cursos, function(_, curso) {
            var $pill = $('<div class="manage-pill"></div>');
            $pill.append('<div><strong>' + curso.etiqueta + '</strong><br><span class="mini-text">Curso activo</span></div>');
            var $removeBtn = $('<button type="button" class="btn btn-danger btn-xs"><i class="fa fa-times"></i> Remover</button>');
            $removeBtn.on('click', function() {
              if (window.confirm('¿Deseas desasignar la asignatura de ' + curso.etiqueta + '?')) {
                submitPost({
                  remover_curso: 1,
                  asignatura_id: asignaturaId,
                  curso_nombre: curso.nombre
                });
              }
            });
            $pill.append($removeBtn);
            $container.append($pill);
          });
        } else {
          $container.append('<p class="description-text"><em>Esta asignatura no tiene cursos asignados para el año vigente.</em></p>');
        }

        $('#modalGestionarCursos').modal('show');
      };

      window.confirmarEliminacion = function(nombreAsignatura, url) {
        if (window.confirm('¿Eliminar la asignatura "' + nombreAsignatura + '"? Esta acción no se puede deshacer.')) {
          window.location.href = url;
        }
      };
    })(jQuery);
  </script>
{% endif %}
{% endblock %}
