{% extends "index_master.html" %}
{% block content %}
<div class="right_col" role="main">
  <div class="container-fluid">
    <!-- Mensajes de éxito y error -->
    {% if messages %}
      <div class="row mb-3">
        <div class="col-12">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
              {% if message.tags == 'success' %}
                <i class="fas fa-check-circle me-2"></i>
              {% elif message.tags == 'error' %}
                <i class="fas fa-exclamation-triangle me-2"></i>
              {% elif message.tags == 'warning' %}
                <i class="fas fa-exclamation-circle me-2"></i>
              {% else %}
                <i class="fas fa-info-circle me-2"></i>
              {% endif %}
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Header -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="bg-white p-4 rounded shadow-sm border">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
                <h2 class="h3 text-dark mb-2">
                  <i class="fas fa-book-open me-2"></i>Mis Asignaturas
                </h2>
                {% if curso_actual %}
                  <p class="text-muted mb-0">Asignaturas del curso {{ curso_actual }}</p>
                {% else %}
                  <p class="text-muted mb-0">Tus asignaturas académicas</p>
                {% endif %}
              {% elif tipo_usuario == 'profesor' %}
                <h2 class="h3 text-dark mb-2">
                  <i class="fas fa-chalkboard-teacher me-2"></i>Mis Asignaturas
                </h2>
                <p class="text-muted mb-0">Asignaturas bajo tu responsabilidad y asignación</p>
              {% else %}
                <h2 class="h3 text-dark mb-2">
                  <i class="fas fa-book me-2"></i>Gestión de Asignaturas
                </h2>
                <p class="text-muted mb-0">Administra las asignaturas del sistema escolar</p>
              {% endif %}
            </div>
            <div>
              {% if puede_editar %}
                <a href="{% url 'agregar_asignatura' %}" class="btn btn-primary">
                  <i class="fas fa-plus me-1"></i>Nueva Asignatura
                </a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Estadísticas -->
    <div class="row mb-4">
      {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
        <!-- Estadísticas para estudiantes -->
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-book fa-2x text-primary mb-2"></i>
              <h3 class="mb-0 text-dark">{{ total_asignaturas_curso|default:0 }}</h3>
              <p class="mb-0 text-muted">Mis Asignaturas</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-user-check fa-2x text-success mb-2"></i>
              <h3 class="mb-0 text-dark">{{ asignaturas_con_profesor|default:0 }}</h3>
              <p class="mb-0 text-muted">Con Profesor</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              {% if asignaturas_sin_profesor_count %}
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                <h3 class="mb-0 text-dark">{{ asignaturas_sin_profesor_count|default:0 }}</h3>
                <p class="mb-0 text-muted">Sin Profesor</p>
              {% else %}
                <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                <h3 class="mb-0 text-dark">0</h3>
                <p class="mb-0 text-muted">Sin Profesor</p>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              {% if curso_actual %}
                <i class="fas fa-school fa-2x text-info mb-2"></i>
                <h3 class="mb-0 text-dark">{{ curso_actual.get_nivel_display }}{{ curso_actual.paralelo }}</h3>
                <p class="mb-0 text-muted">Mi Curso</p>
              {% else %}
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                <h3 class="mb-0 text-dark">---</h3>
                <p class="mb-0 text-muted">Sin Curso</p>
              {% endif %}
            </div>
          </div>
        </div>
      {% elif tipo_usuario == 'profesor' %}
        <!-- Estadísticas para profesores -->
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-book fa-2x text-success mb-2"></i>
              <h3 class="mb-0 text-dark">{{ total_asignaturas|default:0 }}</h3>
              <p class="mb-0 text-muted">Mis Asignaturas</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-graduation-cap fa-2x text-info mb-2"></i>
              <h3 class="mb-0 text-dark">{{ total_cursos_profesor|default:0 }}</h3>
              <p class="mb-0 text-muted">Cursos Asignados</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-users fa-2x text-primary mb-2"></i>
              <h3 class="mb-0 text-dark">{{ total_estudiantes_profesor|default:0 }}</h3>
              <p class="mb-0 text-muted">Total Estudiantes</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-star fa-2x text-warning mb-2"></i>
              <h3 class="mb-0 text-dark">{{ total_asignaturas|default:0 }}</h3>
              <p class="mb-0 text-muted">Como Responsable</p>
            </div>
          </div>
        </div>
      {% else %}
        <!-- Estadísticas para administradores -->
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-book fa-2x text-primary mb-2"></i>
              <h3 class="mb-0 text-dark">{{ total_asignaturas }}</h3>
              <p class="mb-0 text-muted">Total Asignaturas</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-user-check fa-2x text-success mb-2"></i>
              <h3 class="mb-0 text-dark">{{ asignaturas_con_profesor }}</h3>
              <p class="mb-0 text-muted">Con Profesor</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-school fa-2x text-info mb-2"></i>
              <h3 class="mb-0 text-dark">{{ asignaturas_con_cursos }}</h3>
              <p class="mb-0 text-muted">Asignadas a Cursos</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card border shadow-sm bg-white">
            <div class="card-body text-center">
              <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
              <h3 class="mb-0 text-dark">{{ asignaturas_sin_cursos }}</h3>
              <p class="mb-0 text-muted">Sin Cursos</p>
            </div>
          </div>
        </div>
      {% endif %}
    </div>

    <!-- Información del curso para estudiantes -->
    {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
      {% if curso_actual %}
      <div class="card mb-4 bg-light border-primary">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h5 class="card-title mb-1">
                <i class="fas fa-graduation-cap me-2 text-primary"></i>
                Mi Curso: {{ curso_actual.get_nivel_display }}{{ curso_actual.paralelo }}
              </h5>
              <p class="text-muted mb-2">
                <strong>Año:</strong> {{ curso_actual.anio }} | 
                <strong>Profesor Jefe:</strong> {{ curso_actual.profesor_jefe.get_nombre_completo|default:"No asignado" }}
              </p>
              <p class="mb-0">
                <i class="fas fa-info-circle text-info me-1"></i>
                A continuación se muestran todas las asignaturas de tu curso académico
              </p>
            </div>
            <div class="col-md-4 text-end">
              <div class="badge bg-primary fs-6 px-3 py-2">
                <i class="fas fa-book me-1"></i>
                {{ total_asignaturas_curso }} Asignatura{{ total_asignaturas_curso|pluralize }}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% elif error_curso %}
      <div class="card mb-4 bg-warning bg-opacity-10 border-warning">
        <div class="card-body text-center">
          <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
          <h5 class="text-warning mb-2">Información de Curso</h5>
          <p class="mb-0">{{ error_curso }}</p>
        </div>
      </div>
      {% endif %}
    {% endif %}

    <!-- Filtros -->
    {% if puede_editar %}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border shadow-sm">
          <div class="card-header bg-light border-bottom">
            <h5 class="mb-0 text-dark">
              <i class="fas fa-filter me-2"></i>Filtros de Búsqueda
            </h5>
          </div>
          <div class="card-body">
            <form method="get" class="row g-3">
              <div class="col-md-3">
                <label for="filtro_nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="filtro_nombre" name="filtro_nombre" 
                       value="{{ filtro_nombre }}" placeholder="Buscar por nombre...">
              </div>
              <div class="col-md-3">
                <label for="filtro_codigo" class="form-label">Código</label>
                <input type="text" class="form-control" id="filtro_codigo" name="filtro_codigo" 
                       value="{{ filtro_codigo }}" placeholder="Buscar por código...">
              </div>
              <div class="col-md-3">
                <label for="filtro_profesor" class="form-label">Profesor</label>
                <input type="text" class="form-control" id="filtro_profesor" name="filtro_profesor" 
                       value="{{ filtro_profesor }}" placeholder="Buscar por profesor...">
              </div>
              <div class="col-md-3">
                <label for="filtro_sin_profesor" class="form-label">Sin Profesor</label>
                <select class="form-control" id="filtro_sin_profesor" name="filtro_sin_profesor">
                  <option value="">Todas</option>
                  <option value="1" {% if filtro_sin_profesor %}selected{% endif %}>Solo sin profesor</option>
                </select>
              </div>
              <div class="col-12">
                <button type="submit" class="btn btn-primary">
                  <i class="fas fa-search me-1"></i>Filtrar
                </button>
                <a href="{% url 'listar_asignaturas' %}" class="btn btn-secondary">
                  <i class="fas fa-times me-1"></i>Limpiar
                </a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Resumen para profesores -->
    {% if tipo_usuario == 'profesor' and asignaturas %}
    <div class="row mb-4">
      <div class="col-12">
        <div class="card border shadow-sm bg-gradient-light">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h5 class="mb-2 text-success">
                  <i class="fas fa-clipboard-check me-2"></i>Resumen de mis Responsabilidades
                </h5>
                <p class="text-muted mb-1">
                  Como profesor responsable, tienes <strong>{{ total_asignaturas }} asignatura{{ total_asignaturas|pluralize }}</strong> 
                  distribuida{{ total_asignaturas|pluralize }} en <strong>{{ total_cursos_profesor }} curso{{ total_cursos_profesor|pluralize }}</strong> 
                  con un total de <strong>{{ total_estudiantes_profesor }} estudiante{{ total_estudiantes_profesor|pluralize }}</strong>.
                </p>
                <small class="text-muted">
                  <i class="fas fa-info-circle me-1"></i>
                  Puedes ver los horarios detallados de tus clases en la sección "Mis Horarios"
                </small>
              </div>
              <div class="col-md-4 text-end">
                <a href="{% url 'mis_horarios' %}" class="btn btn-success">
                  <i class="fas fa-calendar-alt me-2"></i>Ver Mis Horarios
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Tabla de asignaturas -->
    <div class="card border shadow-sm">
      <div class="card-header bg-light border-bottom">
        <h5 class="mb-0 text-dark">
          {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
            <i class="fas fa-book-open me-2"></i>Mis Asignaturas
          {% elif tipo_usuario == 'profesor' %}
            <i class="fas fa-chalkboard-teacher me-2"></i>Mis Asignaturas Asignadas
          {% else %}
            <i class="fas fa-list me-2"></i>Asignaturas Registradas
          {% endif %}
        </h5>
      </div>
      <div class="card-body p-0">
        {% if asignaturas %}
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
                    <!-- Vista mejorada para estudiantes -->
                    <th><i class="fas fa-book me-1"></i>Asignatura</th>
                    <th><i class="fas fa-user-tie me-1"></i>Profesor Responsable</th>
                    <th><i class="fas fa-info-circle me-1"></i>Descripción</th>
                    <th><i class="fas fa-clipboard-check me-1"></i>Estado</th>
                  {% elif tipo_usuario == 'profesor' %}
                    <!-- Vista específica para profesores -->
                    <th><i class="fas fa-book me-1"></i>Mis Asignaturas</th>
                    <th><i class="fas fa-school me-1"></i>Cursos Asignados</th>
                    <th><i class="fas fa-users me-1"></i>Estudiantes</th>
                    <th><i class="fas fa-info-circle me-1"></i>Descripción</th>
                  {% else %}
                    <!-- Vista completa para administradores -->
                    <th>Código</th>
                    <th>Nombre</th>
                    <th>Profesores</th>
                    <th>Cursos Asignados</th>
                    <th>Descripción</th>
                    {% if puede_editar %}
                    <th>Acciones</th>
                    {% endif %}
                  {% endif %}
                </tr>
              </thead>
              <tbody>
                {% for asignatura in asignaturas %}
                <tr>
                  {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
                    <!-- Vista mejorada para estudiantes -->
                    <td class="fw-bold text-dark">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-book text-primary me-3" style="font-size: 1.2em;"></i>
                        <div>
                          <h6 class="mb-1 fw-bold">{{ asignatura.nombre }}</h6>
                          {% if asignatura.codigo_asignatura %}
                            <small class="text-muted">
                              <i class="fas fa-tag me-1"></i>
                              Código: {{ asignatura.codigo_asignatura }}
                            </small>
                          {% else %}
                            <small class="text-muted">Sin código asignado</small>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td>
                      {% if asignatura.profesor_responsable %}
                        <div class="d-flex align-items-center">
                          <div class="bg-success bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="fas fa-user text-success"></i>
                          </div>
                          <div>
                            <span class="fw-medium d-block">
                              {{ asignatura.profesor_responsable.primer_nombre }} {{ asignatura.profesor_responsable.apellido_paterno }}
                            </span>
                            {% if asignatura.profesor_responsable.apellido_materno %}
                              <small class="text-muted">{{ asignatura.profesor_responsable.apellido_materno }}</small>
                            {% endif %}
                            {% if asignatura.profesor_responsable.codigo_profesor %}
                              <br><small class="text-muted">
                                <i class="fas fa-id-card me-1"></i>
                                {{ asignatura.profesor_responsable.codigo_profesor }}
                              </small>
                            {% endif %}
                          </div>
                        </div>
                      {% else %}
                        <div class="d-flex align-items-center">
                          <div class="bg-warning bg-opacity-10 rounded-circle p-2 me-3">
                            <i class="fas fa-exclamation-triangle text-warning"></i>
                          </div>
                          <div>
                            <span class="badge bg-warning text-dark">
                              Sin profesor asignado
                            </span>
                            <br><small class="text-muted">Consulta con coordinación académica</small>
                          </div>
                        </div>
                      {% endif %}
                    </td>
                    <td>
                      {% if asignatura.descripcion %}
                        <p class="mb-1">{{ asignatura.descripcion|truncatechars:100 }}</p>
                        {% if asignatura.descripcion|length > 100 %}
                          <small class="text-primary">
                            <i class="fas fa-eye me-1"></i>
                            Mostrar más...
                          </small>
                        {% endif %}
                      {% else %}
                        <em class="text-muted">
                          <i class="fas fa-info-circle me-1"></i>
                          Descripción no disponible
                        </em>
                      {% endif %}
                    </td>
                    <td>
                      <div class="text-center">
                        {% if asignatura.profesor_responsable %}
                          <span class="badge bg-success fs-6 px-3 py-2">
                            <i class="fas fa-check-circle me-1"></i>
                            Activa
                          </span>
                          <br><small class="text-muted mt-1 d-block">Lista para clases</small>
                        {% else %}
                          <span class="badge bg-warning text-dark fs-6 px-3 py-2">
                            <i class="fas fa-clock me-1"></i>
                            Pendiente
                          </span>
                          <br><small class="text-muted mt-1 d-block">Sin profesor</small>
                        {% endif %}
                      </div>
                    </td>
                  {% elif tipo_usuario == 'profesor' %}
                    <!-- Vista específica para profesores -->
                    <td class="fw-bold text-dark">
                      <div class="d-flex align-items-center">
                        <i class="fas fa-book text-success me-3" style="font-size: 1.2em;"></i>
                        <div>
                          <h6 class="mb-1 fw-bold">{{ asignatura.nombre }}</h6>
                          {% if asignatura.codigo_asignatura %}
                            <small class="text-muted">
                              <i class="fas fa-tag me-1"></i>
                              {{ asignatura.codigo_asignatura }}
                            </small>
                          {% else %}
                            <small class="text-muted">Sin código</small>
                          {% endif %}
                          <!-- Indicador de responsabilidad -->
                          {% if asignatura.profesor_responsable == user.profesor %}
                            <br><span class="badge bg-primary badge-sm">
                              <i class="fas fa-star me-1"></i>Responsable
                            </span>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td>
                      {% with cursos=asignatura.cursos.all %}
                        {% if cursos %}
                          <div class="d-flex flex-wrap gap-1">
                            {% for curso in cursos %}
                              <span class="badge bg-info me-1 mb-1" title="{{ curso.get_nivel_display }}{{ curso.paralelo }} - {{ curso.anio }}">
                                <i class="fas fa-graduation-cap me-1"></i>
                                {{ curso.get_nivel_display }}{{ curso.paralelo }}
                              </span>
                            {% endfor %}
                          </div>
                          <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            {{ cursos.count }} curso{{ cursos.count|pluralize }}
                          </small>
                        {% else %}
                          <div class="text-center">
                            <span class="badge bg-warning text-dark">
                              <i class="fas fa-exclamation-triangle me-1"></i>
                              Sin cursos asignados
                            </span>
                            <br><small class="text-muted">Contactar coordinación</small>
                          </div>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td>
                      {% with total_estudiantes=asignatura.get_total_estudiantes %}
                        {% if total_estudiantes > 0 %}
                          <div class="text-center">
                            <div class="bg-info bg-opacity-10 rounded-circle p-2 mx-auto mb-2" style="width: 50px; height: 50px; display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-users text-info"></i>
                            </div>
                            <h6 class="mb-0 fw-bold text-primary">
                              {{ total_estudiantes }}
                            </h6>
                            <small class="text-muted">estudiante{{ total_estudiantes|pluralize }} total</small>
                            {% comment %}Mostrar desglose por curso{% endcomment %}
                            {% with estudiantes_por_curso=asignatura.get_estudiantes_por_curso %}
                              {% if estudiantes_por_curso %}
                                <div class="mt-2">
                                  {% for item in estudiantes_por_curso %}
                                    <small class="d-block text-info">
                                      {{ item.nombre_curso }}: {{ item.total_estudiantes }}
                                    </small>
                                  {% endfor %}
                                </div>
                              {% endif %}
                            {% endwith %}
                          </div>
                        {% else %}
                          <div class="text-center">
                            <div class="bg-secondary bg-opacity-10 rounded-circle p-2 mx-auto mb-2" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                              <i class="fas fa-minus text-secondary"></i>
                            </div>
                            <h6 class="mb-0 text-secondary">0</h6>
                            <small class="text-muted">Sin estudiantes</small>
                          </div>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td>
                      {% if asignatura.descripcion %}
                        <p class="mb-1">{{ asignatura.descripcion|truncatechars:80 }}</p>
                        {% if asignatura.descripcion|length > 80 %}
                          <small class="text-primary">
                            <i class="fas fa-eye me-1"></i>
                            Ver más...
                          </small>
                        {% endif %}
                      {% else %}
                        <em class="text-muted">
                          <i class="fas fa-info-circle me-1"></i>
                          Sin descripción
                        </em>
                      {% endif %}
                    </td>
                  {% else %}
                    <!-- Vista completa para administradores -->
                    <td class="fw-medium">{{ asignatura.codigo_asignatura }}</td>
                    <td class="fw-bold text-dark">{{ asignatura.nombre }}</td>
                    <td>
                      {% with profesores=asignatura.get_profesores_display %}
                        {% if profesores %}
                          {% for profesor in profesores %}
                            <span class="badge bg-success me-1 mb-1" data-professor-id="{{ profesor.id }}">
                              {{ profesor.primer_nombre }} {{ profesor.apellido_paterno }}
                            </span>
                          {% endfor %}
                        {% else %}
                          <span class="badge bg-warning text-dark">Sin profesor</span>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td>
                      {% with cursos=asignatura.get_cursos_asignados %}
                        {% if cursos %}
                          {% for curso in cursos %}
                            <span class="badge bg-info me-1 mb-1" title="{{ curso.get_nivel_display }}{{ curso.paralelo }} ({{ curso.anio }})">
                              {{ curso.get_nivel_display }}{{ curso.paralelo }}
                            </span>
                          {% endfor %}
                          <br><small class="text-muted">{{ cursos.count }} curso{{ cursos.count|pluralize }}</small>
                        {% else %}
                          <span class="badge bg-secondary">Sin cursos</span>
                          <br><small class="text-warning">⚠️ No asignada</small>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td>
                      {% if asignatura.descripcion %}
                        {{ asignatura.descripcion|truncatechars:60 }}
                      {% else %}
                        <em class="text-muted">Sin descripción</em>
                      {% endif %}
                    </td>
                    {% if puede_editar %}
                    <td>
                      <div class="btn-group btn-group-sm" role="group">
                        <a href="{% url 'editar_asignatura' asignatura.id %}" class="btn btn-outline-primary" title="Editar">
                          <i class="fas fa-edit"></i>
                        </a>
                        <button type="button" class="btn btn-outline-success" title="Gestionar Profesores"
                                onclick="gestionarProfesores({{ asignatura.id }}, '{{ asignatura.nombre }}')">
                          <i class="fas fa-users"></i>
                        </button>
                        <button type="button" class="btn btn-outline-info" title="Gestionar Cursos"
                                onclick="gestionarCursos({{ asignatura.id }}, '{{ asignatura.nombre }}')">
                          <i class="fas fa-school"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger" title="Eliminar"
                                onclick="confirmarEliminacion('{{ asignatura.nombre }}', {{ asignatura.id }})">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </td>
                    {% endif %}
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="text-center py-5">
            {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
              <!-- Mensaje mejorado para estudiantes -->
              <div class="mb-4">
                <i class="fas fa-book-open fa-4x text-primary mb-3 opacity-50"></i>
                <h4 class="text-primary mb-3">No hay asignaturas disponibles</h4>
                
                {% if error_curso %}
                  <div class="alert alert-warning d-inline-block">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    {{ error_curso }}
                  </div>
                {% elif error_estudiante %}
                  <div class="alert alert-danger d-inline-block">
                    <i class="fas fa-times-circle me-2"></i>
                    {{ error_estudiante }}
                  </div>
                {% elif not curso_actual %}
                  <div class="alert alert-info d-inline-block">
                    <i class="fas fa-info-circle me-2"></i>
                    No estás asignado a ningún curso actualmente.
                  </div>
                  <p class="text-muted mt-3">
                    Por favor, contacta a tu coordinador académico para que te asigne a un curso.
                  </p>
                {% else %}
                  <div class="alert alert-warning d-inline-block">
                    <i class="fas fa-clock me-2"></i>
                    Tu curso {{ curso_actual }} aún no tiene asignaturas configuradas.
                  </div>
                  <p class="text-muted mt-3">
                    Las asignaturas serán asignadas pronto. Consulta con tu coordinador académico si tienes dudas.
                  </p>
                {% endif %}
                
                <div class="mt-4">
                  <p class="text-muted mb-2">
                    <i class="fas fa-lightbulb me-1 text-warning"></i>
                    <strong>¿Qué puedes hacer mientras tanto?</strong>
                  </p>
                  <ul class="list-unstyled text-muted">
                    <li><i class="fas fa-check text-success me-2"></i>Revisar tu horario de clases</li>
                    <li><i class="fas fa-check text-success me-2"></i>Consultar tus notas anteriores</li>
                    <li><i class="fas fa-check text-success me-2"></i>Contactar a coordinación académica</li>
                  </ul>
                </div>
              </div>
            {% else %}
              <!-- Mensaje para administradores -->
              <i class="fas fa-book fa-3x text-muted mb-3"></i>
              <h5 class="text-muted mb-2">No hay asignaturas registradas</h5>
              <p class="text-muted mb-3">Comienza creando tu primera asignatura en el sistema</p>
              {% if puede_editar %}
                <a href="{% url 'agregar_asignatura' %}" class="btn btn-primary">
                  <i class="fas fa-plus me-1"></i>Nueva Asignatura
                </a>
              {% endif %}
            {% endif %}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Sección de asignaturas sin profesor -->
    {% if asignaturas_sin_profesor and puede_editar %}
    <div class="card border shadow-sm mt-4">
      <div class="card-header bg-warning bg-opacity-10 border-bottom">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0 text-dark">
            <i class="fas fa-user-times me-2 text-warning"></i>Asignaturas Sin Profesor Asignado ({{ asignaturas_sin_profesor_count }})
          </h5>
          <button class="btn btn-sm btn-outline-warning" type="button" data-bs-toggle="collapse" 
                  data-bs-target="#seccionSinProfesor" aria-expanded="false">
            <i class="fas fa-chevron-down me-1"></i>Ver/Ocultar
          </button>
        </div>
      </div>
      <div class="collapse" id="seccionSinProfesor">
        <div class="card-body">
          <div class="row">
            <!-- Listado de asignaturas sin profesor -->
            <div class="col-md-8">
              <h6 class="fw-bold mb-3">
                <i class="fas fa-list me-2"></i>Asignaturas pendientes de asignación:
              </h6>
              {% if asignaturas_sin_profesor %}
                <div class="row">
                  {% for asignatura in asignaturas_sin_profesor %}
                  <div class="col-md-6 mb-2">
                    <div class="card border-warning">
                      <div class="card-body p-2">
                        <h6 class="card-title mb-1">{{ asignatura.nombre }}</h6>
                        <p class="card-text small mb-1">
                          <strong>Código:</strong> {{ asignatura.codigo_asignatura }}<br>
                          <strong>Cursos:</strong> {{ asignatura.cursos.count }}
                        </p>
                        <button class="btn btn-sm btn-warning" 
                                onclick="gestionarProfesores({{ asignatura.id }}, '{{ asignatura.nombre }}')">
                          <i class="fas fa-user-plus me-1"></i>Gestionar Profesores
                        </button>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
              {% else %}
                <p class="text-muted">¡Excelente! Todas las asignaturas tienen profesor asignado.</p>
              {% endif %}
            </div>
            
            <!-- Formulario de asignación rápida -->
            <div class="col-md-4">
              <h6 class="fw-bold mb-3">
                <i class="fas fa-user-plus me-2"></i>Asignación Rápida:
              </h6>
              <form method="post" class="border p-3 rounded bg-light">
                {% csrf_token %}
                <input type="hidden" name="asignar_profesor" value="1">
                
                <div class="mb-3">
                  <label for="asignatura_select" class="form-label">Asignatura:</label>
                  <select class="form-control" id="asignatura_select" name="asignatura_id" required>
                    <option value="">Seleccionar asignatura...</option>
                    {% for asignatura in asignaturas_sin_profesor %}
                    <option value="{{ asignatura.id }}">{{ asignatura.nombre }} ({{ asignatura.codigo_asignatura }})</option>
                    {% endfor %}
                  </select>
                </div>
                
                <div class="mb-3">
                  <label for="profesor_select" class="form-label">Profesor:</label>
                  <select class="form-control" id="profesor_select" name="profesor_id" required>
                    <option value="">Seleccionar profesor...</option>
                    {% for profesor in profesores %}
                    <option value="{{ profesor.id }}">{{ profesor.primer_nombre }} {{ profesor.apellido_paterno }}</option>
                    {% endfor %}
                  </select>
                </div>
                
                <button type="submit" class="btn btn-warning w-100">
                  <i class="fas fa-save me-1"></i>Asignar Profesor
                </button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- Modales para gestión (solo para administradores) -->
{% if puede_editar %}
<!-- Modal para gestionar profesores -->
<div class="modal fade" id="modalGestionarProfesores" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-users me-2"></i>Gestionar Profesores
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Profesores actuales -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Profesores Asignados:</h6>
            <div id="profesoresAsignados">
              <!-- Se llena dinámicamente with JavaScript -->
            </div>
          </div>
          
          <!-- Agregar nuevo profesor -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Agregar Profesor:</h6>
            <form method="post" id="formAgregarProfesor">
              {% csrf_token %}
              <input type="hidden" name="asignar_profesor" value="1">
              <input type="hidden" name="asignatura_id" id="modalAsignaturaId">
              
              <div class="mb-3">
                <label class="form-label">Asignatura:</label>
                <p class="fw-bold" id="modalAsignaturaNombre"></p>
              </div>
              
              <div class="mb-3">
                <label for="modalProfesorSelect" class="form-label">Seleccionar Profesor:</label>
                <select class="form-control" id="modalProfesorSelect" name="profesor_id" required>
                  <option value="">Seleccionar profesor...</option>
                  {% for profesor in profesores %}
                  <option value="{{ profesor.id }}">{{ profesor.primer_nombre }} {{ profesor.apellido_paterno }}</option>
                  {% endfor %}
                </select>
              </div>
              
              <button type="submit" class="btn btn-success w-100">
                <i class="fas fa-plus me-1"></i>Agregar Profesor
              </button>
            </form>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal para gestionar cursos -->
<div class="modal fade" id="modalGestionarCursos" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          <i class="fas fa-school me-2"></i>Gestionar Cursos
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <!-- Cursos actuales -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Cursos Asignados:</h6>
            <div id="cursosAsignados">
              <!-- Se llena dinámicamente con JavaScript -->
            </div>
          </div>
          
          <!-- Agregar nuevo curso -->
          <div class="col-md-6">
            <h6 class="fw-bold mb-3">Asignar a Curso:</h6>
            <form method="post" id="formAgregarCurso">
              {% csrf_token %}
              <input type="hidden" name="asignar_curso" value="1">
              <input type="hidden" name="asignatura_id" id="modalCursoAsignaturaId">
              
              <div class="mb-3">
                <label class="form-label">Asignatura:</label>
                <p class="fw-bold" id="modalCursoAsignaturaNombre"></p>
              </div>
              
              <div class="mb-3">
                <label for="modalCursoSelect" class="form-label">Seleccionar Curso:</label>
                <select class="form-control" id="modalCursoSelect" name="curso_id" required>
                  <option value="">Seleccionar curso...</option>
                  {% for curso in cursos_disponibles %}
                  <option value="{{ curso.id }}">{{ curso.get_nivel_display }}{{ curso.paralelo }} ({{ curso.anio }})</option>
                  {% endfor %}
                </select>
              </div>
              
              <button type="submit" class="btn btn-info w-100">
                <i class="fas fa-plus me-1"></i>Asignar a Curso
              </button>
            </form>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- JavaScript -->
{% if puede_editar %}
<script>
function gestionarProfesores(asignaturaId, asignaturaNombre) {
  document.getElementById('modalAsignaturaId').value = asignaturaId;
  document.getElementById('modalAsignaturaNombre').textContent = asignaturaNombre;
  
  // Cargar profesores asignados
  cargarProfesoresAsignados(asignaturaId);
  
  var modal = new bootstrap.Modal(document.getElementById('modalGestionarProfesores'));
  modal.show();
}

function cargarProfesoresAsignados(asignaturaId) {
  // Buscar la fila de la asignatura para obtener los profesores
  const filaAsignatura = document.querySelector(`button[onclick*="gestionarProfesores(${asignaturaId}"]`).closest('tr');
  const profesoresCell = filaAsignatura.querySelector('td:nth-child(3)');
  const profesoresBadges = profesoresCell.querySelectorAll('.badge.bg-success');
  
  const container = document.getElementById('profesoresAsignados');
  container.innerHTML = '';
  
  if (profesoresBadges.length === 0) {
    container.innerHTML = '<p class="text-muted">No hay profesores asignados</p>';
  } else {
    profesoresBadges.forEach((badge, index) => {
      const profesorNombre = badge.textContent.trim();
      const profesorId = badge.getAttribute('data-professor-id');
      const profesorDiv = document.createElement('div');
      profesorDiv.className = 'mb-2 p-2 border rounded bg-light';
      profesorDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-medium">${profesorNombre}</span>
          <button type="button" class="btn btn-sm btn-outline-danger" 
                  onclick="removerProfesor(${asignaturaId}, ${profesorId}, '${profesorNombre}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      container.appendChild(profesorDiv);
    });
  }
}

function removerProfesor(asignaturaId, profesorId, profesorNombre) {
  if (confirm(`¿Estás seguro de que deseas remover al profesor ${profesorNombre} de esta asignatura?`)) {
    // Crear formulario temporal para enviar la petición
    const form = document.createElement('form');
    form.method = 'post';
    form.style.display = 'none';
    
    // CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfInput);
    
    // Acción
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'remover_profesor';
    actionInput.value = '1';
    form.appendChild(actionInput);
    
    // Asignatura ID
    const asignaturaInput = document.createElement('input');
    asignaturaInput.type = 'hidden';
    asignaturaInput.name = 'asignatura_id';
    asignaturaInput.value = asignaturaId;
    form.appendChild(asignaturaInput);
    
    // Profesor ID
    const profesorInput = document.createElement('input');
    profesorInput.type = 'hidden';
    profesorInput.name = 'profesor_id';
    profesorInput.value = profesorId;
    form.appendChild(profesorInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}

function asignarProfesor(asignaturaId, asignaturaNombre, profesorId) {
  // Redirigir a la nueva función
  gestionarProfesores(asignaturaId, asignaturaNombre);
}

function confirmarEliminacion(nombreAsignatura, asignaturaId) {
  if (confirm(`¿Estás seguro de que deseas eliminar la asignatura "${nombreAsignatura}"?\n\nEsta acción no se puede deshacer y eliminará:\n- Todos los horarios asociados\n- Todas las asignaciones a cursos\n\n¿Continuar?`)) {
    window.location.href = `/asignaturas/eliminar/${asignaturaId}/`;
  }
}

function gestionarCursos(asignaturaId, asignaturaNombre) {
  document.getElementById('modalCursoAsignaturaId').value = asignaturaId;
  document.getElementById('modalCursoAsignaturaNombre').textContent = asignaturaNombre;
  
  // Cargar cursos asignados
  cargarCursosAsignados(asignaturaId);
  
  var modal = new bootstrap.Modal(document.getElementById('modalGestionarCursos'));
  modal.show();
}

function cargarCursosAsignados(asignaturaId) {
  // Buscar la fila de la asignatura para obtener los cursos
  const filaAsignatura = document.querySelector(`button[onclick*="gestionarCursos(${asignaturaId}"]`).closest('tr');
  const cursosCell = filaAsignatura.querySelector('td:nth-child(4)'); // Columna de cursos
  const cursosBadges = cursosCell.querySelectorAll('.badge.bg-info');
  
  const container = document.getElementById('cursosAsignados');
  container.innerHTML = '';
  
  if (cursosBadges.length === 0) {
    container.innerHTML = '<p class="text-muted">No hay cursos asignados</p>';
  } else {
    cursosBadges.forEach((badge, index) => {
      const cursoNombre = badge.textContent.trim();
      const cursoTitle = badge.getAttribute('title') || cursoNombre;
      const cursoDiv = document.createElement('div');
      cursoDiv.className = 'mb-2 p-2 border rounded bg-light';
      cursoDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <span class="fw-medium">${cursoTitle}</span>
          <button type="button" class="btn btn-sm btn-outline-danger" 
                  onclick="removerCurso(${asignaturaId}, '${cursoNombre}', '${cursoTitle}')">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      container.appendChild(cursoDiv);
    });
  }
}

function removerCurso(asignaturaId, cursoNombre, cursoTitle) {
  if (confirm(`¿Estás seguro de que deseas desasignar esta asignatura del curso ${cursoTitle}?`)) {
    // Crear formulario temporal para enviar la petición
    const form = document.createElement('form');
    form.method = 'post';
    form.style.display = 'none';
    
    // CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    form.appendChild(csrfInput);
    
    // Acción
    const actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'remover_curso';
    actionInput.value = '1';
    form.appendChild(actionInput);
    
    // Asignatura ID
    const asignaturaInput = document.createElement('input');
    asignaturaInput.type = 'hidden';
    asignaturaInput.name = 'asignatura_id';
    asignaturaInput.value = asignaturaId;
    form.appendChild(asignaturaInput);
    
    // Curso nombre (para identificarlo)
    const cursoInput = document.createElement('input');
    cursoInput.type = 'hidden';
    cursoInput.name = 'curso_nombre';
    cursoInput.value = cursoNombre;
    form.appendChild(cursoInput);
    
    document.body.appendChild(form);
    form.submit();
  }
}

// Bootstrap 5 compatibility
if (typeof bootstrap === 'undefined') {
  // Fallback para versiones anteriores de Bootstrap
  window.bootstrap = {
    Modal: function(element) {
      return {
        show: function() {
          $(element).modal('show');
        }
      };
    }
  };
}
</script>
{% endif %}

<!-- Estilos mejorados para mejor legibilidad -->
<style>
/* Gradiente suave para cards de resumen */
.bg-gradient-light {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border: 1px solid #dee2e6;
}

/* Estadísticas mejoradas para profesores */
.card.border.shadow-sm {
  transition: all 0.3s ease;
  border-radius: 12px;
}

.card.border.shadow-sm:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15) !important;
}

/* Iconos de estadísticas con efecto */
.card-body i.fa-2x {
  transition: all 0.3s ease;
}

.card:hover .card-body i.fa-2x {
  transform: scale(1.1);
}

/* Colores específicos para iconos de profesor */
.text-success {
  color: #28a745 !important;
}

.text-info {
  color: #17a2b8 !important;
}

.text-primary {
  color: #007bff !important;
}

.text-warning {
  color: #ffc107 !important;
}

/* Mejoras para la tabla de profesor */
.table-hover tbody tr:hover {
  background-color: #f8f9fa;
  transform: scale(1.01);
  transition: all 0.2s ease;
}

.btn-group-sm > .btn {
  border-radius: 4px;
  margin: 0 2px;
  font-size: 0.875rem;
}

.card {
  border: 1px solid #e9ecef;
  border-radius: 12px;
}

.border {
  border: 1px solid #e9ecef !important;
}

.fw-medium {
  font-weight: 500;
}

.text-dark {
  color: #212529 !important;
}

.badge {
  font-size: 0.8em;
  padding: 0.5em 0.8em;
  border-radius: 6px;
  transition: all 0.3s ease;
}

.badge:hover {
  transform: scale(1.05);
}

.badge.bg-success {
  background-color: #28a745 !important;
  color: white !important;
}

.badge.bg-warning {
  background-color: #ffc107 !important;
  color: #212529 !important;
}

.badge.bg-info {
  background-color: #17a2b8 !important;
  color: white !important;
}

.badge.bg-primary {
  background-color: #007bff !important;
  color: white !important;
}

.table th {
  border-bottom: 2px solid #dee2e6;
  background-color: #f8f9fa;
  font-weight: 600;
  color: #495057;
  position: sticky;
  top: 0;
  z-index: 10;
}

.table td {
  border-bottom: 1px solid #dee2e6;
  vertical-align: middle;
  padding: 1rem 0.75rem;
}

/* Animaciones para botones */
.btn {
  transition: all 0.3s ease;
}

.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-outline-primary:hover {
  background-color: #007bff;
  border-color: #007bff;
  color: white;
}

.btn-outline-success:hover {
  background-color: #28a745;
  border-color: #28a745;
  color: white;
}

.btn-outline-danger:hover {
  background-color: #dc3545;
  border-color: #dc3545;
  color: white;
}

.card-header {
  background-color: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
  font-weight: 600;
  border-radius: 12px 12px 0 0;
}

.form-control {
  border: 1px solid #ced4da;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.form-control:focus {
  border-color: #80bdff;
  box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
  transform: scale(1.02);
}

/* Estilos específicos para vista de profesor */
.profesor-asignatura-card {
  background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
  border-left: 4px solid #28a745;
}

.curso-badge-container {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.estudiantes-counter {
  background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto;
  font-weight: bold;
  color: #1976d2;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Responsive mejorado */
@media (max-width: 768px) {
  .card:hover {
    transform: none;
  }
  
  .table-hover tbody tr:hover {
    transform: none;
  }
  
  .btn:hover {
    transform: none;
  }
  
  .form-control:focus {
    transform: none;
  }
}

/* Animaciones de entrada */
@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.card {
  animation: slideInUp 0.6s ease forwards;
}

/* Efectos de carga escalonados */
.row .card:nth-child(1) { animation-delay: 0.1s; }
.row .card:nth-child(2) { animation-delay: 0.2s; }
.row .card:nth-child(3) { animation-delay: 0.3s; }
.row .card:nth-child(4) { animation-delay: 0.4s; }
</style>
{% endblock %}
