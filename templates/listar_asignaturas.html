{% extends "index_master.html" %}

{% block extra_css %}
<style>
  /* Premium Design for Subjects Page */
  .subjects-page {
    padding: 2rem;
    background-color: #f8f9fa;
    min-height: 100vh;
    font-family: 'Inter', sans-serif;
  }

  /* Header Section */
  .subjects-header {
    background: white;
    padding: 1.5rem 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .subjects-title h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .subjects-title h2 i {
    color: #3b82f6;
  }

  .subjects-subtitle {
    color: #64748b;
    margin: 0.5rem 0 0;
    font-size: 0.95rem;
  }

  .btn-new-subject {
    background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
    text-decoration: none;
  }

  .btn-new-subject:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(37, 99, 235, 0.3);
    color: white;
  }

  /* Stats Cards */
  .subjects-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .subjects-stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.3s ease;
    border: 1px solid rgba(0,0,0,0.05);
    position: relative;
    overflow: hidden;
  }

  .subjects-stat-card:hover {
    transform: translateY(-5px);
  }

  .subjects-stat-card::after {
    content: '';
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    width: 6px;
  }

  .subjects-stat-card--primary::after { background: #3b82f6; }
  .subjects-stat-card--success::after { background: #10b981; }
  .subjects-stat-card--info::after { background: #0ea5e9; }
  .subjects-stat-card--warning::after { background: #f59e0b; }

  .subjects-stat-card__icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }

  .subjects-stat-card--primary .subjects-stat-card__icon { background: #eff6ff; color: #3b82f6; }
  .subjects-stat-card--success .subjects-stat-card__icon { background: #ecfdf5; color: #10b981; }
  .subjects-stat-card--info .subjects-stat-card__icon { background: #e0f2fe; color: #0ea5e9; }
  .subjects-stat-card--warning .subjects-stat-card__icon { background: #fffbeb; color: #f59e0b; }

  .subjects-stat-card__metric {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    line-height: 1.2;
  }

  .subjects-stat-card__label {
    color: #64748b;
    font-size: 0.875rem;
    margin: 0;
  }

  /* Search Section */
  .subjects-search-section {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
  }

  .subjects-search-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #1e293b;
    margin-bottom: 1.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .subjects-search-title i {
    color: #3b82f6;
  }

  .subjects-search-form {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
  }

  .subjects-search-input-wrapper {
    flex: 1;
    position: relative;
    min-width: 200px;
  }

  .subjects-search-input-wrapper i {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: #94a3b8;
  }

  .subjects-search-input {
    width: 100%;
    padding: 1rem 1rem 1rem 3rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background: #f8fafc;
  }

  .subjects-search-input:focus {
    border-color: #3b82f6;
    background: white;
    outline: none;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
  }

  .subjects-search-select {
    padding: 1rem;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 1rem;
    background: #f8fafc;
    color: #334155;
    min-width: 180px;
  }

  .btn-search {
    background: #3b82f6;
    color: white;
    border: none;
    padding: 0 2rem;
    height: 54px;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
  }

  .btn-search:hover {
    background: #2563eb;
    transform: translateY(-1px);
  }

  .btn-clear {
    background: #f1f5f9;
    color: #64748b;
    border: none;
    padding: 0 1.5rem;
    height: 54px;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .btn-clear:hover {
    background: #e2e8f0;
    color: #475569;
  }

  /* Table Section */
  .subjects-table-container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    overflow: hidden;
  }

  .subjects-table-header {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #e2e8f0;
  }

  .subjects-table-header h3 {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
  }

  .subjects-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .subjects-table th {
    background: #f8fafc;
    color: #64748b;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    padding: 1rem 1.5rem;
    text-align: left;
    border-bottom: 1px solid #e2e8f0;
  }

  .subjects-table td {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #f1f5f9;
    vertical-align: middle;
    color: #334155;
  }

  .subjects-table tr:last-child td {
    border-bottom: none;
  }

  .subjects-table tr:hover td {
    background: #f8fafc;
  }

  .subject-info {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .subject-icon {
    width: 40px;
    height: 40px;
    background: #eff6ff;
    color: #3b82f6;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 1.1rem;
  }

  .subject-details h4 {
    margin: 0;
    font-size: 0.95rem;
    font-weight: 600;
    color: #1e293b;
  }

  .subject-meta {
    display: flex;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: #64748b;
    margin-top: 0.25rem;
    flex-wrap: wrap;
  }

  .subject-meta span {
    display: flex;
    align-items: center;
    gap: 0.25rem;
  }

  .status-badge {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
  }

  .status-badge--active {
    background: #ecfdf5;
    color: #10b981;
  }

  .status-badge--warning {
    background: #fffbeb;
    color: #f59e0b;
  }

  .status-badge--info {
    background: #e0f2fe;
    color: #0ea5e9;
  }

  .action-btn {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    margin-right: 0.25rem;
    text-decoration: none;
  }

  .action-btn--edit {
    background: #eff6ff;
    color: #3b82f6;
  }

  .action-btn--edit:hover {
    background: #3b82f6;
    color: white;
  }

  .action-btn--delete {
    background: #fef2f2;
    color: #ef4444;
  }

  .action-btn--delete:hover {
    background: #ef4444;
    color: white;
  }

  .action-btn--info {
    background: #e0f2fe;
    color: #0ea5e9;
  }

  .action-btn--info:hover {
    background: #0ea5e9;
    color: white;
  }

  .action-btn--warning {
    background: #fffbeb;
    color: #f59e0b;
  }

  .action-btn--warning:hover {
    background: #f59e0b;
    color: white;
  }

  .empty-state {
    text-align: center;
    padding: 4rem 2rem;
    color: #64748b;
  }

  .empty-state i {
    font-size: 3rem;
    color: #cbd5e1;
    margin-bottom: 1rem;
  }

  /* Modal Styles */
  .modal-content {
    border-radius: 16px;
    border: none;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  }

  .modal-header {
    border-bottom: 1px solid #e2e8f0;
    padding: 1.5rem;
  }

  .modal-title {
    font-weight: 700;
    color: #1e293b;
  }

  .modal-body {
    padding: 1.5rem;
  }

  .modal-footer {
    border-top: 1px solid #e2e8f0;
    padding: 1.5rem;
  }

  .manage-pill {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 12px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
</style>
{% endblock %}

{% block content %}
<div class="right_col" role="main">
  <div class="container-fluid subjects-page">
    
    <!-- Header -->
    <header class="subjects-header">
      <div class="subjects-title">
        <h2>
          {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
            <i class="fa fa-book"></i> Mis Asignaturas
          {% elif tipo_usuario == 'profesor' %}
            <i class="fa fa-chalkboard-teacher"></i> Mis Clases
          {% else %}
            <i class="fa fa-book-open"></i> Gestión de Asignaturas
          {% endif %}
        </h2>
        <p class="subjects-subtitle">
          {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
            Revisa tus materias y profesores asignados.
          {% elif tipo_usuario == 'profesor' %}
            Administra tus asignaturas y cursos a cargo.
          {% else %}
            Administra el plan de estudios y asignaciones académicas.
          {% endif %}
        </p>
      </div>
      {% if puede_editar %}
        <a href="{% url 'agregar_asignatura' %}" class="btn-new-subject">
          <i class="fa fa-plus"></i> Nueva asignatura
        </a>
      {% endif %}
    </header>

    <!-- Stats (Only for Admin/Director) -->
    {% if tipo_usuario != 'alumno' and tipo_usuario != 'estudiante' %}
      <section class="subjects-stats">
        <article class="subjects-stat-card subjects-stat-card--primary">
          <span class="subjects-stat-card__icon"><i class="fa fa-book"></i></span>
          <div>
            <p class="subjects-stat-card__metric">{{ total_asignaturas|default:"0" }}</p>
            <p class="subjects-stat-card__label">Total asignaturas</p>
          </div>
        </article>
        
        {% if tipo_usuario == 'profesor' %}
             <article class="subjects-stat-card subjects-stat-card--success">
              <span class="subjects-stat-card__icon"><i class="fa fa-users"></i></span>
              <div>
                <p class="subjects-stat-card__metric">{{ total_estudiantes_profesor|default:"0" }}</p>
                <p class="subjects-stat-card__label">Estudiantes a cargo</p>
              </div>
            </article>
             <article class="subjects-stat-card subjects-stat-card--info">
              <span class="subjects-stat-card__icon"><i class="fa fa-school"></i></span>
              <div>
                <p class="subjects-stat-card__metric">{{ total_cursos_profesor|default:"0" }}</p>
                <p class="subjects-stat-card__label">Cursos asignados</p>
              </div>
            </article>
        {% else %}
            <article class="subjects-stat-card subjects-stat-card--success">
              <span class="subjects-stat-card__icon"><i class="fa fa-chalkboard-teacher"></i></span>
              <div>
                <p class="subjects-stat-card__metric">{{ asignaturas_con_profesor|default:"0" }}</p>
                <p class="subjects-stat-card__label">Con profesor</p>
              </div>
            </article>
            
            <article class="subjects-stat-card subjects-stat-card--warning">
              <span class="subjects-stat-card__icon"><i class="fa fa-user-times"></i></span>
              <div>
                <p class="subjects-stat-card__metric">{{ asignaturas_sin_profesor_count|default:"0" }}</p>
                <p class="subjects-stat-card__label">Sin profesor</p>
              </div>
            </article>
            
            <article class="subjects-stat-card subjects-stat-card--info">
              <span class="subjects-stat-card__icon"><i class="fa fa-layer-group"></i></span>
              <div>
                <p class="subjects-stat-card__metric">{{ asignaturas_con_cursos|default:"0" }}</p>
                <p class="subjects-stat-card__label">Con cursos</p>
              </div>
            </article>
        {% endif %}
      </section>
    {% endif %}

    <!-- Search (Only for Admin/Director) -->
    {% if tipo_usuario != 'alumno' and tipo_usuario != 'estudiante' and tipo_usuario != 'profesor' %}
      <section class="subjects-search-section">
        <h3 class="subjects-search-title">
          <i class="fa fa-search"></i> Filtrar asignaturas
        </h3>
        <form method="get" class="subjects-search-form">
          <div class="subjects-search-input-wrapper">
            <i class="fa fa-search"></i>
            <input type="text" name="filtro_nombre" class="subjects-search-input" placeholder="Buscar por nombre..." value="{{ filtro_nombre }}">
          </div>
          <div class="subjects-search-input-wrapper">
            <i class="fa fa-barcode"></i>
            <input type="text" name="filtro_codigo" class="subjects-search-input" placeholder="Código..." value="{{ filtro_codigo }}">
          </div>
          <div class="subjects-search-input-wrapper">
            <i class="fa fa-user"></i>
            <input type="text" name="filtro_profesor" class="subjects-search-input" placeholder="Profesor..." value="{{ filtro_profesor }}">
          </div>
          <select name="filtro_sin_profesor" class="subjects-search-select">
            <option value="">Todos los estados</option>
            <option value="1" {% if filtro_sin_profesor %}selected{% endif %}>Sin profesor asignado</option>
          </select>
          <button type="submit" class="btn-search">
            <i class="fa fa-filter"></i> Filtrar
          </button>
          {% if filtro_nombre or filtro_codigo or filtro_profesor or filtro_sin_profesor %}
            <a href="{% url 'listar_asignaturas' %}" class="btn-clear">
              <i class="fa fa-times"></i> Limpiar
            </a>
          {% endif %}
        </form>
      </section>
    {% endif %}

    <!-- Table -->
    <section class="subjects-table-container">
      <div class="subjects-table-header">
        <h3><i class="fa fa-list"></i> Listado de asignaturas</h3>
        {% if asignaturas %}
          <span class="badge badge-info" style="margin-left: 10px;">{{ asignaturas|length }}</span>
        {% endif %}
      </div>

      {% if asignaturas %}
        <div class="table-responsive">
          <table class="subjects-table">
            <thead>
              <tr>
                {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
                  <th>Asignatura</th>
                  <th>Profesor</th>
                  <th>Estado</th>
                {% elif tipo_usuario == 'profesor' %}
                  <th>Asignatura</th>
                  <th>Cursos</th>
                  <th>Estudiantes</th>
                {% else %}
                  <th>Código</th>
                  <th>Asignatura</th>
                  <th>Profesor Responsable</th>
                  <th>Cursos Asignados</th>
                  {% if puede_editar %}<th>Acciones</th>{% endif %}
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for asignatura in asignaturas %}
                <tr>
                  {% if tipo_usuario == 'alumno' or tipo_usuario == 'estudiante' %}
                    <td>
                      <div class="subject-info">
                        <div class="subject-icon">
                          <i class="fa fa-book"></i>
                        </div>
                        <div class="subject-details">
                          <h4>{{ asignatura.nombre }}</h4>
                          <div class="subject-meta">
                            <span><i class="fa fa-tag"></i> {{ asignatura.codigo_asignatura|default:"Sin código" }}</span>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>
                      {% if asignatura.profesor_responsable %}
                        <span class="status-badge status-badge--active">
                          <i class="fa fa-user"></i> {{ asignatura.profesor_responsable.get_nombre_completo }}
                        </span>
                      {% else %}
                        <span class="status-badge status-badge--warning">
                          <i class="fa fa-user-times"></i> Por asignar
                        </span>
                      {% endif %}
                    </td>
                    <td>
                      <span class="status-badge status-badge--active">Activa</span>
                    </td>
                  {% elif tipo_usuario == 'profesor' %}
                    <td>
                      <div class="subject-info">
                        <div class="subject-icon">
                          <i class="fa fa-book"></i>
                        </div>
                        <div class="subject-details">
                          <h4>{{ asignatura.nombre }}</h4>
                          <div class="subject-meta">
                            <span><i class="fa fa-tag"></i> {{ asignatura.codigo_asignatura|default:"Sin código" }}</span>
                          </div>
                        </div>
                      </div>
                    </td>
                    <td>
                      {% with cursos=asignatura.get_cursos_asignados %}
                        {% if cursos %}
                          <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                          {% for curso in cursos %}
                            <span class="status-badge status-badge--info">
                              {{ curso.get_nivel_display }}{{ curso.paralelo }}
                            </span>
                          {% endfor %}
                          </div>
                        {% else %}
                          <span class="status-badge status-badge--warning">Sin cursos</span>
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td>
                      <span class="status-badge status-badge--active">
                        <i class="fa fa-users"></i> {{ asignatura.get_total_estudiantes }}
                      </span>
                    </td>
                  {% else %}
                    <!-- Admin View -->
                    <td>
                      <span style="font-family: monospace; color: #3b82f6; font-weight: 600;">
                        {{ asignatura.codigo_asignatura }}
                      </span>
                    </td>
                    <td>
                      <div class="subject-info">
                        <div class="subject-icon">
                          <i class="fa fa-book"></i>
                        </div>
                        <div class="subject-details">
                          <h4>{{ asignatura.nombre }}</h4>
                          {% if asignatura.descripcion %}
                            <div class="subject-meta">
                              <span>{{ asignatura.descripcion|truncatechars:50 }}</span>
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </td>
                    <td>
                      {% if asignatura.profesor_responsable %}
                        <span class="status-badge status-badge--active">
                          <i class="fa fa-user"></i> {{ asignatura.profesor_responsable.get_nombre_completo }}
                        </span>
                      {% else %}
                        <span class="status-badge status-badge--warning">
                          <i class="fa fa-user-times"></i> Sin asignar
                        </span>
                      {% endif %}
                    </td>
                    <td>
                      {% with cursos=asignatura.get_cursos_asignados %}
                        {% if cursos %}
                          <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            {% for curso in cursos %}
                              <span class="status-badge status-badge--info" title="{{ curso.anio }}">
                                {{ curso.get_nivel_display }}{{ curso.paralelo }}
                              </span>
                            {% endfor %}
                          </div>
                          <div class="subject-meta" style="margin-top: 5px;">
                            <span>{{ cursos.count }} curso{{ cursos.count|pluralize }}</span>
                          </div>
                        {% else %}
                          <span class="status-badge status-badge--warning">Sin cursos</span>
                        {% endif %}
                      {% endwith %}
                    </td>
                    {% if puede_editar %}
                      <td>
                        <div style="display: flex;">
                          <a href="{% url 'editar_asignatura' asignatura.id %}" class="action-btn action-btn--edit" title="Editar">
                            <i class="fa fa-edit"></i>
                          </a>

                          <button type="button"
                                  class="action-btn action-btn--delete"
                                  title="Eliminar"
                                  onclick="confirmarEliminacion('{{ asignatura.nombre|escapejs }}', '{% url 'eliminar_asignatura' asignatura.id %}')">
                            <i class="fa fa-trash"></i>
                          </button>
                        </div>
                      </td>
                    {% endif %}
                  {% endif %}
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="empty-state">
          <i class="fa fa-book-open"></i>
          <h4>No se encontraron asignaturas</h4>
          <p>No hay asignaturas registradas o que coincidan con tu búsqueda.</p>
          {% if puede_editar %}
            <a href="{% url 'agregar_asignatura' %}" class="btn-new-subject" style="display: inline-flex; margin-top: 1rem;">
              <i class="fa fa-plus"></i> Crear primera asignatura
            </a>
          {% endif %}
        </div>
      {% endif %}
    </section>
    
    <!-- Quick Assign Section (Admin Only) -->
    {% if asignaturas_sin_profesor and puede_editar %}
      <section class="subjects-search-section" style="margin-top: 2rem;">
        <h3 class="subjects-search-title">
          <i class="fa fa-exclamation-triangle text-warning"></i> Asignaturas pendientes de profesor
        </h3>
        <div class="row">
          {% for item in asignaturas_sin_profesor %}
            <div class="col-md-4 col-sm-6">
              <div class="subjects-stat-card" style="margin-bottom: 1rem;">
                <div style="width: 100%;">
                  <h5 style="margin: 0 0 0.5rem 0; font-weight: 600;">{{ item.nombre }}</h5>
                  <p class="subject-meta">Código: {{ item.codigo_asignatura }}</p>
                  <button type="button"
                          class="btn btn-warning btn-sm btn-block"
                          style="margin-top: 1rem;"
                          data-asignatura-id="{{ item.id }}"
                          data-asignatura-nombre="{{ item.nombre|escape }}"
                          onclick="gestionarProfesores(this)">
                    <i class="fa fa-user-plus"></i> Asignar Profesor
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      </section>
    {% endif %}

  </div>
</div>

{% if puede_editar %}
  <div class="modal fade" id="modalGestionarProfesores" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-users text-primary"></i> Gestión de profesor</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-6">
              <h5>Profesor asignado</h5>
              <div id="profesorActualContainer">
                <p class="description-text">Selecciona una asignatura para ver su profesor actual.</p>
              </div>
            </div>
            <div class="col-sm-6">
              <h5>Asignar nuevo profesor</h5>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="asignar_profesor" value="1">
                <input type="hidden" name="asignatura_id" id="modalAsignaturaId">
                <div class="form-group">
                  <label>Asignatura</label>
                  <p class="form-control-static" id="modalAsignaturaNombre">Selecciona una asignatura desde la tabla.</p>
                </div>
                <div class="form-group">
                  <label for="modalProfesorSelect">Profesor disponible</label>
                  <select id="modalProfesorSelect" name="profesor_id" class="form-control" required>
                    <option value="">Selecciona un profesor</option>
                    {% for profesor in profesores %}
                      <option value="{{ profesor.id }}">{{ profesor.get_nombre_completo }}</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-success btn-block"><i class="fa fa-plus"></i> Asignar profesor</button>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="modalGestionarCursos" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title"><i class="fa fa-school text-info"></i> Gestión de cursos</h4>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-sm-6">
              <h5>Cursos asociados</h5>
              <div id="cursosActualesContainer">
                <p class="description-text">Selecciona una asignatura para revisar sus cursos asociados.</p>
              </div>
            </div>
            <div class="col-sm-6">
              <h5>Asignar a curso</h5>
              <form method="post">
                {% csrf_token %}
                <input type="hidden" name="asignar_curso" value="1">
                <input type="hidden" name="asignatura_id" id="modalCursoAsignaturaId">
                <div class="form-group">
                  <label>Asignatura</label>
                  <p class="form-control-static" id="modalCursoAsignaturaNombre">Selecciona una asignatura desde la tabla.</p>
                </div>
                <div class="form-group">
                  <label for="modalCursoSelect">Curso disponible</label>
                  <select id="modalCursoSelect" name="curso_id" class="form-control" required>
                    <option value="">Selecciona un curso</option>
                    {% for curso in cursos_disponibles %}
                      <option value="{{ curso.id }}">{{ curso.get_nivel_display }}{{ curso.paralelo }} ({{ curso.anio }})</option>
                    {% endfor %}
                  </select>
                </div>
                <button type="submit" class="btn btn-info btn-block"><i class="fa fa-plus"></i> Asignar a curso</button>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function($) {
      'use strict';

      function getCsrfToken() {
        return $('input[name=csrfmiddlewaretoken]').first().val();
      }

      function submitPost(payload) {
        var $form = $('<form>', { method: 'post', style: 'display:none;' });
        $form.append($('<input>', { type: 'hidden', name: 'csrfmiddlewaretoken', value: getCsrfToken() }));
        $.each(payload, function(key, value) {
          $form.append($('<input>', { type: 'hidden', name: key, value: value }));
        });
        $('body').append($form);
        $form.submit();
      }

      window.gestionarProfesores = function(button) {
        var $btn = $(button);
        var asignaturaId = $btn.data('asignaturaId');
        var asignaturaNombre = $btn.data('asignaturaNombre');
        var profesorId = $btn.data('profesorId') || '';
        var profesorNombre = $btn.data('profesorNombre') || '';

        $('#modalAsignaturaId').val(asignaturaId);
        $('#modalAsignaturaNombre').text(asignaturaNombre || 'Sin nombre registrado');
        $('#modalProfesorSelect').val('');

        var $container = $('#profesorActualContainer');
        $container.empty();

        if (profesorId) {
          var $pill = $('<div class="manage-pill"></div>');
          $pill.append('<div><strong>' + profesorNombre + '</strong><br><span class="mini-text">Profesor responsable</span></div>');
          var $removeBtn = $('<button type="button" class="btn btn-danger btn-xs"><i class="fa fa-times"></i> Remover</button>');
          $removeBtn.on('click', function() {
            if (window.confirm('¿Deseas remover al profesor ' + profesorNombre + ' de esta asignatura?')) {
              submitPost({
                remover_profesor: 1,
                asignatura_id: asignaturaId,
                profesor_id: profesorId
              });
            }
          });
          $pill.append($removeBtn);
          $container.append($pill);
        } else {
          $container.append('<p class="description-text"><em>No hay profesor asignado actualmente.</em></p>');
        }

        $('#modalGestionarProfesores').modal('show');
      };

      function parseCursos(raw) {
        if (!raw) {
          return [];
        }
        var items = String(raw).split(';;');
        var parsed = [];
        $.each(items, function(_, item) {
          if (!item) {
            return;
          }
          var parts = item.split('::');
          parsed.push({
            nombre: $.trim(parts[0] || ''),
            etiqueta: $.trim(parts[1] || parts[0] || '')
          });
        });
        return parsed;
      }

      window.gestionarCursos = function(button) {
        var $btn = $(button);
        var asignaturaId = $btn.data('asignaturaId');
        var asignaturaNombre = $btn.data('asignaturaNombre');
        var cursos = parseCursos($btn.data('cursos'));

        $('#modalCursoAsignaturaId').val(asignaturaId);
        $('#modalCursoAsignaturaNombre').text(asignaturaNombre || 'Sin nombre registrado');
        $('#modalCursoSelect').val('');

        var $container = $('#cursosActualesContainer');
        $container.empty();

        if (cursos.length) {
          $.each(cursos, function(_, curso) {
            var $pill = $('<div class="manage-pill"></div>');
            $pill.append('<div><strong>' + curso.etiqueta + '</strong><br><span class="mini-text">Curso activo</span></div>');
            var $removeBtn = $('<button type="button" class="btn btn-danger btn-xs"><i class="fa fa-times"></i> Remover</button>');
            $removeBtn.on('click', function() {
              if (window.confirm('¿Deseas desasignar la asignatura de ' + curso.etiqueta + '?')) {
                submitPost({
                  remover_curso: 1,
                  asignatura_id: asignaturaId,
                  curso_nombre: curso.nombre
                });
              }
            });
            $pill.append($removeBtn);
            $container.append($pill);
          });
        } else {
          $container.append('<p class="description-text"><em>Esta asignatura no tiene cursos asignados para el año vigente.</em></p>');
        }

        $('#modalGestionarCursos').modal('show');
      };

      window.confirmarEliminacion = function(nombreAsignatura, url) {
        if (window.confirm('¿Eliminar la asignatura "' + nombreAsignatura + '"? Esta acción no se puede deshacer.')) {
          window.location.href = url;
        }
      };
    })(jQuery);
  </script>
{% endif %}
{% endblock %}
