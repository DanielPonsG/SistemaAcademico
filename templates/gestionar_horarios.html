{% extends "index_master.html" %}
{% load static %}

{% block extra_css %}
<style>
  /* Premium Design for Schedule Management */
  .schedules-page {
    padding: 2rem;
    background-color: #f8f9fa;
    min-height: 100vh;
    font-family: 'Inter', sans-serif;
  }

  /* Header Section */
  .schedules-header {
    background: white;
    padding: 1.5rem 2rem;
    border-radius: 16px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .schedules-title h2 {
    font-size: 1.75rem;
    font-weight: 700;
    color: #1e293b;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .schedules-title h2 i {
    color: #6366f1;
  }

  .schedules-subtitle {
    color: #64748b;
    margin: 0.5rem 0 0;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .course-badge {
    background: #eef2ff;
    color: #6366f1;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.85rem;
  }

  .btn-back {
    background: white;
    color: #64748b;
    border: 1px solid #e2e8f0;
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    text-decoration: none;
  }

  .btn-back:hover {
    background: #f8fafc;
    color: #1e293b;
    border-color: #cbd5e1;
  }

  .btn-new-schedule {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.3s ease;
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
    text-decoration: none;
  }

  .btn-new-schedule:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(99, 102, 241, 0.3);
    color: white;
  }

  /* View Toggle */
  .view-toggle {
    background: #f1f5f9;
    padding: 4px;
    border-radius: 12px;
    display: inline-flex;
    margin-right: 1rem;
  }

  .view-toggle button {
    border: none;
    background: transparent;
    padding: 0.6rem 1.25rem;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    color: #64748b;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .view-toggle button.active {
    background: white;
    color: #1e293b;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  /* Calendar Container */
  .calendar-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    overflow: hidden;
    border: 1px solid #e2e8f0;
  }

  .calendar-container {
    display: grid;
    grid-template-columns: 60px repeat(5, 1fr);
    gap: 1px;
    background: #e2e8f0;
    height: 800px;
  }

  .calendar-col {
    background: #ffffff;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .calendar-header {
    background: #f8fafc;
    padding: 1rem 0.5rem;
    text-align: center;
    font-weight: 700;
    color: #1e293b;
    border-bottom: 1px solid #e2e8f0;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .events-wrapper {
    position: relative;
    flex: 1;
    background: white;
    background-image: linear-gradient(#f1f5f9 1px, transparent 1px);
    background-size: 100% 60px;
  }

  .time-slot-label {
    height: 60px;
    display: flex;
    align-items: start;
    justify-content: center;
    font-size: 0.75rem;
    color: #64748b;
    padding-top: 4px;
    font-weight: 500;
  }

  .calendar-event {
    position: absolute;
    left: 4px;
    right: 4px;
    background: #eef2ff;
    border-left: 3px solid #6366f1;
    border-radius: 6px;
    padding: 6px 8px;
    font-size: 0.75rem;
    color: #4338ca;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .calendar-event:hover {
    transform: scale(1.02) translateY(-2px);
    z-index: 20;
    background: #e0e7ff;
    box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.1);
  }

  .calendar-event .event-time {
    font-weight: 700;
    font-size: 0.7rem;
    margin-bottom: 2px;
    opacity: 0.9;
  }

  .calendar-event .event-title {
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.8rem;
    margin-bottom: 1px;
  }

  .calendar-event .event-prof {
    font-size: 0.7rem;
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* List View */
  .list-view-container {
    background: white;
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    padding: 1.5rem;
    overflow: hidden;
  }

  .table-custom {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-custom th {
    background: #f8fafc;
    padding: 1rem;
    font-weight: 600;
    color: #64748b;
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid #e2e8f0;
    text-align: left;
  }

  .table-custom td {
    padding: 1rem;
    vertical-align: middle;
    border-bottom: 1px solid #f1f5f9;
    color: #334155;
  }

  .badge-day {
    padding: 0.35rem 0.75rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.8rem;
    background: #eff6ff;
    color: #3b82f6;
  }

  .badge-subject {
    padding: 0.35rem 0.75rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.8rem;
    background: #f0fdf4;
    color: #166534;
  }

  .action-btn-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    margin-right: 0.25rem;
    background: transparent;
  }

  .action-btn-icon.edit { color: #3b82f6; background: #eff6ff; }
  .action-btn-icon.edit:hover { background: #3b82f6; color: white; }
  
  .action-btn-icon.delete { color: #ef4444; background: #fef2f2; }
  .action-btn-icon.delete:hover { background: #ef4444; color: white; }

  /* Modal Styles */
  .modal-content {
    border: none;
    border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
  }

  .modal-header {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    padding: 1.5rem;
    border-radius: 16px 16px 0 0;
  }

  .modal-title {
    font-weight: 700;
    color: #1e293b;
  }

  .form-control, .form-select {
    border-radius: 10px;
    border: 1px solid #e2e8f0;
    padding: 0.75rem 1rem;
    font-size: 0.95rem;
  }

  .form-control:focus, .form-select:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  @media (max-width: 768px) {
    .schedules-page { padding: 1rem; }
    .schedules-header { flex-direction: column; align-items: stretch; }
    .calendar-container { height: auto; display: block; }
    .calendar-col { min-height: 200px; margin-bottom: 1rem; border: 1px solid #e2e8f0; }
  }
</style>
{% endblock %}

{% block content %}
<div class="right_col" role="main">
  <div class="schedules-page">

    <!-- Header -->
    <div class="schedules-header">
      <div class="schedules-title">
        <h2><i class="fa fa-calendar-week"></i> Horario del Curso</h2>
        <div class="schedules-subtitle">
          <span class="course-badge">{{ curso.get_nivel_display }} {{ curso.paralelo }}</span>
          <span>Año {{ curso.anio }}</span>
        </div>
      </div>
      
      <div class="d-flex flex-wrap gap-3 align-items-center">
        <div class="view-toggle">
          <button class="active" onclick="switchView('calendar')" id="btn-calendar">
            <i class="fa fa-calendar"></i> Calendario
          </button>
          <button onclick="switchView('list')" id="btn-list">
            <i class="fa fa-list"></i> Lista
          </button>
        </div>

        <div class="d-flex gap-2">
          <a href="{% url 'seleccionar_curso_horarios' %}" class="btn-back">
            <i class="fa fa-arrow-left"></i> Volver
          </a>
          <button type="button" class="btn-new-schedule" data-toggle="modal" data-target="#crearHorarioModal">
            <i class="fa fa-plus"></i> Nuevo Horario
          </button>
        </div>
      </div>
    </div>

    <!-- Calendar View -->
    <div id="view-calendar" class="fade-in">
      <div class="calendar-card">
        <div class="calendar-container">
          <!-- Time Column -->
          <div class="calendar-col">
            <div class="calendar-header">Hora</div>
            <div class="events-wrapper" id="time-labels-container">
              <!-- Generated by JS -->
            </div>
          </div>

          <!-- Days Columns -->
          {% for codigo, nombre in dias_semana %}
            <div class="calendar-col" data-day="{{ codigo }}">
              <div class="calendar-header">{{ nombre }}</div>
              <div class="events-wrapper day-events-container" id="day-col-{{ codigo }}" data-day="{{ codigo }}">
                <!-- Events will be placed here -->
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <!-- List View -->
    <div id="view-list" style="display: none;">
      <div class="list-view-container">
        <div class="table-responsive">
          <table class="table-custom" id="tabla-horarios">
            <thead>
              <tr>
                <th>Día</th>
                <th>Bloque Horario</th>
                <th>Asignatura</th>
                <th>Profesor</th>
                <th class="text-right">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for horario in horarios %}
                <tr id="horario-{{ horario.id }}">
                  <td>
                    <span class="badge-day">{{ horario.get_dia_display }}</span>
                  </td>
                  <td class="fw-medium">
                    {{ horario.hora_inicio|time:"H:i" }} - {{ horario.hora_fin|time:"H:i" }}
                  </td>
                  <td>
                    <span class="badge-subject">
                      <i class="fa fa-book-open mr-1"></i>{{ horario.asignatura.nombre }}
                    </span>
                  </td>
                  <td>
                    <div class="d-flex align-items-center gap-2">
                      <div class="avatar-circle-sm" style="width: 24px; height: 24px; background: #eef2ff; color: #6366f1; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem;">
                        <i class="fa fa-user-tie"></i>
                      </div>
                      <span>{{ horario.profesor.get_nombre_completo }}</span>
                    </div>
                  </td>
                  <td class="text-right">
                    <button class="action-btn-icon edit" onclick="abrirModalEdicion('{{ horario.id }}')" title="Editar">
                      <i class="fa fa-pen"></i>
                    </button>
                    <button class="action-btn-icon delete" onclick="eliminarHorario('{{ horario.id }}')" title="Eliminar">
                      <i class="fa fa-trash"></i>
                    </button>
                  </td>
                </tr>
              {% empty %}
                <tr id="no-horarios">
                  <td colspan="5" class="text-center py-5">
                    <div class="text-muted">
                      <i class="fa fa-calendar-times fa-3x mb-3 opacity-50"></i>
                      <p class="mb-0 fw-medium">No hay horarios configurados.</p>
                    </div>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal Crear Horario -->
<div class="modal fade" id="crearHorarioModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-plus-circle mr-2"></i>Agregar Horario</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body p-4">
        <form id="form-crear-horario">
          {% csrf_token %}
          <input type="hidden" name="curso" value="{{ curso.id }}">

          <div class="form-group">
            <label class="form-label fw-bold text-dark">Día de la Semana</label>
            <select class="form-control" name="dia" id="create-dia" required>
              <option value="">Seleccionar día...</option>
              {% for codigo, nombre in dias_semana %}
                <option value="{{ codigo }}">{{ nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="row">
            <div class="col-md-6 form-group">
              <label class="form-label fw-bold text-dark">Hora Inicio</label>
              <input type="time" class="form-control" name="hora_inicio" required>
            </div>
            <div class="col-md-6 form-group">
              <label class="form-label fw-bold text-dark">Hora Fin</label>
              <input type="time" class="form-control" name="hora_fin" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label fw-bold text-dark">Asignatura</label>
            <select class="form-control" name="asignatura" required>
              <option value="">Seleccionar asignatura...</option>
              {% for asignatura in asignaturas %}
                <option value="{{ asignatura.id }}">{{ asignatura.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label fw-bold text-dark">Profesor</label>
            <select class="form-control" name="profesor" required>
              <option value="">Seleccionar profesor...</option>
              {% for profesor in profesores %}
                <option value="{{ profesor.id }}">{{ profesor.get_nombre_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mt-4 text-right">
            <button type="button" class="btn btn-light mr-2" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar Horario</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Horario -->
<div class="modal fade" id="editarHorarioModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa fa-edit mr-2"></i>Editar Horario</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body p-4">
        <form id="form-editar-horario">
          {% csrf_token %}
          <input type="hidden" name="horario_id" id="edit-horario-id">
          
          <div class="form-group">
            <label class="form-label fw-bold text-dark">Día de la Semana</label>
            <select class="form-control" name="dia" id="edit-dia" required>
              {% for codigo, nombre in dias_semana %}
                <option value="{{ codigo }}">{{ nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="row">
            <div class="col-md-6 form-group">
              <label class="form-label fw-bold text-dark">Hora Inicio</label>
              <input type="time" class="form-control" name="hora_inicio" id="edit-hora-inicio" required>
            </div>
            <div class="col-md-6 form-group">
              <label class="form-label fw-bold text-dark">Hora Fin</label>
              <input type="time" class="form-control" name="hora_fin" id="edit-hora-fin" required>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label fw-bold text-dark">Asignatura</label>
            <select class="form-control" name="asignatura" id="edit-asignatura" required>
              {% for asignatura in asignaturas %}
                <option value="{{ asignatura.id }}">{{ asignatura.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label class="form-label fw-bold text-dark">Profesor</label>
            <select class="form-control" name="profesor" id="edit-profesor" required>
              {% for profesor in profesores %}
                <option value="{{ profesor.id }}">{{ profesor.get_nombre_completo }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mt-4 text-right">
            <button type="button" class="btn btn-light mr-2" data-dismiss="modal">Cancelar</button>
            <button type="submit" class="btn btn-primary">Actualizar Horario</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Constants for Calendar Rendering
  const START_HOUR = 8;
  const END_HOUR = 18;
  const PIXELS_PER_HOUR = 60;

  // Data from Django
  const horarios = [
    {% for horario in horarios %}
    {
      id: "{{ horario.id }}",
      dia: "{{ horario.dia }}",
      hora_inicio: "{{ horario.hora_inicio|time:'H:i' }}",
      hora_fin: "{{ horario.hora_fin|time:'H:i' }}",
      asignatura: "{{ horario.asignatura.nombre }}",
      asignatura_id: "{{ horario.asignatura.id }}",
      profesor: "{{ horario.profesor.get_nombre_completo }}",
      profesor_id: "{{ horario.profesor.id }}",
      color: "#6366f1" // Default color
    },
    {% endfor %}
  ];

  document.addEventListener('DOMContentLoaded', function() {
    renderTimeLabels();
    renderEvents();
    setupForms();
  });

  function switchView(viewName) {
    document.getElementById('view-calendar').style.display = viewName === 'calendar' ? 'block' : 'none';
    document.getElementById('view-list').style.display = viewName === 'list' ? 'block' : 'none';
    
    document.getElementById('btn-calendar').classList.toggle('active', viewName === 'calendar');
    document.getElementById('btn-list').classList.toggle('active', viewName === 'list');
  }

  function renderTimeLabels() {
    const container = document.getElementById('time-labels-container');
    container.innerHTML = '';
    
    for (let h = START_HOUR; h <= END_HOUR; h++) {
      const div = document.createElement('div');
      div.className = 'time-slot-label';
      div.textContent = `${h}:00`;
      container.appendChild(div);
    }
  }

  function timeToMinutes(timeStr) {
    const [h, m] = timeStr.split(':').map(Number);
    return h * 60 + m;
  }

  function renderEvents() {
    // Clear existing events
    document.querySelectorAll('.day-events-container').forEach(el => el.innerHTML = '');

    const startMinutes = START_HOUR * 60;

    horarios.forEach(event => {
      const container = document.getElementById(`day-col-${event.dia}`);
      if (!container) return;

      const eventStart = timeToMinutes(event.hora_inicio);
      const eventEnd = timeToMinutes(event.hora_fin);
      const duration = eventEnd - eventStart;
      
      const top = ((eventStart - startMinutes) / 60) * PIXELS_PER_HOUR;
      const height = (duration / 60) * PIXELS_PER_HOUR;

      const el = document.createElement('div');
      el.className = 'calendar-event';
      el.style.top = `${top}px`;
      el.style.height = `${height}px`;
      el.onclick = () => abrirModalEdicion(event.id);
      
      el.innerHTML = `
        <div class="event-time">${event.hora_inicio} - ${event.hora_fin}</div>
        <div class="event-title">${event.asignatura}</div>
        <div class="event-prof">${event.profesor}</div>
      `;

      container.appendChild(el);
    });
  }

    // Form Handling
  function setupForms() {
    // Create Form
    document.getElementById('form-crear-horario').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      fetch("{% url 'ajax_crear_horario' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('¡Éxito!', 'Horario creado correctamente', 'success').then(() => location.reload());
        } else {
          Swal.fire('Error', data.error || 'No se pudo crear el horario', 'error');
        }
      });
    });

    // Edit Form
    document.getElementById('form-editar-horario').addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      
      fetch("{% url 'ajax_editar_horario' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          Swal.fire('¡Éxito!', 'Horario actualizado correctamente', 'success').then(() => location.reload());
        } else {
          Swal.fire('Error', data.error || 'No se pudo actualizar', 'error');
        }
      });
    });
  }  function abrirModalEdicion(id) {
    const horario = horarios.find(h => h.id == id);
    if (!horario) return;

    document.getElementById('edit-horario-id').value = horario.id;
    document.getElementById('edit-dia').value = horario.dia;
    document.getElementById('edit-hora-inicio').value = horario.hora_inicio;
    document.getElementById('edit-hora-fin').value = horario.hora_fin;
    document.getElementById('edit-asignatura').value = horario.asignatura_id;
    document.getElementById('edit-profesor').value = horario.profesor_id;
    
    $('#editarHorarioModal').modal('show');
  }
  
  function eliminarHorario(id) {
    Swal.fire({
      title: '¿Estás seguro?',
      text: "No podrás revertir esto",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#64748b',
      confirmButtonText: 'Sí, eliminar'
    }).then((result) => {
      if (result.isConfirmed) {
        const formData = new FormData();
        formData.append('horario_id', id);

        fetch("{% url 'ajax_eliminar_horario_nuevo' %}", {
          method: 'POST',
          body: formData,
          headers: {
            'X-CSRFToken': '{{ csrf_token }}'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            Swal.fire('Eliminado', 'El horario ha sido eliminado.', 'success').then(() => location.reload());
          } else {
            Swal.fire('Error', data.error || 'No se pudo eliminar.', 'error');
          }
        });
      }
    });
  }
</script>
{% endblock %}
