{% extends "index_master.html" %}
{% load static %}

{% block extra_css %}
<style>
  :root {
    --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
    --secondary-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
    --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
    --dark-bg: #0f172a;
    --card-bg: #ffffff;
    --text-main: #1e293b;
    --text-muted: #64748b;
    --border-color: #e2e8f0;
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --radius-lg: 1rem;
    --radius-xl: 1.5rem;
  }

  .professor-form-container {
    padding: 2rem;
    background-color: #f8fafc;
    min-height: 100vh;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }

  .form-card {
    background: var(--card-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border-color);
    box-shadow: var(--shadow-md);
    overflow: hidden;
    margin-bottom: 2rem;
    transition: all 0.3s ease;
  }

  .form-header {
    background: var(--dark-bg);
    padding: 2rem;
    color: white;
    position: relative;
    overflow: hidden;
    border-radius: var(--radius-xl);
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
  }

  .form-header::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background: radial-gradient(circle at 100% 0%, rgba(99, 102, 241, 0.2) 0%, transparent 50%);
    pointer-events: none;
  }

  .form-header h2 {
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(to right, #fff, #cbd5e1);
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-top: 0;
  }

  .btn-gradient-primary {
    background: var(--primary-gradient);
    border: none;
    color: white;
    padding: 0.6rem 1.25rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.9rem;
    transition: transform 0.2s, box-shadow 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
  }

  .btn-gradient-primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    color: white;
    text-decoration: none;
  }

  /* Calendar View Styles */
  .calendar-container {
    display: grid;
    grid-template-columns: 60px repeat(5, 1fr);
    gap: 1px;
    background: #e2e8f0;
    border: 1px solid #e2e8f0;
    border-radius: var(--radius-lg);
    overflow: hidden;
    height: 800px;
    /* Fixed height */
  }

  .calendar-col {
    background: #ffffff;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .calendar-header {
    background: #f8fafc;
    padding: 1rem 0.5rem;
    text-align: center;
    font-weight: 700;
    color: var(--text-main);
    border-bottom: 1px solid #e2e8f0;
    height: 50px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .events-wrapper {
    position: relative;
    flex: 1;
    background: white;
    /* Pattern for rows */
    background-image: linear-gradient(#f1f5f9 1px, transparent 1px);
    background-size: 100% 60px;
    /* Matches PIXELS_PER_HOUR */
  }

  .time-slot-label {
    height: 60px;
    display: flex;
    align-items: start;
    justify-content: center;
    font-size: 0.75rem;
    color: var(--text-muted);
    padding-top: 4px;
    font-weight: 500;
  }

  .calendar-event {
    position: absolute;
    left: 4px;
    right: 4px;
    background: rgba(99, 102, 241, 0.15);
    border-left: 3px solid #4f46e5;
    border-radius: 4px;
    padding: 6px 8px;
    font-size: 0.75rem;
    color: #4338ca;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 10;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .calendar-event:hover {
    transform: scale(1.02) translateY(-2px);
    z-index: 20;
    background: rgba(99, 102, 241, 0.25);
    box-shadow: 0 8px 16px -4px rgba(0, 0, 0, 0.1);
  }

  .calendar-event .event-time {
    font-weight: 700;
    font-size: 0.7rem;
    margin-bottom: 2px;
    opacity: 0.9;
  }

  .calendar-event .event-title {
    font-weight: 700;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-size: 0.8rem;
    margin-bottom: 1px;
  }

  .calendar-event .event-prof {
    font-size: 0.7rem;
    opacity: 0.8;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* List View Styles (Legacy) */
  .table-custom {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .table-custom th {
    background: #f8fafc;
    padding: 1rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border-bottom: 1px solid var(--border-color);
  }

  .table-custom td {
    padding: 1rem;
    vertical-align: middle;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-main);
  }

  .badge-day {
    padding: 0.35rem 0.75rem;
    border-radius: 0.5rem;
    font-weight: 600;
    font-size: 0.8rem;
    background: #eff6ff;
    color: #3b82f6;
    border: 1px solid #dbeafe;
  }

  .badge-subject {
    padding: 0.35rem 0.75rem;
    border-radius: 999px;
    font-weight: 600;
    font-size: 0.8rem;
    background: #f0fdf4;
    color: #166534;
    border: 1px solid #dcfce7;
  }

  /* Modal & Form */
  .modal-content {
    border: none;
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
  }

  .modal-header {
    background: var(--dark-bg);
    color: white;
    border-bottom: none;
    padding: 1.5rem;
    border-radius: var(--radius-lg) var(--radius-lg) 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* Fix for BS3 modal close button in dark header */
  .modal-header .close {
    color: white;
    opacity: 0.8;
    text-shadow: none;
    margin-top: 0;
  }

  .modal-header .close:hover {
    opacity: 1;
  }

  .form-control,
  .form-select {
    border-radius: 0.5rem;
    border: 1px solid var(--border-color);
    padding: 0.6rem 1rem;
    font-size: 0.95rem;
    height: auto;
    /* Fix BS3 height issue */
    box-shadow: none;
  }

  .form-control:focus,
  .form-select:focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  /* View Toggle Switch */
  .view-toggle {
    background: #f1f5f9;
    padding: 4px;
    border-radius: 8px;
    display: inline-flex;
  }

  .view-toggle button {
    border: none;
    background: transparent;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--text-muted);
    transition: all 0.2s;
  }

  .view-toggle button.active {
    background: white;
    color: var(--text-main);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  /* Toast Notification */
  .toast-container {
    position: fixed;
    top: 1rem;
    right: 1rem;
    z-index: 1050;
  }

  .toast-custom {
    background: white;
    border-radius: 0.75rem;
    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    border-left: 4px solid #10b981;
    padding: 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 300px;
    animation: slideIn 0.3s ease-out;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }

    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  /* BS3 Grid Fixes for Flexbox */
  .d-flex {
    display: flex;
  }

  .flex-column {
    flex-direction: column;
  }

  .justify-content-between {
    justify-content: space-between;
  }

  .align-items-center {
    align-items: center;
  }

  .align-items-end {
    align-items: flex-end;
  }

  .gap-2 {
    gap: 0.5rem;
  }

  .gap-3 {
    gap: 1rem;
  }

  .me-2 {
    margin-right: 0.5rem;
  }

  .mb-0 {
    margin-bottom: 0;
  }

  .mb-2 {
    margin-bottom: 0.5rem;
  }

  .mb-3 {
    margin-bottom: 1rem;
  }

  .mb-4 {
    margin-bottom: 1.5rem;
  }

  .p-0 {
    padding: 0;
  }

  .p-4 {
    padding: 1.5rem;
  }

  .text-end {
    text-align: right;
  }

  .rounded-pill {
    border-radius: 50rem;
  }

  .fw-bold {
    font-weight: 700;
  }

  .fw-medium {
    font-weight: 500;
  }

  .fs-5 {
    font-size: 1.25rem;
  }

  .text-white-50 {
    color: rgba(255, 255, 255, 0.5);
  }

  /* Fix for BS3 modal backdrop */
  .modal-backdrop {
    z-index: 1040;
  }

  .modal {
    z-index: 1050;
  }
</style>
{% endblock %}

{% block content %}
<div class="professor-form-container">
  <!-- Header -->
  <div class="form-header">
    <div class="d-flex justify-content-between align-items-center relative" style="z-index: 2;">
      <div>
        <div class="d-flex align-items-center gap-3 mb-2">
          <span class="badge bg-white/10 text-white border border-white/20 rounded-pill px-3 py-1 backdrop-blur">
            {{ curso.get_nivel_display }} {{ curso.paralelo }}
          </span>
          <span class="text-white-50">|</span>
          <span class="text-white-50">Año {{ curso.anio }}</span>
        </div>
        <h2>
          <i class="fas fa-calendar-week me-2"></i>Horario del Curso
        </h2>
        <p class="text-white-50 mb-0">Gestiona los bloques horarios de forma visual</p>
      </div>
      <div class="d-flex flex-column align-items-end gap-3">
        <div class="d-flex gap-2">
          <a href="{% url 'seleccionar_curso_horarios' %}" class="btn btn-outline-light backdrop-blur"
            style="border-radius: 0.5rem; display: inline-flex; align-items: center;">
            <i class="fas fa-arrow-left me-2"></i>Volver
          </a>
          <!-- BS3: data-toggle and data-target -->
          <button type="button" class="btn-gradient-primary" id="btn-nuevo-horario" data-toggle="modal"
            data-target="#crearHorarioModal">
            <i class="fas fa-plus"></i> Nuevo Horario
          </button>
        </div>
        <div class="view-toggle">
          <button class="active" onclick="switchView('calendar')" id="btn-calendar">
            <i class="fas fa-calendar me-2"></i>Calendario
          </button>
          <button onclick="switchView('list')" id="btn-list">
            <i class="fas fa-list me-2"></i>Lista
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calendar View -->
  <div id="view-calendar" class="fade-in">
    <div class="form-card p-0">
      <div class="calendar-container">
        <!-- Time Column -->
        <div class="calendar-col">
          <div class="calendar-header">Hora</div>
          <div class="events-wrapper" id="time-labels-container">
            <!-- Generated by JS -->
          </div>
        </div>

        <!-- Days Columns -->
        {% for codigo, nombre in dias_semana %}
        <div class="calendar-col" data-day="{{ codigo }}">
          <div class="calendar-header">{{ nombre }}</div>
          <div class="events-wrapper day-events-container" id="day-col-{{ codigo }}" data-day="{{ codigo }}">
            <!-- Events will be placed here -->
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- List View -->
  <div id="view-list" style="display: none;">
    <div class="form-card">
      <div class="table-responsive">
        <table class="table-custom" id="tabla-horarios">
          <thead>
            <tr>
              <th>Día</th>
              <th>Bloque Horario</th>
              <th>Asignatura</th>
              <th>Profesor</th>
              <th class="text-end">Acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for horario in horarios %}
            <tr id="horario-{{ horario.id }}">
              <td>
                <span class="badge-day">{{ horario.get_dia_display }}</span>
              </td>
              <td class="fw-medium">
                {{ horario.hora_inicio|time:"H:i" }} - {{ horario.hora_fin|time:"H:i" }}
              </td>
              <td>
                <span class="badge-subject">
                  <i class="fas fa-book-open me-1"></i>{{ horario.asignatura.nombre }}
                </span>
              </td>
              <td>
                <div class="d-flex align-items-center gap-2">
                  <div class="bg-light rounded-circle p-1 text-primary">
                    <i class="fas fa-user-tie"></i>
                  </div>
                  <span class="text-main">{{ horario.profesor.get_nombre_completo }}</span>
                </div>
              </td>
              <td class="text-end">
                <button class="action-btn edit" onclick="abrirModalEdicion('{{ horario.id }}')" title="Editar"
                  style="border:none; background:none; color:#3b82f6;">
                  <i class="fas fa-pen"></i>
                </button>
                <button class="action-btn delete" onclick="eliminarHorario('{{ horario.id }}')" title="Eliminar"
                  style="border:none; background:none; color:#ef4444;">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% empty %}
            <tr id="no-horarios">
              <td colspan="5" class="text-center py-5">
                <div class="text-muted">
                  <i class="fas fa-calendar-times fa-3x mb-3 opacity-50"></i>
                  <p class="mb-0 fw-medium">No hay horarios configurados.</p>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modals (Moved outside container for better z-index handling) -->
<!-- Modal Crear Horario -->
<div class="modal fade" id="crearHorarioModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h5 class="modal-title" style="margin:0;"><i class="fas fa-plus-circle me-2"></i>Agregar Horario</h5>
      </div>
      <div class="modal-body p-4">
        <form id="form-crear-horario">
          {% csrf_token %}
          <input type="hidden" name="curso" value="{{ curso.id }}">

          <div class="mb-3">
            <label class="form-label fw-bold text-dark">Día de la Semana</label>
            <select class="form-control" name="dia" id="create-dia" required>
              <option value="">Seleccionar día...</option>
              {% for codigo, nombre in dias_semana %}
              <option value="{{ codigo }}">{{ nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-xs-6">
              <label class="form-label fw-bold text-dark">Hora Inicio</label>
              <input type="time" class="form-control" name="hora_inicio" required>
            </div>
            <div class="col-xs-6">
              <label class="form-label fw-bold text-dark">Hora Fin</label>
              <input type="time" class="form-control" name="hora_fin" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold text-dark">Asignatura</label>
            <select class="form-control" name="asignatura" id="select-asignatura-crear" required
              onchange="filtrarProfesores('crear')">
              <option value="">Seleccionar asignatura...</option>
              {% for asignatura in asignaturas %}
              <option value="{{ asignatura.id }}">{{ asignatura.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold text-dark">Profesor</label>
            <select class="form-control" name="profesor" id="select-profesor-crear" required disabled>
              <option value="">Primero seleccione una asignatura...</option>
            </select>
          </div>

          <div class="d-grid" style="display:block; width:100%;">
            <button type="submit" class="btn btn-gradient-primary" style="width:100%; justify-content: center;">
              Guardar Horario
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Modal Editar Horario -->
<div class="modal fade" id="editarHorarioModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h5 class="modal-title" style="margin:0;"><i class="fas fa-edit me-2"></i>Editar Horario</h5>
      </div>
      <div class="modal-body p-4">
        <form id="form-editar-horario">
          {% csrf_token %}
          <input type="hidden" name="horario_id" id="edit-horario-id">
          <input type="hidden" name="curso" value="{{ curso.id }}">

          <div class="mb-3">
            <label class="form-label fw-bold text-dark">Día de la Semana</label>
            <select class="form-control" name="dia" id="edit-dia" required>
              {% for codigo, nombre in dias_semana %}
              <option value="{{ codigo }}">{{ nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-xs-6">
              <label class="form-label fw-bold text-dark">Hora Inicio</label>
              <input type="time" class="form-control" name="hora_inicio" id="edit-hora-inicio" required>
            </div>
            <div class="col-xs-6">
              <label class="form-label fw-bold text-dark">Hora Fin</label>
              <input type="time" class="form-control" name="hora_fin" id="edit-hora-fin" required>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label fw-bold text-dark">Asignatura</label>
            <select class="form-control" name="asignatura" id="select-asignatura-editar" required
              onchange="filtrarProfesores('editar')">
              {% for asignatura in asignaturas %}
              <option value="{{ asignatura.id }}">{{ asignatura.nombre }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-4">
            <label class="form-label fw-bold text-dark">Profesor</label>
            <select class="form-control" name="profesor" id="select-profesor-editar" required>
              <!-- Se llena dinámicamente -->
            </select>
          </div>

          <div class="d-grid" style="display:block; width:100%;">
            <button type="submit" class="btn btn-gradient-primary" style="width:100%; justify-content: center;">
              Actualizar Horario
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toast-container"></div>

{% endblock %}

{% block extra_js %}
<script>
  const START_HOUR = 7;
  const END_HOUR = 19;
  const PIXELS_PER_HOUR = 60;

  const horariosData = [
    {% for h in horarios %}
    {
      id: "{{ h.id }}",
      dia: "{{ h.dia }}",
      hora_inicio: "{{ h.hora_inicio|time:'H:i' }}",
      hora_fin: "{{ h.hora_fin|time:'H:i' }}",
      asignatura: "{{ h.asignatura.nombre }}",
      profesor: "{{ h.profesor.get_nombre_completo|default:'Sin asignar' }}"
    },
    {% endfor %}
  ];

  function timeToDecimal(time) {
    const [hours, minutes] = time.split(':').map(Number);
    return hours + (minutes / 60);
  }

  function renderEvents() {
    // Limpiar eventos previos visualmente si es necesario (opcional)
    document.querySelectorAll('.calendar-event').forEach(el => el.remove());

    horariosData.forEach(h => {
      const start = timeToDecimal(h.hora_inicio);
      const end = timeToDecimal(h.hora_fin);
      const duration = end - start;

      // Calcular posición
      const top = (start - START_HOUR) * PIXELS_PER_HOUR;
      const height = duration * PIXELS_PER_HOUR;

      const eventEl = document.createElement('div');
      eventEl.className = 'calendar-event';
      eventEl.style.top = `${top}px`;
      eventEl.style.height = `${height}px`;
      eventEl.innerHTML = `
<div class="event-time">${h.hora_inicio} - ${h.hora_fin}</div>
<div class="event-title">${h.asignatura}</div>
<div class="event-prof">${h.profesor}</div>
`;
      eventEl.onclick = (e) => {
        e.stopPropagation();
        abrirModalEdicion(h.id);
      };

      const col = document.getElementById(`day-col-${h.dia}`);
      if (col) col.appendChild(eventEl);
    });
  }

  function switchView(view) {
    const calendarView = document.getElementById('view-calendar');
    const listView = document.getElementById('view-list');

    if (calendarView) calendarView.style.display = view === 'calendar' ? 'block' : 'none';
    if (listView) listView.style.display = view === 'list' ? 'block' : 'none';

    document.getElementById('btn-calendar')?.classList.toggle('active', view === 'calendar');
    document.getElementById('btn-list')?.classList.toggle('active', view === 'list');
  }

  // --- Lógica Existente (AJAX, Toasts) ---
  const profesoresPorAsignatura = {
        {% for asignatura in asignaturas %}
  "{{ asignatura.id }}": [
    {% for profesor in profesores %}
  {% if asignatura in profesor.asignaturas.all %}
  { "id": "{{ profesor.id }}", "nombre": "{{ profesor.get_nombre_completo }}" },
  {% endif %}
  {% endfor %}
            ],
  {% endfor %}
    };

  function showToast(message, type = 'success') {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = 'toast-custom';
    toast.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle text-success' : 'fa-exclamation-circle text-danger'} fs-5"></i>
            <span class="fw-medium text-dark">${message}</span>
        `;
    container.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideIn 0.3s ease-in reverse';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function filtrarProfesores(modo, profesorSeleccionadoId = null) {
    const asignaturaSelect = document.getElementById(`select-asignatura-${modo}`);
    const profesorSelect = document.getElementById(`select-profesor-${modo}`);

    if (!asignaturaSelect || !profesorSelect) return;

    const asignaturaId = asignaturaSelect.value;

    profesorSelect.innerHTML = '<option value="">Seleccionar profesor...</option>';
    profesorSelect.disabled = true;

    if (asignaturaId && profesoresPorAsignatura[asignaturaId]) {
      const profs = profesoresPorAsignatura[asignaturaId];
      if (profs.length > 0) {
        profs.forEach(prof => {
          const option = document.createElement('option');
          option.value = prof.id;
          option.textContent = prof.nombre;
          if (profesorSeleccionadoId && prof.id == profesorSeleccionadoId) {
            option.selected = true;
          }
          profesorSelect.appendChild(option);
        });
        profesorSelect.disabled = false;
      } else {
        const option = document.createElement('option');
        option.textContent = "No hay profesores asignados";
        profesorSelect.appendChild(option);
      }
    }
  }

  // Obtener CSRF token de las cookies si es necesario, o del input hidden
  function getCsrfToken() {
    const input = document.querySelector('[name=csrfmiddlewaretoken]');
    return input ? input.value : '';
  }

  // Crear Horario
  const formCrear = document.getElementById('form-crear-horario');
  if (formCrear) {
    formCrear.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      if (formData.get('hora_inicio') >= formData.get('hora_fin')) {
        showToast('La hora de inicio debe ser menor a la hora de fin', 'error');
        return;
      }

      fetch("{% url 'ajax_crear_horario' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCsrfToken()
        }
      })
        .then(response => {
          if (!response.ok) throw new Error('Network response was not ok');
          return response.json();
        })
        .then(data => {
          if (data.success) {
            showToast('Horario creado exitosamente');
            setTimeout(() => location.reload(), 1000);
          } else {
            let errorMsg = 'Error al crear horario';
            if (data.errors) {
              errorMsg = Object.values(data.errors).flat().join(', ');
            }
            showToast(errorMsg, 'error');
          }
        })
        .catch(error => {
          console.error('Error:', error);
          showToast('Error de conexión o servidor', 'error');
        });
    });
  }

  // Abrir Modal Edición
  function abrirModalEdicion(horarioId) {
    fetch(`{% url 'ajax_obtener_horario' %}?horario_id=${horarioId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          const h = data.horario;
          document.getElementById('edit-horario-id').value = h.id;
          document.getElementById('edit-dia').value = h.dia;
          document.getElementById('edit-hora-inicio').value = h.hora_inicio;
          document.getElementById('edit-hora-fin').value = h.hora_fin;
          document.getElementById('select-asignatura-editar').value = h.asignatura_id;

          filtrarProfesores('editar', h.profesor_id);

          // BS3 Modal Show
          $('#editarHorarioModal').modal('show');
        } else {
          showToast('No se pudo cargar la información del horario', 'error');
        }
      })
      .catch(err => showToast('Error al cargar horario', 'error'));
  }

  // Editar Horario
  const formEditar = document.getElementById('form-editar-horario');
  if (formEditar) {
    formEditar.addEventListener('submit', function (e) {
      e.preventDefault();
      const formData = new FormData(this);

      if (formData.get('hora_inicio') >= formData.get('hora_fin')) {
        showToast('La hora de inicio debe ser menor a la hora de fin', 'error');
        return;
      }

      fetch("{% url 'ajax_editar_horario' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCsrfToken()
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('Horario actualizado exitosamente');
            setTimeout(() => location.reload(), 1000);
          } else {
            showToast('Error al actualizar horario', 'error');
          }
        })
        .catch(error => showToast('Error de conexión', 'error'));
    });
  }

  // Eliminar Horario
  function eliminarHorario(horarioId) {
    if (confirm('¿Estás seguro de eliminar este horario?')) {
      const formData = new FormData();
      formData.append('horario_id', horarioId);
      
      fetch("{% url 'ajax_eliminar_horario_nuevo' %}", {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
          'X-CSRFToken': getCsrfToken()
        }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showToast('Horario eliminado exitosamente');
            // Eliminar visualmente
            const row = document.getElementById(`horario-${horarioId}`);
            if (row) row.remove();
            setTimeout(() => location.reload(), 500);
          } else {
            showToast('Error al eliminar horario', 'error');
          }
        })
        .catch(err => showToast('Error al eliminar', 'error'));
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Generate time labels
    const timeContainer = document.getElementById('time-labels-container');
    if (timeContainer) {
      for (let i = START_HOUR; i < END_HOUR; i++) {
        const div = document.createElement('div');
        div.className = 'time-slot-label';
        div.textContent = `${i}:00`;
        timeContainer.appendChild(div);
      }
    }
    
    renderEvents();
  });
</script>
{% endblock %}