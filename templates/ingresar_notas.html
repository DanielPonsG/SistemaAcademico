{% extends "index_master.html" %}
{% load static %}
{% load widget_tweaks %}

{% block extra_css %}
<style>
    /* Modern Reset & Variables */
    :root {
        --primary: #4f46e5;
        --primary-dark: #4338ca;
        --secondary: #64748b;
        --success: #10b981;
        --danger: #ef4444;
        --warning: #f59e0b;
        --info: #3b82f6;
        --dark: #0f172a;
        --light: #f8fafc;
        --white: #ffffff;
        --border: #e2e8f0;
        --text-main: #1e293b;
        --text-muted: #64748b;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --radius: 0.75rem;
    }

    /* Layout & Typography */
    .modern-card {
        background: var(--white);
        border-radius: var(--radius);
        box-shadow: var(--shadow-md);
        border: 1px solid var(--border);
        margin-bottom: 2rem;
        overflow: hidden;
    }

    .card-header-custom {
        background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%);
        padding: 1.5rem 2rem;
        color: white;
        position: relative;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-header-custom::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary), var(--info));
    }

    .card-body-custom {
        padding: 2rem;
    }

    /* Form Elements */
    .form-label {
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .form-control, .form-select {
        display: block;
        width: 100%;
        padding: 0.6rem 1rem;
        font-size: 0.95rem;
        color: var(--text-main);
        background-color: #fff;
        border: 1px solid var(--border);
        border-radius: 0.5rem;
        box-shadow: var(--shadow-sm);
        transition: all 0.2s;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary);
        outline: 0;
        box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    /* Buttons */
    .btn-custom {
        padding: 0.6rem 1.2rem;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: all 0.2s;
        border: none;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .btn-primary-custom {
        background-color: var(--primary);
        color: white;
        box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
    }

    .btn-primary-custom:hover {
        background-color: var(--primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 6px 8px -1px rgba(79, 70, 229, 0.3);
        color: white;
    }

    .btn-secondary-custom {
        background-color: white;
        color: var(--text-muted);
        border: 1px solid var(--border);
    }

    .btn-secondary-custom:hover {
        background-color: #f8fafc;
        color: var(--text-main);
        border-color: #cbd5e1;
    }
    
    .btn-success-custom {
        background-color: var(--success);
        color: white;
    }
    
    .btn-success-custom:hover {
        background-color: #059669;
        color: white;
    }
    
    .btn-warning-custom {
        background-color: var(--warning);
        color: white;
    }
    
    .btn-warning-custom:hover {
        background-color: #d97706;
        color: white;
    }

    /* Table Styling */
    .table-custom {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .table-custom th {
        background-color: #f8fafc;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        letter-spacing: 0.05em;
        padding: 1rem;
        border-bottom: 1px solid var(--border);
    }
    
    .table-custom td {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        vertical-align: middle;
    }
    
    .table-custom tr:last-child td {
        border-bottom: none;
    }
    
    .table-custom tbody tr:hover {
        background-color: #f8fafc;
    }

    /* Empty States */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-muted);
    }
    
    .empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .empty-state h5 {
        font-weight: 700;
        color: var(--text-main);
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="right_col" role="main">
    
    <!-- Messages -->
    {% if messages %}
    <div class="container-fluid mb-4">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm border-0" role="alert" style="border-radius: 0.75rem;">
            <div class="d-flex align-items-center">
                {% if message.tags == 'success' %}
                    <i class="fas fa-check-circle me-2 fs-5"></i>
                {% elif message.tags == 'error' %}
                    <i class="fas fa-exclamation-circle me-2 fs-5"></i>
                {% else %}
                    <i class="fas fa-info-circle me-2 fs-5"></i>
                {% endif %}
                <div>{{ message }}</div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="container-fluid">
        
        <!-- Selection Card -->
        <div class="modern-card">
            <div class="card-header-custom py-3">
                <h5 class="mb-0 fw-bold"><i class="fas fa-filter me-2"></i>Seleccionar Curso y Asignatura</h5>
            </div>
            <div class="card-body-custom">
                <form method="get" class="row g-4">
                    <!-- Selección de Curso -->
                    <div class="col-md-6">
                        <label for="curso_id" class="form-label">Curso</label>
                        {% if not cursos_disponibles %}
                            <div class="alert alert-warning mb-0 py-2">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <div>
                                        <strong>No hay cursos disponibles.</strong>
                                        <div class="small">No tienes cursos asignados para el año {{ anio_actual }}.</div>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-school text-muted"></i></span>
                            <select name="curso_id" id="curso_id" class="form-select border-start-0 ps-0" onchange="this.form.submit()">
                                <option value="">-- Selecciona un curso --</option>
                                {% for curso in cursos_disponibles %}
                                    <option value="{{ curso.id }}" {% if curso_seleccionado and curso.id == curso_seleccionado.id %}selected{% endif %}>
                                    {{ curso.get_nivel_display }}{{ curso.paralelo }} - {{ curso.anio }}
                                    {% if curso.profesor_jefe %}
                                        (Prof. Jefe: {{ curso.profesor_jefe.primer_nombre }} {{ curso.profesor_jefe.apellido_paterno }})
                                    {% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <button class="btn btn-outline-secondary" type="submit" title="Cargar curso">
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Selección de Asignatura -->
                    {% if curso_seleccionado and asignaturas_disponibles %}
                    <div class="col-md-6">
                        <label for="asignatura_id" class="form-label">Asignatura</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0"><i class="fas fa-book text-muted"></i></span>
                            <select name="asignatura_id" id="asignatura_id" class="form-select border-start-0 ps-0" onchange="this.form.submit()">
                                <option value="">-- Selecciona una asignatura --</option>
                                {% for asignatura in asignaturas_disponibles %}
                                    <option value="{{ asignatura.id }}" {% if asignatura_seleccionada and asignatura.id == asignatura_seleccionada.id %}selected{% endif %}>
                                    {{ asignatura.nombre }}
                                    {% if asignatura.codigo_asignatura %}
                                        ({{ asignatura.codigo_asignatura }})
                                    {% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        <input type="hidden" name="curso_id" value="{{ curso_seleccionado.id }}">
                    </div>
                    {% endif %}
                </form>
                
                <!-- Información adicional -->
                {% if curso_seleccionado and not asignaturas_disponibles %}
                <div class="alert alert-warning mt-4 mb-0 border-0 shadow-sm">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle fs-4 me-3"></i>
                            <div>
                                <h6 class="fw-bold mb-1">No hay asignaturas disponibles</h6>
                                <div class="small">
                                    {% if user_type == 'profesor' %}
                                        No tienes asignaturas asignadas en este curso.
                                    {% else %}
                                        Este curso no tiene asignaturas asignadas.
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% if user_type == 'director' or user_type == 'administrador' %}
                        <button type="button" class="btn btn-warning-custom btn-sm" onclick="mostrarAsignarAsignaturas()">
                            <i class="fas fa-plus me-1"></i>Asignar Asignaturas
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Panel expandible para asignar asignaturas -->
                    {% if user_type == 'director' or user_type == 'administrador' %}
                    <div id="panelAsignarAsignaturas" style="display: none;" class="mt-3 pt-3 border-top border-warning-subtle">
                        <h6 class="fw-bold mb-3"><i class="fas fa-book me-1"></i>Asignar Asignaturas Existentes</h6>
                        <form method="post" action="{% url 'asignar_asignaturas_curso' %}">
                            {% csrf_token %}
                            <input type="hidden" name="curso_id" value="{{ curso_seleccionado.id }}">
                            
                            <div class="row g-2">
                                <div class="col-md-8">
                                    <select name="asignaturas_ids" class="form-select" multiple size="4">
                                        {% load custom_filters %}
                                        {% get_asignaturas_no_asignadas_curso curso_seleccionado as asignaturas_disponibles_para_asignar %}
                                        {% for asignatura in asignaturas_disponibles_para_asignar %}
                                            <option value="{{ asignatura.id }}">
                                                {{ asignatura.nombre }} ({{ asignatura.codigo_asignatura }})
                                                {% if asignatura.get_profesores_display %}
                                                    - Prof: {% for prof in asignatura.get_profesores_display %}{{ prof.primer_nombre }} {{ prof.apellido_paterno }}{% if not forloop.last %}, {% endif %}{% endfor %}
                                                {% endif %}
                                            </option>
                                        {% empty %}
                                            <option disabled>No hay asignaturas disponibles para asignar</option>
                                        {% endfor %}
                                    </select>
                                    <small class="form-text text-muted">Mantén Ctrl presionado para seleccionar múltiples</small>
                                </div>
                                <div class="col-md-4">
                                    <button type="submit" class="btn btn-warning-custom w-100 mb-2">
                                        <i class="fas fa-plus me-1"></i>Asignar Seleccionadas
                                    </button>
                                    <button type="button" class="btn btn-outline-warning w-100" onclick="asignarTodasLasAsignaturas()">
                                        <i class="fas fa-plus-circle me-1"></i>Asignar Todas
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    {% endif %}
                </div>
                {% elif curso_seleccionado and asignatura_seleccionada %}
                <div class="alert alert-success mt-4 mb-0 border-0 shadow-sm d-flex align-items-center">
                    <i class="fas fa-check-circle fs-4 me-3"></i>
                    <div>
                        <h6 class="fw-bold mb-1">Listo para ingresar notas</h6>
                        <div class="small">
                            Curso: {{ curso_seleccionado.get_nivel_display }}{{ curso_seleccionado.paralelo }} | 
                            Asignatura: {{ asignatura_seleccionada.nombre }} | 
                            Estudiantes: {{ estudiantes_curso_asignatura.count }}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Formulario de Notas -->
        {% if curso_seleccionado and asignatura_seleccionada and estudiantes_curso_asignatura %}
        <div class="modern-card">
            <div class="card-header-custom">
                <div>
                    <h5 class="mb-1 fw-bold"><i class="fas fa-clipboard-list me-2"></i>Registrar Notas</h5>
                    <small class="opacity-75">
                        {{ asignatura_seleccionada.nombre }} - {{ curso_seleccionado.get_nivel_display }}{{ curso_seleccionado.paralelo }}
                    </small>
                </div>
                <div class="badge bg-white text-primary px-3 py-2 rounded-pill">
                    <i class="fas fa-users me-1"></i> {{ estudiantes_curso_asignatura.count }} Estudiantes
                </div>
            </div>
            <div class="card-body-custom">
                <form method="post">
                    {% csrf_token %}
                    <input type="hidden" name="curso_id" value="{{ curso_seleccionado.id }}">
                    <input type="hidden" name="asignatura_id" value="{{ asignatura_seleccionada.id }}">
                    
                    <!-- Información de la evaluación (común para todos) -->
                    <div class="bg-light p-4 rounded-3 mb-4 border">
                        <h6 class="fw-bold text-primary mb-3"><i class="fas fa-cog me-2"></i>Configuración General</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="nombre_evaluacion_general" class="form-label">Nombre de la Evaluación</label>
                                <input type="text" id="nombre_evaluacion_general" class="form-control" 
                                        placeholder="Ej: Primer Parcial, Quiz 1..."
                                        onchange="copyEvaluationName()">
                                <small class="text-muted">Se copiará a todos los estudiantes</small>
                            </div>
                            <div class="col-md-6">
                                <label for="descripcion_general" class="form-label">Descripción (Opcional)</label>
                                <input type="text" id="descripcion_general" class="form-control" 
                                        placeholder="Descripción breve..."
                                        onchange="copyDescription()">
                                <small class="text-muted">Se copiará a todos los estudiantes</small>
                            </div>
                        </div>
                    </div>

                    <!-- Notas por estudiante -->
                    <div class="table-responsive mb-4">
                        <table class="table-custom">
                            <thead>
                                <tr>
                                    <th width="25%">Estudiante</th>
                                    <th width="20%">Evaluación</th>
                                    <th width="12%">Puntaje (1-7)</th>
                                    <th width="12%">% (0-100)</th>
                                    <th width="15%">Detalle</th>
                                    <th width="16%">Descripción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for inscripcion in estudiantes_curso_asignatura %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-circle bg-primary-subtle text-primary me-3 d-flex align-items-center justify-content-center rounded-circle" style="width: 36px; height: 36px; font-weight: bold;">
                                                {{ inscripcion.estudiante.primer_nombre|slice:":1" }}{{ inscripcion.estudiante.apellido_paterno|slice:":1" }}
                                            </div>
                                            <div>
                                                <div class="fw-bold text-dark">{{ inscripcion.estudiante.primer_nombre }} {{ inscripcion.estudiante.apellido_paterno }}</div>
                                                <small class="text-muted">{{ inscripcion.estudiante.codigo_estudiante }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <input type="text" name="nombre_evaluacion_{{ inscripcion.id }}" 
                                                class="form-control nombre-evaluacion" 
                                                placeholder="Nombre" required>
                                    </td>
                                    <td>
                                        <input type="number" name="puntaje_{{ inscripcion.id }}" 
                                                class="form-control text-center fw-bold" step="0.1" min="1.0" max="7.0"
                                                placeholder="-" required>
                                    </td>
                                    <td>
                                        <input type="number" name="porcentaje_{{ inscripcion.id }}" 
                                                class="form-control text-center" step="1" min="0" max="100"
                                                placeholder="-" value="0">
                                    </td>
                                    <td>
                                        <input type="text" name="detalle_{{ inscripcion.id }}" 
                                                class="form-control" 
                                                placeholder="Opcional">
                                    </td>
                                    <td>
                                        <input type="text" name="descripcion_{{ inscripcion.id }}" 
                                                class="form-control descripcion-evaluacion"
                                                placeholder="Opcional">
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Botones de acción -->
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 pt-3 border-top">
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-custom btn-secondary-custom" onclick="fillAllFields()">
                                <i class="fas fa-fill me-1"></i> Llenar Todo
                            </button>
                            <button type="button" class="btn btn-custom btn-secondary-custom" onclick="clearAllFields()">
                                <i class="fas fa-eraser me-1"></i> Limpiar
                            </button>
                            <button type="button" class="btn btn-custom btn-secondary-custom" onclick="fillSampleGrades()">
                                <i class="fas fa-magic me-1"></i> Ejemplo
                            </button>
                        </div>
                        <button type="submit" class="btn btn-custom btn-primary-custom px-4">
                            <i class="fas fa-save me-2"></i> Guardar Calificaciones
                        </button>
                    </div>
                    
                    <!-- Información adicional -->
                    <div class="mt-4 p-3 bg-info-subtle border border-info-subtle rounded-3">
                        <div class="row">
                            <div class="col-md-6 mb-2 mb-md-0">
                                <div class="d-flex">
                                    <i class="fas fa-info-circle text-info mt-1 me-2"></i>
                                    <small class="text-muted">
                                        <strong>Sistema de Calificación:</strong><br>
                                        • 1.0 - 3.9: Reprobado<br>
                                        • 4.0 - 5.9: Aprobado<br>
                                        • 6.0 - 7.0: Excelente
                                    </small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-flex">
                                    <i class="fas fa-lightbulb text-warning mt-1 me-2"></i>
                                    <small class="text-muted">
                                        <strong>Tips:</strong><br>
                                        • Usa los campos generales para copiar datos comunes<br>
                                        • El porcentaje es opcional (0-100)
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
        {% elif curso_seleccionado and asignatura_seleccionada %}
        <div class="modern-card">
            <div class="card-body-custom empty-state">
                <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
                    <i class="fas fa-users-slash text-muted mb-0" style="font-size: 2.5rem;"></i>
                </div>
                <h5>No hay estudiantes disponibles</h5>
                <p class="mb-3">
                    No se encontraron estudiantes del curso <strong>{{ curso_seleccionado.get_nivel_display }}{{ curso_seleccionado.paralelo }}</strong> 
                    inscritos en <strong>{{ asignatura_seleccionada.nombre }}</strong>.
                </p>
                {% if user_type == 'profesor' %}
                <div class="alert alert-warning d-inline-block text-start">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    Como profesor, solo puedes ver estudiantes de grupos donde tú eres el profesor responsable.
                </div>
                {% endif %}
            </div>
        </div>
        {% elif curso_seleccionado %}
        <div class="modern-card">
            <div class="card-body-custom empty-state">
                <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
                    <i class="fas fa-book text-primary mb-0" style="font-size: 2.5rem;"></i>
                </div>
                <h5>Selecciona una asignatura</h5>
                <p>
                    Has seleccionado el curso <strong>{{ curso_seleccionado.get_nivel_display }}{{ curso_seleccionado.paralelo }}</strong>. 
                    Ahora elige una asignatura para mostrar los estudiantes.
                </p>
            </div>
        </div>
        {% else %}
        <div class="modern-card">
            <div class="card-body-custom empty-state">
                <div class="bg-light rounded-circle d-inline-flex p-4 mb-3">
                    <i class="fas fa-school text-primary mb-0" style="font-size: 2.5rem;"></i>
                </div>
                <h5>Selecciona un curso</h5>
                <p>
                    {% if user_type == 'director' or user_type == 'administrador' %}
                        Elige un curso para ver las asignaturas disponibles y sus estudiantes.
                    {% else %}
                        Elige uno de tus cursos para ver las asignaturas que impartes.
                    {% endif %}
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- JavaScript -->
<script>
function mostrarAsignarAsignaturas() {
  const panel = document.getElementById('panelAsignarAsignaturas');
  if (panel.style.display === 'none') {
    panel.style.display = 'block';
  } else {
    panel.style.display = 'none';
  }
}

function asignarTodasLasAsignaturas() {
  const select = document.querySelector('select[name="asignaturas_ids"]');
  for (let i = 0; i < select.options.length; i++) {
    if (!select.options[i].disabled) {
      select.options[i].selected = true;
    }
  }
  
  if (confirm('¿Deseas asignar TODAS las asignaturas disponibles a este curso?')) {
    select.form.submit();
  }
}

function copyEvaluationName() {
  const generalName = document.getElementById('nombre_evaluacion_general').value;
  const nameInputs = document.querySelectorAll('.nombre-evaluacion');
  nameInputs.forEach(input => {
    if (!input.value) {
      input.value = generalName;
    }
  });
}

function copyDescription() {
  const generalDesc = document.getElementById('descripcion_general').value;
  const descInputs = document.querySelectorAll('.descripcion-evaluacion');
  descInputs.forEach(input => {
    if (!input.value) {
      input.value = generalDesc;
    }
  });
}

function fillAllFields() {
  const generalName = document.getElementById('nombre_evaluacion_general').value;
  const generalDesc = document.getElementById('descripcion_general').value;
  
  if (!generalName) {
    alert('Por favor, ingresa primero el nombre general de la evaluación.');
    return;
  }
  
  // Llenar nombres de evaluación
  document.querySelectorAll('.nombre-evaluacion').forEach(input => {
    input.value = generalName;
  });
  
  // Llenar descripciones si hay una general
  if (generalDesc) {
    document.querySelectorAll('.descripcion-evaluacion').forEach(input => {
      input.value = generalDesc;
    });
  }
}

function clearAllFields() {
  if (confirm('¿Estás seguro de que quieres limpiar todos los campos?')) {
    document.getElementById('nombre_evaluacion_general').value = '';
    document.getElementById('descripcion_general').value = '';
    
    document.querySelectorAll('.nombre-evaluacion, .descripcion-evaluacion').forEach(input => {
      input.value = '';
    });
    
    document.querySelectorAll('input[type="number"], input[name*="detalle"]').forEach(input => {
      input.value = '';
    });
  }
}

function fillSampleGrades() {
  if (confirm('¿Deseas rellenar con datos de ejemplo? Esto sobrescribirá los campos actuales.')) {
    // Rellenar campos generales
    document.getElementById('nombre_evaluacion_general').value = 'Evaluación de Ejemplo';
    document.getElementById('descripcion_general').value = 'Evaluación de prueba del sistema';
    
    // Llenar datos automáticamente
    fillAllFields();
    
    // Rellenar puntajes de ejemplo (entre 4.0 y 7.0)
    document.querySelectorAll('input[name*="puntaje_"]').forEach((input, index) => {
      const randomGrade = (Math.random() * 3 + 4).toFixed(1); // Entre 4.0 y 7.0
      input.value = randomGrade;
    });
    
    // Rellenar porcentajes de ejemplo
    document.querySelectorAll('input[name*="porcentaje_"]').forEach((input, index) => {
      const puntaje = parseFloat(input.parentNode.parentNode.querySelector('input[name*="puntaje_"]').value);
      const porcentaje = Math.round(((puntaje - 1) / 6) * 100); // Convertir a porcentaje
      input.value = porcentaje;
    });
    
    // Rellenar detalles de ejemplo
    document.querySelectorAll('input[name*="detalle_"]').forEach((input, index) => {
      const puntaje = parseFloat(input.parentNode.parentNode.querySelector('input[name*="puntaje_"]').value);
      if (puntaje >= 6.0) {
        input.value = 'Excelente';
      } else if (puntaje >= 5.0) {
        input.value = 'Muy bueno';
      } else if (puntaje >= 4.0) {
        input.value = 'Bueno';
      } else {
        input.value = 'Necesita mejorar';
      }
    });
  }
}

// Validación en tiempo real
document.addEventListener('DOMContentLoaded', function() {
  // Validar puntajes
  document.querySelectorAll('input[name*="puntaje_"]').forEach(input => {
    input.addEventListener('blur', function() {
      const value = parseFloat(this.value);
      if (this.value && (value < 1.0 || value > 7.0)) {
        this.classList.add('is-invalid');
        if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('invalid-feedback')) {
          const feedback = document.createElement('div');
          feedback.className = 'invalid-feedback';
          feedback.textContent = 'El puntaje debe estar entre 1.0 y 7.0';
          this.parentNode.appendChild(feedback);
        }
      } else {
        this.classList.remove('is-invalid');
        const feedback = this.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.remove();
      }
    });
  });
  
  // Validar porcentajes
  document.querySelectorAll('input[name*="porcentaje_"]').forEach(input => {
    input.addEventListener('blur', function() {
      const value = parseFloat(this.value);
      if (this.value && (value < 0 || value > 100)) {
        this.classList.add('is-invalid');
        if (!this.nextElementSibling || !this.nextElementSibling.classList.contains('invalid-feedback')) {
          const feedback = document.createElement('div');
          feedback.className = 'invalid-feedback';
          feedback.textContent = 'El porcentaje debe estar entre 0 y 100';
          this.parentNode.appendChild(feedback);
        }
      } else {
        this.classList.remove('is-invalid');
        const feedback = this.parentNode.querySelector('.invalid-feedback');
        if (feedback) feedback.remove();
      }
    });
  });
});
</script>
{% endblock %}