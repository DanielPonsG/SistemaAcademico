{% extends "index_master.html" %}

{% block extra_css %}
<style>
  .calendar-screen { padding: 24px 18px 32px; background: linear-gradient(180deg, #eef3fb 0%, #f8fafc 45%, #ffffff 100%); min-height: calc(100vh - 120px); }
  .calendar-header { background: #fff; border-radius: 20px; padding: 22px 26px; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08); border: 1px solid rgba(148, 163, 184, 0.18); display: flex; align-items: center; justify-content: space-between; gap: 20px; margin-bottom: 20px; }
  .calendar-header .info { display: flex; align-items: center; gap: 18px; }
  .calendar-header .icon-badge { width: 66px; height: 66px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 32px; background: linear-gradient(135deg, #6366f1, #4338ca); color: #fff; box-shadow: 0 12px 30px rgba(67, 56, 202, 0.28); }
  .calendar-title { margin: 0; font-size: 28px; font-weight: 700; color: #0f172a; }
  .calendar-subtitle { margin: 4px 0 0; color: #475569; font-size: 14px; }
  .calendar-header .actions { text-align: right; }
  .calendar-header .btn-primary { border-radius: 14px; padding: 12px 22px; font-weight: 600; background: linear-gradient(135deg, #22c55e, #15803d); border: none; color: #fff; box-shadow: 0 12px 30px rgba(34, 197, 94, 0.28); }
  .calendar-header .btn-primary i { margin-right: 6px; }
  .calendar-header small { display: block; color: #64748b; margin-top: 12px; }
  .metrics-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
  .metric-card { background: #fff; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08); padding: 18px; display: flex; align-items: center; gap: 14px; position: relative; overflow: hidden; }
  .metric-card::before { content: ""; position: absolute; inset: 0; opacity: 0.08; background: radial-gradient(circle at top right, #6366f1, transparent 60%); }
  .metric-icon { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #4338ca; background: rgba(99, 102, 241, 0.15); z-index: 1; }
  .metric-card.metric-green .metric-icon { background: rgba(16, 185, 129, 0.18); color: #047857; }
  .metric-card.metric-amber .metric-icon { background: rgba(251, 191, 36, 0.22); color: #b45309; }
  .metric-card.metric-slate .metric-icon { background: rgba(148, 163, 184, 0.22); color: #475569; }
  .metric-content { z-index: 1; }
  .metric-label { text-transform: uppercase; font-size: 11px; letter-spacing: 0.08em; color: #94a3b8; margin-bottom: 4px; }
  .metric-value { font-size: 30px; font-weight: 700; color: #0f172a; margin: 0; }
  .metric-note { margin: 4px 0 0; color: #64748b; font-size: 13px; }
  .surface-card { background: #fff; border-radius: 18px; border: 1px solid #dbe1eb; box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08); margin-bottom: 20px; }
  .surface-card .card-header { padding: 18px 22px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); border-radius: 18px 18px 0 0; background: linear-gradient(135deg, #6366f1, #4338ca); color: #fff; }
  .surface-card .card-body { padding: 22px; }
  .surface-card .alert { margin-bottom: 0; border-radius: 12px; }
  .calendar-layout { display: grid; grid-template-columns: minmax(0, 2fr) minmax(0, 1fr); gap: 20px; }
  .panel { background: #fff; border-radius: 18px; border: 1px solid #dbe1eb; box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08); display: flex; flex-direction: column; overflow: hidden; }
  .panel-header { padding: 18px 22px; border-bottom: 1px solid rgba(148, 163, 184, 0.2); display: flex; align-items: center; justify-content: space-between; gap: 12px; }
  .panel-header h3 { margin: 0; font-size: 18px; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 10px; }
  .panel-header h3 i { color: #6366f1; }
  .panel-body { padding: 22px; flex: 1; }
  .calendar-controls { display: flex; align-items: center; gap: 12px; }
  .calendar-controls button { border: none; border-radius: 10px; padding: 8px 14px; background: rgba(99, 102, 241, 0.12); color: #4338ca; font-weight: 600; }
  .calendar-controls button:hover { background: rgba(99, 102, 241, 0.2); }
  .calendar-controls .current-month { font-weight: 700; color: #0f172a; font-size: 16px; min-width: 150px; text-align: center; }
  .calendar-table { width: 100%; border-collapse: collapse; font-size: 13px; }
  .calendar-table thead th { text-transform: uppercase; font-size: 11px; letter-spacing: 0.06em; color: #475569; text-align: center; padding: 10px 4px; background: rgba(99, 102, 241, 0.12); }
  .calendar-table td { height: 92px; vertical-align: top; padding: 8px; border: 1px solid #e2e8f0; position: relative; background: #fff; }
  .calendar-table td.empty { background: #f8fafc; }
  .calendar-table td .day-number { font-weight: 600; color: #334155; margin-bottom: 6px; display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 8px; }
  .calendar-table td.today .day-number { background: linear-gradient(135deg, #2563eb, #1d4ed8); color: #fff; }
  .event-chip { display: block; font-size: 11px; border-radius: 10px; padding: 3px 8px; margin-bottom: 4px; color: #fff; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
  .event-chip:hover { opacity: 0.9; }
  .timeline { max-height: 620px; overflow-y: auto; padding-right: 6px; }
  .timeline::-webkit-scrollbar { width: 6px; }
  .timeline::-webkit-scrollbar-thumb { background: rgba(99, 102, 241, 0.45); border-radius: 10px; }
  .timeline-item { border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 14px; padding: 16px; margin-bottom: 14px; transition: transform 0.2s ease, box-shadow 0.2s ease; background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), transparent); cursor: pointer; }
  .timeline-item:last-child { margin-bottom: 0; }
  .timeline-item:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12); }
  .timeline-item h5 { margin: 0 0 6px; color: #1f2937; font-weight: 700; }
  .timeline-meta { font-size: 12px; color: #64748b; margin: 0; }
  .timeline-tag { display: inline-flex; align-items: center; gap: 6px; border-radius: 999px; padding: 4px 12px; font-size: 11px; font-weight: 600; color: #fff; }
  .empty-timeline { text-align: center; padding: 48px 12px; color: #64748b; }
  .empty-timeline i { font-size: 44px; margin-bottom: 14px; color: rgba(99, 102, 241, 0.38); }
  .empty-timeline h4 { font-weight: 600; color: #1f2937; margin-bottom: 8px; }
  @media (max-width: 1200px) { .calendar-layout { grid-template-columns: 1fr; } }
  @media (max-width: 768px) { .calendar-screen { padding: 18px 12px 28px; } .calendar-header { flex-direction: column; align-items: stretch; text-align: center; } .calendar-header .info { justify-content: center; } .calendar-header .actions { text-align: center; width: 100%; } .calendar-header .btn-primary { width: 100%; } .calendar-controls { justify-content: center; flex-wrap: wrap; } }
</style>
{% endblock %}

{% block content %}
<div class="right_col" role="main">
  <div class="container-fluid calendar-screen">

    <div class="calendar-header">
      <div class="info">
        <div class="icon-badge"><i class="fa fa-calendar-alt"></i></div>
        <div>
          <h1 class="calendar-title">Calendario académico</h1>
          <p class="calendar-subtitle">Bienvenido {{ user.first_name|default:user.username }}<span class="label label-default" style="margin-left: 8px; background: rgba(148, 163, 184, 0.18); color: #0f172a; border-radius: 999px; padding: 4px 10px; font-size: 11px; text-transform: uppercase;">{{ user_type|capfirst }}</span></p>
          <p class="calendar-subtitle"><i class="fa fa-user"></i> Rol asignado en la plataforma</p>
        </div>
      </div>
      <div class="actions">
        {% if puede_crear_eventos %}
          <button type="button" class="btn btn-primary" onclick="abrirModalEvento()"><i class="fa fa-plus"></i> Nuevo evento</button>
        {% endif %}
        <small id="currentDateTime"></small>
      </div>
    </div>

    <div class="metrics-row">
      <div class="metric-card">
        <div class="metric-icon"><i class="fa fa-calendar-check"></i></div>
        <div class="metric-content">
          <span class="metric-label">Eventos totales</span>
          <p class="metric-value">{{ eventos.count }}</p>
          <p class="metric-note">Registros calendarizados en el sistema</p>
        </div>
      </div>
      <div class="metric-card metric-green">
        <div class="metric-icon"><i class="fa fa-calendar-day"></i></div>
        <div class="metric-content">
          <span class="metric-label">Hoy</span>
          <p class="metric-value">{{ eventos_count.hoy|default:0 }}</p>
          <p class="metric-note">Eventos programados para la fecha actual</p>
        </div>
      </div>
      <div class="metric-card metric-amber">
        <div class="metric-icon"><i class="fa fa-calendar-week"></i></div>
        <div class="metric-content">
          <span class="metric-label">Semana</span>
          <p class="metric-value">{{ eventos_count.semana|default:0 }}</p>
          <p class="metric-note">Planificado dentro de la semana en curso</p>
        </div>
      </div>
      <div class="metric-card metric-slate">
        <div class="metric-icon"><i class="fa fa-user-shield"></i></div>
        <div class="metric-content">
          <span class="metric-label">Permisos</span>
          <p class="metric-value">{% if puede_crear_eventos %}Administrador{% else %}Consulta{% endif %}</p>
          <p class="metric-note">Capacidades según tu perfil</p>
        </div>
      </div>
    </div>

    {% if user_type == 'apoderado' and estudiantes_a_cargo %}
      <div class="surface-card">
        <div class="card-header">
          <h4 style="margin:0; font-weight:600;"><i class="fa fa-filter"></i> Filtrar calendario por estudiante</h4>
        </div>
        <div class="card-body">
          <div class="row" style="gap: 16px;">
            <div class="col-md-6 col-sm-12">
              <label class="form-label">Seleccionar estudiante</label>
              <select class="form-control" id="filtro-estudiante" onchange="filtrarPorEstudiante()">
                <option value="">Ver todos los eventos</option>
                {% for estudiante in estudiantes_a_cargo %}
                  <option value="{{ estudiante.id }}" {% if estudiante.id|stringformat:"s" == estudiante_id %}selected{% endif %}>
                    {{ estudiante.get_nombre_completo }}
                    {% with curso_actual=estudiante.get_curso_actual %}
                      {% if curso_actual %} - {{ curso_actual.nombre }}{% endif %}
                    {% endwith %}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 col-sm-12">
              {% if estudiante_seleccionado %}
                <div class="alert alert-info">
                  <i class="fa fa-info-circle"></i>
                  <strong class="d-block">Mostrando eventos para {{ estudiante_seleccionado.get_nombre_completo }}</strong>
                  {% with curso_actual=estudiante_seleccionado.get_curso_actual %}
                    {% if curso_actual %}
                      <small>Curso: {{ curso_actual.nombre }}</small>
                    {% endif %}
                  {% endwith %}
                </div>
              {% else %}
                <div class="alert alert-secondary">
                  <i class="fa fa-calendar"></i>
                  <strong class="d-block">Vista general</strong>
                  <small>Mostrando eventos de todos los estudiantes a cargo.</small>
                </div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="calendar-layout">
      <div class="panel">
        <div class="panel-header">
          <h3><i class="fa fa-calendar"></i> Calendario de eventos</h3>
          <div class="calendar-controls">
            <button type="button" onclick="mesAnterior()"><i class="fa fa-chevron-left"></i></button>
            <span id="mes-actual" class="current-month">Mes actual</span>
            <button type="button" onclick="mesSiguiente()"><i class="fa fa-chevron-right"></i></button>
          </div>
        </div>
        <div class="panel-body">
          <div id="calendar-simple">
            <div class="table-responsive">
              <table class="calendar-table">
                <thead>
                  <tr>
                    <th>Dom</th>
                    <th>Lun</th>
                    <th>Mar</th>
                    <th>Mié</th>
                    <th>Jue</th>
                    <th>Vie</th>
                    <th>Sáb</th>
                  </tr>
                </thead>
                <tbody id="calendar-body">
                  <!-- Se completa con JavaScript -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-header">
          <h3><i class="fa fa-list"></i> Próximos eventos</h3>
          <span class="text-muted small">{{ eventos.count }} registro{{ eventos.count|pluralize }}</span>
        </div>
        <div class="panel-body">
          {% if eventos %}
            <div class="timeline">
              {% for evento in eventos|slice:":12" %}
                <div class="timeline-item" onclick="mostrarDetalleEvento({{ evento.id }}, '{{ evento.titulo|escapejs }}', '{{ evento.fecha|date:"j F Y" }}', '{{ evento.descripcion|default:""|escapejs }}', '{{ evento.get_tipo_evento_display|escapejs }}')">
                  <div class="d-flex justify-content-between align-items-start">
                    <div>
                      <h5>{{ evento.titulo }}</h5>
                      <p class="timeline-meta"><i class="fa fa-calendar"></i> {{ evento.fecha|date:"l, j" }} de {{ evento.fecha|date:"F" }}</p>
                      {% if evento.hora_inicio %}
                        <p class="timeline-meta"><i class="fa fa-clock"></i> {{ evento.hora_inicio|time:"H:i" }}{% if evento.hora_fin %} - {{ evento.hora_fin|time:"H:i" }}{% endif %}</p>
                      {% endif %}
                      {% if evento.descripcion %}
                        <p class="timeline-meta" style="margin-top: 6px; color: #4b5563;">{{ evento.descripcion|truncatewords:14 }}</p>
                      {% endif %}
                    </div>
                    <span class="timeline-tag" style="background: {{ evento.color_por_tipo|default:'#2563eb' }};"><i class="fa fa-bookmark"></i> {{ evento.get_tipo_evento_display }}</span>
                  </div>
                  {% if puede_crear_eventos %}
                    <div class="mt-3 text-right">
                      <button class="btn btn-danger btn-xs" onclick="event.stopPropagation(); eliminarEvento({{ evento.id }}, '{{ evento.titulo|escapejs }}')"><i class="fa fa-trash"></i> Eliminar</button>
                    </div>
                  {% endif %}
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-timeline">
              <i class="fa fa-calendar-times"></i>
              <h4>No hay eventos programados</h4>
              <p>Cuando se creen eventos aparecerán listados en este panel.</p>
              {% if puede_crear_eventos %}
                <button class="btn btn-primary btn-sm" onclick="abrirModalEvento()"><i class="fa fa-plus"></i> Crear evento</button>
              {% endif %}
            </div>
          {% endif %}
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal Nuevo Evento -->
<div class="modal fade" id="modalNuevoEvento" tabindex="-1" role="dialog" aria-labelledby="modalNuevoEventoLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white" style="background: linear-gradient(135deg, #6366f1, #4338ca); color: white;">
        <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1; color: white;">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="modalNuevoEventoLabel"><i class="fa fa-calendar-plus-o me-2"></i> Nuevo Evento</h4>
      </div>
      <div class="modal-body">
        <form id="formNuevoEvento">
          {% csrf_token %}
          <div class="row">
            <div class="col-md-8 form-group">
              <label class="control-label fw-bold">Título del evento *</label>
              <input type="text" name="titulo" class="form-control" required placeholder="Ej: Reunión de Apoderados">
            </div>
            <div class="col-md-4 form-group">
              <label class="control-label fw-bold">Fecha *</label>
              <input type="date" name="fecha" class="form-control" required>
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 form-group">
              <label class="control-label fw-bold">Hora inicio</label>
              <input type="time" name="hora_inicio" class="form-control">
            </div>
            <div class="col-md-6 form-group">
              <label class="control-label fw-bold">Hora fin</label>
              <input type="time" name="hora_fin" class="form-control">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 form-group">
              <label class="control-label fw-bold">Tipo de evento</label>
              <select name="tipo_evento" class="form-control">
                {% for tipo_val, tipo_label in tipos_evento %}
                <option value="{{ tipo_val }}">{{ tipo_label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 form-group">
              <label class="control-label fw-bold">Prioridad</label>
              <select name="prioridad" class="form-control">
                {% for prio_val, prio_label in prioridades %}
                <option value="{{ prio_val }}" {% if prio_val == 'media' %}selected{% endif %}>{{ prio_label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label class="control-label fw-bold">Descripción</label>
            <textarea name="descripcion" class="form-control" rows="3" placeholder="Detalles adicionales del evento..."></textarea>
          </div>
          
          <div class="form-group">
            <label class="control-label fw-bold">Dirigido a</label>
            <div class="radio">
              <label>
                <input type="radio" name="dirigido_a" value="todos" checked onchange="toggleCursosModal(false)"> Todos los cursos
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="dirigido_a" value="solo_profesores" onchange="toggleCursosModal(false)"> Solo profesores
              </label>
            </div>
            <div class="radio">
              <label>
                <input type="radio" name="dirigido_a" value="solo_apoderados" onchange="toggleCursosModal(false)"> Solo apoderados
              </label>
            </div>
            {% if cursos %}
            <div class="radio">
              <label>
                <input type="radio" name="dirigido_a" value="cursos_especificos" onchange="toggleCursosModal(true)"> Cursos específicos
              </label>
            </div>
            <div id="modalCursosEspecificos" class="well" style="display: none; margin-top: 10px; max-height: 150px; overflow-y: auto;">
              <div class="row">
                {% for curso in cursos %}
                <div class="col-md-6">
                  <div class="checkbox">
                    <label>
                      <input type="checkbox" name="cursos_especificos" value="{{ curso.id }}">
                      {{ curso.nivel }} {{ curso.paralelo }}
                    </label>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" onclick="guardarEvento()">Guardar Evento</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Detalle Evento -->
<div class="modal fade" id="modalDetalleEvento" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="detalleTitulo">Titulo del Evento</h4>
      </div>
      <div class="modal-body">
        <p><strong>Fecha:</strong> <span id="detalleFecha"></span></p>
        <p><strong>Tipo:</strong> <span id="detalleTipo" class="label label-info"></span></p>
        <hr>
        <p><strong>Descripción:</strong></p>
        <p id="detalleDescripcion"></p>
      </div>
      <div class="modal-footer">
        {% if puede_crear_eventos %}
        <a href="#" id="btnEditarEvento" class="btn btn-warning"><i class="fa fa-pencil"></i> Editar</a>
        <button type="button" id="btnEliminarEvento" class="btn btn-danger"><i class="fa fa-trash"></i> Eliminar</button>
        {% endif %}
        <button type="button" class="btn btn-default" data-dismiss="modal">Cerrar</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  console.log('Inicializando calendario alternativo...');

    function updateDateTime() {
        var now = new Date();
        var options = {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        };
        var dateTimeElement = document.getElementById('currentDateTime');
        if (dateTimeElement) {
            dateTimeElement.textContent = now.toLocaleDateString('es-ES', options);
        }
    }

    updateDateTime();
    setInterval(updateDateTime, 60000);

    var nombresMeses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    var hoy = new Date();
    var mesActual = hoy.getMonth();
    var anioActual = hoy.getFullYear();
    var hoyNormalizado = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate());

    var eventosRaw = {{ eventos_json|safe|default:"[]" }};
    var eventosNormalizados = Array.isArray(eventosRaw) ? eventosRaw.map(function(evento) {
        var fechaEvento = new Date(evento.start);
        var fechaNormalizada = new Date(fechaEvento.getFullYear(), fechaEvento.getMonth(), fechaEvento.getDate());
        return {
            id: evento.id,
            titulo: evento.title,
            fecha: fechaNormalizada,
            descripcion: (evento.description || ''),
            color: evento.backgroundColor || '#6366f1',
            tipo: (evento.extendedProps && evento.extendedProps.tipoOriginal) ? evento.extendedProps.tipoOriginal : (evento.tipo || 'general'),
            etiquetaTipo: (evento.extendedProps && evento.extendedProps.tipo) ? evento.extendedProps.tipo : 'Evento',
            fechaTexto: fechaNormalizada.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })
        };
    }) : [];

    function generarCalendario() {
        var mesTexto = nombresMeses[mesActual] + ' ' + anioActual;
        var mesActualEl = document.getElementById('mes-actual');
        if (mesActualEl) {
            mesActualEl.textContent = mesTexto;
        }

        var cuerpoCalendario = document.getElementById('calendar-body');
        if (!cuerpoCalendario) {
          console.warn('No se encontró el cuerpo del calendario.');
            return;
        }
        cuerpoCalendario.innerHTML = '';

        var primerDiaMes = new Date(anioActual, mesActual, 1);
        var primerDiaSemana = primerDiaMes.getDay();
        var diasEnMes = new Date(anioActual, mesActual + 1, 0).getDate();
        var dia = 1;

        for (var fila = 0; fila < 6; fila++) {
            var filaEl = document.createElement('tr');

            for (var col = 0; col < 7; col++) {
                var celda = document.createElement('td');

                if ((fila === 0 && col < primerDiaSemana) || dia > diasEnMes) {
                    celda.classList.add('empty');
                    filaEl.appendChild(celda);
                    continue;
                }

                var fechaCelda = new Date(anioActual, mesActual, dia);
                if (fechaCelda.getTime() === hoyNormalizado.getTime()) {
                    celda.classList.add('today');
                }

                var numeroDia = document.createElement('span');
                numeroDia.className = 'day-number';
                numeroDia.textContent = dia;
                celda.appendChild(numeroDia);

                var eventosDia = eventosNormalizados.filter(function(evento) {
                    return evento.fecha.getFullYear() === fechaCelda.getFullYear() &&
                           evento.fecha.getMonth() === fechaCelda.getMonth() &&
                           evento.fecha.getDate() === fechaCelda.getDate();
                });

                eventosDia.forEach(function(evento) {
                    var chip = document.createElement('span');
                    chip.className = 'event-chip';
                    chip.textContent = evento.titulo.length > 22 ? evento.titulo.substring(0, 22) + '...' : evento.titulo;
                    chip.style.backgroundColor = evento.color;
                    chip.title = evento.etiquetaTipo + ' • ' + evento.fechaTexto;
                    chip.addEventListener('click', function(ev) {
                      ev.stopPropagation();
                      window.mostrarDetalleEvento(evento.id, evento.titulo, evento.fechaTexto, evento.descripcion, evento.etiquetaTipo);
                    });
                    celda.appendChild(chip);
                });

                filaEl.appendChild(celda);
                dia++;
            }

            cuerpoCalendario.appendChild(filaEl);

            if (dia > diasEnMes) {
                break;
            }
        }

        console.log('Calendario generado para', mesTexto);
    }

    window.mesAnterior = function() {
        mesActual--;
        if (mesActual < 0) {
            mesActual = 11;
            anioActual--;
        }
        generarCalendario();
    };

    window.mesSiguiente = function() {
        mesActual++;
        if (mesActual > 11) {
            mesActual = 0;
            anioActual++;
        }
        generarCalendario();
    };

    window.mostrarDetalleEvento = function(id, titulo, fecha, descripcion, tipo) {
        $('#detalleTitulo').text(titulo);
        $('#detalleFecha').text(fecha);
        $('#detalleDescripcion').text(descripcion || 'Sin descripción');
        $('#detalleTipo').text(tipo || 'Evento');
        
        // Update Edit/Delete buttons
        var btnEditar = $('#btnEditarEvento');
        var btnEliminar = $('#btnEliminarEvento');
        
        if (btnEditar.length) {
            btnEditar.attr('href', '/calendario/editar/' + id + '/');
        }
        
        if (btnEliminar.length) {
            // Unbind previous click handlers to avoid multiple deletions
            btnEliminar.off('click').on('click', function() {
                eliminarEvento(id, titulo);
            });
        }
        
        $('#modalDetalleEvento').modal('show');
    };

    window.abrirModalEvento = function() {
        $('#modalNuevoEvento').modal('show');
    };

    window.toggleCursosModal = function(mostrar) {
        var container = document.getElementById('modalCursosEspecificos');
        if (container) {
            container.style.display = mostrar ? 'block' : 'none';
        }
    };

    window.guardarEvento = function() {
        var form = document.getElementById('formNuevoEvento');
        var formData = new FormData(form);
        
        // Validar campos requeridos
        if (!formData.get('titulo') || !formData.get('fecha')) {
            alert('Por favor complete el título y la fecha.');
            return;
        }

        $.ajax({
            url: "{% url 'agregar_evento' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    $('#modalNuevoEvento').modal('hide');
                    // Recargar para mostrar el nuevo evento
                    window.location.reload();
                } else {
                    alert('Error: ' + (response.error || 'No se pudo crear el evento'));
                }
            },
            error: function() {
                alert('Error de conexión. Inténtalo nuevamente.');
            }
        });
    };

    window.filtrarPorEstudiante = function() {
        var selectEstudiante = document.getElementById('filtro-estudiante');
        if (!selectEstudiante) return;

        var estudianteId = selectEstudiante.value;
        var url = new URL(window.location.href);

        if (estudianteId) {
            url.searchParams.set('estudiante_id', estudianteId);
        } else {
            url.searchParams.delete('estudiante_id');
        }

        window.location.href = url.toString();
    };

    generarCalendario();
});

{% if puede_crear_eventos %}
function eliminarEvento(eventoId, titulo) {
    if (!confirm('¿Estás seguro de eliminar el evento "' + titulo + '"?')) {
        return;
    }

    if (typeof $ === 'undefined') {
        alert('Acción no disponible sin soporte de jQuery.');
        return;
    }

    $.ajax({
        url: '/calendario/eliminar/' + eventoId + '/',
        type: 'POST',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            if (response.success) {
                // alert('Evento eliminado correctamente'); // Removed alert to be less intrusive or use a toast
                window.location.reload();
            } else {
                alert('Error: ' + (response.error || 'No se pudo eliminar el evento'));
            }
        },
        error: function() {
              alert('Error de conexión. Inténtalo nuevamente.');
        }
    });
}
{% endif %}
</script>
{% endblock %}
