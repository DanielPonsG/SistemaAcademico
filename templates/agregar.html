{% extends "index_master.html" %}
{% load widget_tweaks %}

{% block content %}
<div class="right_col" role="main">
  <div class="container-fluid">
    <div class="row justify-content-center">
      <div class="col-lg-7 col-md-9">
        <div class="card border-0 shadow-sm p-4">
          <div class="card-header bg-light border-0 mb-3 px-4 py-4 bg-gradient-header text-white" style="border-radius: 18px 18px 0 0; background: linear-gradient(90deg, #3a8dde 0%, #6a5af9 100%); box-shadow: 0 2px 8px rgba(58,141,222,0.08);">
            <h4 class="mb-0 fw-bold d-flex align-items-center" style="font-size: 2rem;">
              <i class="fas {% if es_edicion %}fa-user-edit{% else %}fa-user-plus{% endif %} me-3" style="font-size: 2.2rem; color: #fff;"></i>
              <span style="color: #fff;">{% if es_edicion %}Editar Usuario{% else %}Agregar Usuario{% endif %}</span>
            </h4>
          </div>
          <div class="card-body px-4 py-4">
            {% if mensaje %}
              <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>{{ mensaje }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endif %}
            
            {% if form.non_field_errors %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                {% for error in form.non_field_errors %}
                  {{ error }}{% if not forloop.last %}<br>{% endif %}
                {% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endif %}
            
            {% if not es_edicion %}
            <form id="tipoUsuarioForm" method="get" class="mb-4" action="{% url 'agregar' %}">
              <div class="row align-items-center">
                <div class="col-md-6">
                  <label for="tipo" class="form-label fw-bold text-dark">Tipo de usuario:</label>
                  <select name="tipo" id="tipo" class="form-select" style="border-radius: 8px;">
                    <option value="estudiante" {% if tipo == 'estudiante' %}selected{% endif %}>Alumno</option>
                    <option value="profesor" {% if tipo == 'profesor' %}selected{% endif %}>Profesor</option>
                    <option value="apoderado" {% if tipo == 'apoderado' %}selected{% endif %}>Apoderado</option>
                    <option value="director" {% if tipo == 'director' %}selected{% endif %}>Director</option>
                  </select>
                </div>
              </div>
            </form>
            {% endif %}

            <form id="registroForm" method="post" autocomplete="off">
              {% csrf_token %}
              {% if tipo == 'profesor' %}
                <!-- Campos para profesor -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.primer_nombre.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.primer_nombre.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.primer_nombre|add_class:"form-control" }}
                      {% if form.primer_nombre.errors %}
                        <div class="text-danger">{{ form.primer_nombre.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.segundo_nombre.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.segundo_nombre.label }}
                      </label>
                      {{ form.segundo_nombre|add_class:"form-control" }}
                      {% if form.segundo_nombre.errors %}
                        <div class="text-danger">{{ form.segundo_nombre.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.apellido_paterno.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.apellido_paterno.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.apellido_paterno|add_class:"form-control" }}
                      {% if form.apellido_paterno.errors %}
                        <div class="text-danger">{{ form.apellido_paterno.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.apellido_materno.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.apellido_materno.label }}
                      </label>
                      {{ form.apellido_materno|add_class:"form-control" }}
                      {% if form.apellido_materno.errors %}
                        <div class="text-danger">{{ form.apellido_materno.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="{{ form.tipo_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card"></i> {{ form.tipo_documento.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.tipo_documento|add_class:"form-control" }}
                      {% if form.tipo_documento.errors %}
                        <div class="text-danger">{{ form.tipo_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card-alt"></i> {{ form.numero_documento.label }} <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        {{ form.numero_documento|add_class:"form-control" }}
                        <div class="input-group-append">
                          <span class="input-group-text">
                            <i class="fa fa-check-circle text-success d-none" id="rut-valid"></i>
                            <i class="fa fa-times-circle text-danger d-none" id="rut-invalid"></i>
                          </span>
                        </div>
                      </div>
                      <small class="form-text text-muted">Formato: 12345678-9</small>
                      {% if form.numero_documento.errors %}
                        <div class="text-danger">{{ form.numero_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">
                        <i class="fa fa-calendar"></i> {{ form.fecha_nacimiento.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.fecha_nacimiento|add_class:"form-control" }}
                      <small class="form-text text-muted">
                        Edad calculada: <span id="edad-calculada" class="fw-bold"></span>
                      </small>
                      {% if form.fecha_nacimiento.errors %}
                        <div class="text-danger">{{ form.fecha_nacimiento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.genero.id_for_label }}" class="form-label">
                        <i class="fa fa-venus-mars"></i> {{ form.genero.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.genero|add_class:"form-control" }}
                      {% if form.genero.errors %}
                        <div class="text-danger">{{ form.genero.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.email.id_for_label }}" class="form-label">
                        <i class="fa fa-envelope"></i> {{ form.email.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.email|add_class:"form-control" }}
                      {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.telefono.id_for_label }}" class="form-label">
                        <i class="fa fa-phone"></i> {{ form.telefono.label }}
                      </label>
                      {{ form.telefono|add_class:"form-control" }}
                      {% if form.telefono.errors %}
                        <div class="text-danger">{{ form.telefono.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="{{ form.direccion.id_for_label }}" class="form-label">
                        <i class="fa fa-map-marker-alt"></i> {{ form.direccion.label }}
                      </label>
                      {{ form.direccion|add_class:"form-control" }}
                      {% if form.direccion.errors %}
                        <div class="text-danger">{{ form.direccion.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.codigo_profesor.id_for_label }}" class="form-label">
                        <i class="fa fa-id-badge"></i> {{ form.codigo_profesor.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.codigo_profesor|add_class:"form-control" }}
                      {% if form.codigo_profesor.errors %}
                        <div class="text-danger">{{ form.codigo_profesor.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.especialidad.id_for_label }}" class="form-label">
                        <i class="fa fa-graduation-cap"></i> {{ form.especialidad.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.especialidad|add_class:"form-control" }}
                      {% if form.especialidad.errors %}
                        <div class="text-danger">{{ form.especialidad.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.username.id_for_label }}" class="form-label">
                        <i class="fa fa-user-circle"></i> {{ form.username.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.username|add_class:"form-control" }}
                      {% if form.username.errors %}
                        <div class="text-danger">{{ form.username.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.password.id_for_label }}" class="form-label">
                        <i class="fa fa-lock"></i> {{ form.password.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.password|add_class:"form-control" }}
                      {% if form.password.errors %}
                        <div class="text-danger">{{ form.password.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% elif tipo == 'apoderado' %}
                <!-- Campos para apoderado -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.primer_nombre.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.primer_nombre.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.primer_nombre|add_class:"form-control" }}
                      {% if form.primer_nombre.errors %}
                        <div class="text-danger">{{ form.primer_nombre.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.segundo_nombre.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.segundo_nombre.label }}
                      </label>
                      {{ form.segundo_nombre|add_class:"form-control" }}
                      {% if form.segundo_nombre.errors %}
                        <div class="text-danger">{{ form.segundo_nombre.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.apellido_paterno.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.apellido_paterno.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.apellido_paterno|add_class:"form-control" }}
                      {% if form.apellido_paterno.errors %}
                        <div class="text-danger">{{ form.apellido_paterno.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.apellido_materno.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.apellido_materno.label }}
                      </label>
                      {{ form.apellido_materno|add_class:"form-control" }}
                      {% if form.apellido_materno.errors %}
                        <div class="text-danger">{{ form.apellido_materno.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="{{ form.tipo_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card"></i> {{ form.tipo_documento.label }}
                      </label>
                      {{ form.tipo_documento|add_class:"form-control" }}
                      {% if form.tipo_documento.errors %}
                        <div class="text-danger">{{ form.tipo_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card-alt"></i> {{ form.numero_documento.label }} <span class="text-danger">*</span>
                        <i id="rut-valid" class="fa fa-check-circle text-success d-none"></i>
                        <i id="rut-invalid" class="fa fa-times-circle text-danger d-none"></i>
                      </label>
                      {{ form.numero_documento|add_class:"form-control" }}
                      {% if form.numero_documento.errors %}
                        <div class="text-danger">{{ form.numero_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">
                        <i class="fa fa-calendar-alt"></i> {{ form.fecha_nacimiento.label }} <span class="text-danger">*</span>
                        <span id="edad-calculada" class="fw-bold text-success"></span>
                      </label>
                      {{ form.fecha_nacimiento|add_class:"form-control" }}
                      {% if form.fecha_nacimiento.errors %}
                        <div class="text-danger">{{ form.fecha_nacimiento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.genero.id_for_label }}" class="form-label">
                        <i class="fa fa-venus-mars"></i> {{ form.genero.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.genero|add_class:"form-control" }}
                      {% if form.genero.errors %}
                        <div class="text-danger">{{ form.genero.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.email.id_for_label }}" class="form-label">
                        <i class="fa fa-envelope"></i> {{ form.email.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.email|add_class:"form-control" }}
                      {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.telefono.id_for_label }}" class="form-label">
                        <i class="fa fa-phone"></i> {{ form.telefono.label }}
                      </label>
                      {{ form.telefono|add_class:"form-control" }}
                      {% if form.telefono.errors %}
                        <div class="text-danger">{{ form.telefono.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="{{ form.direccion.id_for_label }}" class="form-label">
                        <i class="fa fa-map-marker-alt"></i> {{ form.direccion.label }}
                      </label>
                      {{ form.direccion|add_class:"form-control" }}
                      {% if form.direccion.errors %}
                        <div class="text-danger">{{ form.direccion.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.codigo_apoderado.id_for_label }}" class="form-label">
                        <i class="fa fa-id-badge"></i> {{ form.codigo_apoderado.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.codigo_apoderado|add_class:"form-control" }}
                      {% if form.codigo_apoderado.errors %}
                        <div class="text-danger">{{ form.codigo_apoderado.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.parentesco_principal.id_for_label }}" class="form-label">
                        <i class="fa fa-users"></i> {{ form.parentesco_principal.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.parentesco_principal|add_class:"form-control" }}
                      {% if form.parentesco_principal.errors %}
                        <div class="text-danger">{{ form.parentesco_principal.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.ocupacion.id_for_label }}" class="form-label">
                        <i class="fa fa-briefcase"></i> {{ form.ocupacion.label }}
                      </label>
                      {{ form.ocupacion|add_class:"form-control" }}
                      {% if form.ocupacion.errors %}
                        <div class="text-danger">{{ form.ocupacion.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.telefono_emergencia.id_for_label }}" class="form-label">
                        <i class="fa fa-phone-alt"></i> {{ form.telefono_emergencia.label }}
                      </label>
                      {{ form.telefono_emergencia|add_class:"form-control" }}
                      {% if form.telefono_emergencia.errors %}
                        <div class="text-danger">{{ form.telefono_emergencia.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="{{ form.estudiantes.id_for_label }}" class="form-label">
                        <i class="fa fa-graduation-cap"></i> {{ form.estudiantes.label }}
                      </label>
                      {{ form.estudiantes|add_class:"form-select" }}
                      {% if form.estudiantes.errors %}
                        <div class="text-danger">{{ form.estudiantes.errors }}</div>
                      {% endif %}
                      <small class="form-text text-muted">{{ form.estudiantes.help_text }}</small>
                    </div>
                  </div>
                </div>
                {% if not es_edicion %}
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.username.id_for_label }}" class="form-label">
                        <i class="fa fa-user-circle"></i> {{ form.username.label }}
                      </label>
                      {{ form.username|add_class:"form-control" }}
                      {% if form.username.errors %}
                        <div class="text-danger">{{ form.username.errors }}</div>
                      {% endif %}
                      <small class="form-text text-muted">{{ form.username.help_text }}</small>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.password.id_for_label }}" class="form-label">
                        <i class="fa fa-lock"></i> {{ form.password.label }}
                      </label>
                      {{ form.password|add_class:"form-control" }}
                      {% if form.password.errors %}
                        <div class="text-danger">{{ form.password.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}
              {% elif tipo == 'director' %}
                <!-- Campos para director -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.first_name.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.first_name.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.first_name|add_class:"form-control" }}
                      {% if form.first_name.errors %}
                        <div class="text-danger">{{ form.first_name.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.last_name.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.last_name.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.last_name|add_class:"form-control" }}
                      {% if form.last_name.errors %}
                        <div class="text-danger">{{ form.last_name.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <!-- Campos de RUT para director -->
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="{{ form.tipo_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card"></i> {{ form.tipo_documento.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.tipo_documento|add_class:"form-control" }}
                      {% if form.tipo_documento.errors %}
                        <div class="text-danger">{{ form.tipo_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card-alt"></i> {{ form.numero_documento.label }} <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        {{ form.numero_documento|add_class:"form-control" }}
                        <div class="input-group-append">
                          <span class="input-group-text">
                            <i class="fa fa-check-circle text-success d-none" id="rut-valid"></i>
                            <i class="fa fa-times-circle text-danger d-none" id="rut-invalid"></i>
                          </span>
                        </div>
                      </div>
                      <small class="form-text text-muted">Formato: 12345678-9 (máximo 12 caracteres)</small>
                      {% if form.numero_documento.errors %}
                        <div class="text-danger">{{ form.numero_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <!-- Campos adicionales para director -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">
                        <i class="fa fa-calendar"></i> {{ form.fecha_nacimiento.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.fecha_nacimiento|add_class:"form-control" }}
                      <small class="form-text text-muted">
                        Edad calculada: <span id="edad-calculada" class="fw-bold"></span>
                      </small>
                      {% if form.fecha_nacimiento.errors %}
                        <div class="text-danger">{{ form.fecha_nacimiento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.genero.id_for_label }}" class="form-label">
                        <i class="fa fa-venus-mars"></i> {{ form.genero.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.genero|add_class:"form-control" }}
                      {% if form.genero.errors %}
                        <div class="text-danger">{{ form.genero.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.email.id_for_label }}" class="form-label">
                        <i class="fa fa-envelope"></i> {{ form.email.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.email|add_class:"form-control" }}
                      {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.telefono.id_for_label }}" class="form-label">
                        <i class="fa fa-phone"></i> {{ form.telefono.label }}
                      </label>
                      {{ form.telefono|add_class:"form-control" }}
                      {% if form.telefono.errors %}
                        <div class="text-danger">{{ form.telefono.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="{{ form.direccion.id_for_label }}" class="form-label">
                        <i class="fa fa-map-marker-alt"></i> {{ form.direccion.label }}
                      </label>
                      {{ form.direccion|add_class:"form-control" }}
                      {% if form.direccion.errors %}
                        <div class="text-danger">{{ form.direccion.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <!-- Campos específicos del director -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.cargo.id_for_label }}" class="form-label">
                        <i class="fa fa-id-badge"></i> {{ form.cargo.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.cargo|add_class:"form-control" }}
                      {% if form.cargo.errors %}
                        <div class="text-danger">{{ form.cargo.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.fecha_ingreso.id_for_label }}" class="form-label">
                        <i class="fa fa-calendar"></i> {{ form.fecha_ingreso.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.fecha_ingreso|add_class:"form-control" }}
                      {% if form.fecha_ingreso.errors %}
                        <div class="text-danger">{{ form.fecha_ingreso.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <!-- Campos de usuario para director -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.username.id_for_label }}" class="form-label">
                        <i class="fa fa-user-circle"></i> {{ form.username.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.username|add_class:"form-control" }}
                      {% if form.username.errors %}
                        <div class="text-danger">{{ form.username.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.password.id_for_label }}" class="form-label">
                        <i class="fa fa-lock"></i> {{ form.password.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.password|add_class:"form-control" }}
                      {% if form.password.errors %}
                        <div class="text-danger">{{ form.password.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.password_confirm.id_for_label }}" class="form-label">
                        <i class="fa fa-lock"></i> {{ form.password_confirm.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.password_confirm|add_class:"form-control" }}
                      {% if form.password_confirm.errors %}
                        <div class="text-danger">{{ form.password_confirm.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% else %}
                <!-- Campos para alumno -->
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.primer_nombre.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.primer_nombre.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.primer_nombre|add_class:"form-control" }}
                      {% if form.primer_nombre.errors %}
                        <div class="text-danger">{{ form.primer_nombre.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.segundo_nombre.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.segundo_nombre.label }}
                      </label>
                      {{ form.segundo_nombre|add_class:"form-control" }}
                      {% if form.segundo_nombre.errors %}
                        <div class="text-danger">{{ form.segundo_nombre.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.apellido_paterno.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.apellido_paterno.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.apellido_paterno|add_class:"form-control" }}
                      {% if form.apellido_paterno.errors %}
                        <div class="text-danger">{{ form.apellido_paterno.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.apellido_materno.id_for_label }}" class="form-label">
                        <i class="fa fa-user"></i> {{ form.apellido_materno.label }}
                      </label>
                      {{ form.apellido_materno|add_class:"form-control" }}
                      {% if form.apellido_materno.errors %}
                        <div class="text-danger">{{ form.apellido_materno.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-4">
                    <div class="mb-3">
                      <label for="{{ form.tipo_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card"></i> {{ form.tipo_documento.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.tipo_documento|add_class:"form-control" }}
                      {% if form.tipo_documento.errors %}
                        <div class="text-danger">{{ form.tipo_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-8">
                    <div class="mb-3">
                      <label for="{{ form.numero_documento.id_for_label }}" class="form-label">
                        <i class="fa fa-id-card-alt"></i> {{ form.numero_documento.label }} <span class="text-danger">*</span>
                      </label>
                      <div class="input-group">
                        {{ form.numero_documento|add_class:"form-control" }}
                        <div class="input-group-append">
                          <span class="input-group-text">
                            <i class="fa fa-check-circle text-success d-none" id="rut-valid"></i>
                            <i class="fa fa-times-circle text-danger d-none" id="rut-invalid"></i>
                          </span>
                        </div>
                      </div>
                      <small class="form-text text-muted">Formato: 12345678-9</small>
                      {% if form.numero_documento.errors %}
                        <div class="text-danger">{{ form.numero_documento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.fecha_nacimiento.id_for_label }}" class="form-label">
                        <i class="fa fa-calendar"></i> {{ form.fecha_nacimiento.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.fecha_nacimiento|add_class:"form-control" }}
                      <small class="form-text text-muted">
                        Edad calculada: <span id="edad-calculada" class="fw-bold"></span>
                      </small>
                      {% if form.fecha_nacimiento.errors %}
                        <div class="text-danger">{{ form.fecha_nacimiento.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.genero.id_for_label }}" class="form-label">
                        <i class="fa fa-venus-mars"></i> {{ form.genero.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.genero|add_class:"form-control" }}
                      {% if form.genero.errors %}
                        <div class="text-danger">{{ form.genero.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.email.id_for_label }}" class="form-label">
                        <i class="fa fa-envelope"></i> {{ form.email.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.email|add_class:"form-control" }}
                      {% if form.email.errors %}
                        <div class="text-danger">{{ form.email.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.telefono.id_for_label }}" class="form-label">
                        <i class="fa fa-phone"></i> {{ form.telefono.label }}
                      </label>
                      {{ form.telefono|add_class:"form-control" }}
                      {% if form.telefono.errors %}
                        <div class="text-danger">{{ form.telefono.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <div class="mb-3">
                      <label for="{{ form.direccion.id_for_label }}" class="form-label">
                        <i class="fa fa-map-marker-alt"></i> {{ form.direccion.label }}
                      </label>
                      {{ form.direccion|add_class:"form-control" }}
                      {% if form.direccion.errors %}
                        <div class="text-danger">{{ form.direccion.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.codigo_estudiante.id_for_label }}" class="form-label">
                        <i class="fa fa-graduation-cap"></i> {{ form.codigo_estudiante.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.codigo_estudiante|add_class:"form-control" }}
                      {% if form.codigo_estudiante.errors %}
                        <div class="text-danger">{{ form.codigo_estudiante.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.username.id_for_label }}" class="form-label">
                        <i class="fa fa-user-circle"></i> {{ form.username.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.username|add_class:"form-control" }}
                      {% if form.username.errors %}
                        <div class="text-danger">{{ form.username.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="{{ form.password.id_for_label }}" class="form-label">
                        <i class="fa fa-lock"></i> {{ form.password.label }} <span class="text-danger">*</span>
                      </label>
                      {{ form.password|add_class:"form-control" }}
                      {% if form.password.errors %}
                        <div class="text-danger">{{ form.password.errors }}</div>
                      {% endif %}
                    </div>
                  </div>
                </div>
              {% endif %}
              <!-- Botones de acción -->
              <div class="row mt-4">
                <div class="col-md-12 text-center">
                  <button type="submit" class="btn btn-gradient btn-lg px-5 shadow-sm">
                    <i class="fas fa-save me-2"></i> 
                    {% if es_edicion %}
                      {% if tipo == 'profesor' %}
                        Actualizar Profesor
                      {% elif tipo == 'apoderado' %}
                        Actualizar Apoderado
                      {% elif tipo == 'director' %}
                        Actualizar Director
                      {% else %}
                        Actualizar Estudiante
                      {% endif %}
                    {% else %}
                      {% if tipo == 'profesor' %}
                        Guardar Profesor
                      {% elif tipo == 'apoderado' %}
                        Guardar Apoderado
                      {% elif tipo == 'director' %}
                        Guardar Director
                      {% else %}
                        Guardar Estudiante
                      {% endif %}
                    {% endif %}
                  </button>
                  {% if not es_edicion %}
                  <button type="button" class="btn btn-outline-light btn-lg ml-2 px-5" style="background: #f5f7fa; color: #6a5af9; border: 2px solid #6a5af9;" onclick="limpiarFormulario()">
                    <i class="fas fa-eraser me-2"></i> Limpiar
                  </button>
                  {% endif %}
                  <a href="{% if tipo == 'apoderado' %}{% url 'listar_apoderados' %}{% elif tipo == 'profesor' %}{% url 'listar_profesores' %}{% elif tipo == 'director' %}{% url 'inicio' %}{% else %}{% url 'listar_estudiantes' %}{% endif %}" class="btn btn-outline-secondary btn-lg ml-2 px-5">
                    <i class="fas fa-arrow-left me-2"></i> Volver
                  </a>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Estilos adicionales -->
<style>
  .bg-gradient-header {
    background: linear-gradient(90deg, #3a8dde 0%, #6a5af9 100%) !important;
    color: #fff !important;
  }
  .btn-gradient {
    background: linear-gradient(90deg, #3a8dde 0%, #6a5af9 100%);
    color: #fff;
    border: none;
    border-radius: 25px;
    font-weight: 600;
    transition: all 0.3s;
    box-shadow: 0 2px 8px rgba(58,141,222,0.12);
  }
  .btn-gradient:hover {
    background: linear-gradient(90deg, #6a5af9 0%, #3a8dde 100%);
    color: #fff;
    transform: translateY(-2px) scale(1.03);
    box-shadow: 0 6px 18px rgba(106,90,249,0.15);
  }
  .card {
    border-radius: 22px;
    border: none;
    box-shadow: 0 4px 24px rgba(58,141,222,0.10);
    margin-bottom: 20px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 32px rgba(106,90,249,0.10);
  }
  .form-label {
    font-weight: 600;
    color: #3a3a3a;
    margin-bottom: 8px;
    letter-spacing: 0.01em;
  }
  .form-control {
    border-radius: 8px;
    border: 2px solid #e1e5e9;
    transition: all 0.3s;
    font-size: 1.05rem;
    background: #f8fafd;
  }
  .form-control:focus {
    border-color: #6a5af9;
    box-shadow: 0 0 0 0.2rem rgba(106,90,249,0.10);
    background: #fff;
  }
  .input-group-text {
    background-color: #f8f9fa;
    border: 2px solid #e1e5e9;
    border-left: none;
  }
  .text-danger {
    font-size: 0.95rem;
    margin-top: 0.25rem;
  }
  #edad-calculada {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 12px;
    background-color: rgba(106,90,249,0.08);
    color: #6a5af9;
  }
  @media (max-width: 768px) {
    .col-md-6 {
      margin-bottom: 20px;
    }
    .btn-group .btn {
      margin-bottom: 10px;
    }
    .card-header {
      padding: 1.2rem 1rem !important;
    }
  }
</style>

<!-- JavaScript mejorado -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('registroForm');
  const rutField = document.querySelector('input[name="numero_documento"]');
  const fechaField = document.querySelector('input[name="fecha_nacimiento"]');
  const edadSpan = document.getElementById('edad-calculada');
  const tipoUsuario = '{{ tipo }}';

  // Formatear RUT en tiempo real
  if (rutField) {
    rutField.addEventListener('input', function() {
      let valor = this.value.replace(/[^0-9kK]/g, ''); // Solo números y K
      
      // Limitar a 9 caracteres máximo (8 dígitos + 1 DV)
      if (valor.length > 9) {
        valor = valor.slice(0, 9);
      }
      
      if (valor.length > 1) {
        // Separar número y dígito verificador
        let numero = valor.slice(0, -1);
        let dv = valor.slice(-1).toUpperCase();
        
        // Formatear el número con puntos según su longitud
        let numeroFormateado = '';
        if (numero.length <= 3) {
          numeroFormateado = numero;
        } else if (numero.length <= 6) {
          numeroFormateado = numero.slice(0, -3) + '.' + numero.slice(-3);
        } else {
          // Para números de 7 u 8 dígitos
          if (numero.length === 7) {
            numeroFormateado = numero.slice(0, 1) + '.' + numero.slice(1, 4) + '.' + numero.slice(4);
          } else if (numero.length === 8) {
            numeroFormateado = numero.slice(0, 2) + '.' + numero.slice(2, 5) + '.' + numero.slice(5);
          } else {
            numeroFormateado = numero;
          }
        }
        
        this.value = numeroFormateado + '-' + dv;
      } else {
        this.value = valor;
      }
      
      validarRUT(this);
    });
    
    // También validar cuando se pegue contenido
    rutField.addEventListener('paste', function(e) {
      setTimeout(() => {
        this.dispatchEvent(new Event('input'));
      }, 10);
    });
  }

  // Calcular edad en tiempo real (para todos los tipos de usuario que tengan fecha de nacimiento)
  if (fechaField) {
    // Calcular edad inicial si hay fecha (para modo edición)
    if (fechaField.value) {
      const fecha = new Date(fechaField.value);
      const hoy = new Date();
      let edad = hoy.getFullYear() - fecha.getFullYear();
      const mes = hoy.getMonth() - fecha.getMonth();
      
      if (mes < 0 || (mes === 0 && hoy.getDate() < fecha.getDate())) {
        edad--;
      }
      
      if (edad >= 0 && edadSpan) {
        edadSpan.textContent = edad + ' años';
        edadSpan.className = 'fw-bold text-success';
      }
    }
    
    fechaField.addEventListener('change', function() {
      const fecha = new Date(this.value);
      const hoy = new Date();
      let edad = hoy.getFullYear() - fecha.getFullYear();
      const mes = hoy.getMonth() - fecha.getMonth();
      
      if (mes < 0 || (mes === 0 && hoy.getDate() < fecha.getDate())) {
        edad--;
      }
      
      if (edadSpan) {
        if (edad >= 0) {
          edadSpan.textContent = edad + ' años';
          edadSpan.className = 'fw-bold text-success';
        } else {
          edadSpan.textContent = 'Fecha inválida';
          edadSpan.className = 'fw-bold text-danger';
        }
      }
    });
  }

  // Validación en tiempo real para todos los campos
  const requiredFields = form.querySelectorAll('input[required], select[required]');
  requiredFields.forEach(field => {
    field.addEventListener('blur', function() {
      validateField(this);
    });
    
    field.addEventListener('input', function() {
      if (this.classList.contains('is-invalid')) {
        validateField(this);
      }
    });
  });

  // Validación del formulario al enviar
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    let isValid = true;
    requiredFields.forEach(field => {
      if (!validateField(field)) {
        isValid = false;
      }
    });
    
    if (isValid) {
      // Mostrar loading
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.innerHTML;
      const esEdicion = {{ es_edicion|yesno:"true,false" }};
      submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-1"></i> ' + (esEdicion ? 'Actualizando...' : 'Registrando...');
      submitBtn.disabled = true;
      
      // Enviar formulario
      setTimeout(() => {
        form.submit();
      }, 500);
    } else {
      // Scroll al primer error
      const firstError = form.querySelector('.is-invalid');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  });
});

function validateField(field) {
  const value = field.value.trim();
  
  if (field.hasAttribute('required') && !value) {
    field.classList.add('is-invalid');
    field.classList.remove('is-valid');
    return false;
  }
  
  // Validaciones específicas
  if (field.type === 'email' && value) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(value)) {
      field.classList.add('is-invalid');
      field.classList.remove('is-valid');
      return false;
    }
  }
  
  field.classList.remove('is-invalid');
  if (value) field.classList.add('is-valid');
  return true;
}

function validarRUT(field) {
  const valor = field.value.trim();
  const validIcon = document.getElementById('rut-valid');
  const invalidIcon = document.getElementById('rut-invalid');
  
  // Ocultar íconos inicialmente
  if (validIcon) validIcon.classList.add('d-none');
  if (invalidIcon) invalidIcon.classList.add('d-none');
  
  // Si está vacío o muy corto, no mostrar error aún
  if (valor.length < 3) {
    field.classList.remove('is-valid', 'is-invalid');
    return false;
  }
  
  // Limpiar RUT: remover puntos, guiones y espacios
  const rut = valor.replace(/[^0-9kK]/g, '');
  
  // Debe tener entre 8 y 9 caracteres (7-8 dígitos + DV)
  if (rut.length < 8 || rut.length > 9) {
    field.classList.add('is-invalid');
    field.classList.remove('is-valid');
    if (invalidIcon) invalidIcon.classList.remove('d-none');
    return false;
  }
  
  const numero = rut.slice(0, -1);
  const dv = rut.slice(-1).toUpperCase();
  
  // Validar que el número sea numérico y tenga entre 7 y 8 dígitos
  if (!/^\d{7,8}$/.test(numero)) {
    field.classList.add('is-invalid');
    field.classList.remove('is-valid');
    if (invalidIcon) invalidIcon.classList.remove('d-none');
    return false;
  }
  
  // Validar dígito verificador
  if (!/^[0-9K]$/.test(dv)) {
    field.classList.add('is-invalid');
    field.classList.remove('is-valid');
    if (invalidIcon) invalidIcon.classList.remove('d-none');
    return false;
  }
  
  // Calcular dígito verificador usando el algoritmo estándar
  let suma = 0;
  let multiplicador = 2;
  
  // Recorrer de derecha a izquierda
  for (let i = numero.length - 1; i >= 0; i--) {
    suma += parseInt(numero[i]) * multiplicador;
    multiplicador++;
    if (multiplicador > 7) {
      multiplicador = 2;
    }
  }
  
  const resto = suma % 11;
  const dvCalculado = resto === 1 ? 'K' : resto === 0 ? '0' : (11 - resto).toString();
  
  if (dv === dvCalculado) {
    field.classList.add('is-valid');
    field.classList.remove('is-invalid');
    if (validIcon) validIcon.classList.remove('d-none');
    return true;
  } else {
    field.classList.add('is-invalid');
    field.classList.remove('is-valid');
    if (invalidIcon) invalidIcon.classList.remove('d-none');
    return false;
  }
}

function limpiarFormulario() {
  if (confirm('¿Está seguro de que desea limpiar todos los campos?')) {
    document.getElementById('registroForm').reset();
    // Remover clases de validación
    document.querySelectorAll('.is-valid, .is-invalid').forEach(el => {
      el.classList.remove('is-valid', 'is-invalid');
    });
    const edadSpan = document.getElementById('edad-calculada');
    if (edadSpan) {
      edadSpan.textContent = '';
    }
  }
}

// Función para manejar el cambio de tipo de usuario
document.addEventListener('DOMContentLoaded', function() {
  const tipoSelect = document.getElementById('tipo');
  if (tipoSelect) {
    tipoSelect.addEventListener('change', function() {
      // Mostrar mensaje de confirmación si hay datos en el formulario
      const form = document.getElementById('registroForm');
      const formData = new FormData(form);
      let hasData = false;
      
      for (let [key, value] of formData.entries()) {
        if (value && value.trim() !== '') {
          hasData = true;
          break;
        }
      }
      
      if (hasData) {
        if (!confirm('Al cambiar el tipo de usuario se perderán los datos ingresados. ¿Desea continuar?')) {
          // Restaurar selección anterior
          this.selectedIndex = this.selectedIndex === 0 ? 1 : 0;
          return false;
        }
      }
      
      // Proceder con el cambio
      this.form.submit();
    });
  }
});
</script>
{% endblock %}
